<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>NÉO-GAZ | Terminal de Contrôle</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@200;300;400;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                        mono: ['JetBrains Mono', 'ui-monospace', 'monospace'],
                    },
                    colors: {
                        cyber: {
                            bg: '#05070a',
                            card: '#0f1219',
                            border: '#1e293b',
                            primary: '#06b6d4',
                            secondary: '#8b5cf6',
                            text: '#94a3b8'
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'spin-slow': 'spin 3s linear infinite',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #05070a;
            background-image: radial-gradient(circle at 50% 0%, #172033 0%, #05070a 80%);
            color: #e2e8f0;
            overflow-x: hidden;
            height: 100dvh;
        }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #05070a; }
        ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #06b6d4; }

        .glass-panel {
            background: rgba(15, 18, 25, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(6, 182, 212, 0.15);
            box-shadow: 0 0 15px rgba(6, 182, 212, 0.05);
        }

        .ai-panel {
            background: rgba(20, 10, 25, 0.95);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(217, 70, 239, 0.3);
            box-shadow: 0 0 30px rgba(217, 70, 239, 0.15);
        }

        .hud-input {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(6, 182, 212, 0.3);
            color: #fff;
            transition: all 0.3s ease;
        }
        .hud-input:focus {
            outline: none;
            border-color: #06b6d4;
            box-shadow: 0 0 15px rgba(6, 182, 212, 0.3);
        }

        /* Markdown Styles for AI */
        .prose-ai h3 { color: #d946ef; font-weight: bold; margin-top: 1em; margin-bottom: 0.5em; font-size: 0.95rem; text-transform: uppercase; letter-spacing: 0.05em; }
        .prose-ai ul { list-style-type: none; padding-left: 0; margin-bottom: 1em; }
        .prose-ai li { margin-bottom: 0.5em; padding-left: 1.2em; position: relative; color: #cbd5e1; font-size: 0.9rem; }
        .prose-ai li::before { content: "›"; color: #d946ef; position: absolute; left: 0; font-weight: bold; }
        .prose-ai strong { color: #fff; font-weight: 700; }
        .prose-ai p { margin-bottom: 0.8em; line-height: 1.6; font-size: 0.9rem; }
    </style>
</head>
<body class="flex h-[100dvh] overflow-hidden selection:bg-cyan-500 selection:text-black font-sans">

    <aside id="mainSidebar" class="hidden md:flex w-64 flex-col border-r border-cyber-border bg-cyber-bg/95 backdrop-blur z-20 relative transition-all duration-300">
        <div class="h-16 flex items-center justify-start px-6 border-b border-cyber-border">
            <div class="w-8 h-8 rounded bg-cyan-500/10 border border-cyan-500/50 flex items-center justify-center shadow-[0_0_10px_rgba(6,182,212,0.5)] shrink-0">
                <i data-lucide="flame" class="w-5 h-5 text-cyan-400"></i>
            </div>
            <span class="ml-3 font-bold tracking-widest text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-500 sidebar-text whitespace-nowrap overflow-hidden">
                NÉO-GAZ
            </span>
        </div>

        <nav class="flex-1 py-6 space-y-2 px-2 overflow-hidden">
            <button onclick="openModule()" class="w-full flex items-center justify-start p-3 rounded-lg bg-cyan-500/10 border border-cyan-500/30 text-cyan-400 hover:bg-cyan-500/20 hover:shadow-[0_0_15px_rgba(6,182,212,0.3)] transition-all group whitespace-nowrap">
                <i data-lucide="plus-square" class="w-6 h-6 shrink-0"></i>
                <span class="ml-3 font-semibold sidebar-text">Saisie / Import</span>
            </button>

            <button onclick="openAI()" class="w-full flex items-center justify-start p-3 rounded-lg bg-fuchsia-500/10 border border-fuchsia-500/30 text-fuchsia-400 hover:bg-fuchsia-500/20 hover:shadow-[0_0_15px_rgba(217,70,239,0.3)] transition-all group whitespace-nowrap mt-2">
                <i data-lucide="sparkles" class="w-6 h-6 shrink-0"></i>
                <span class="ml-3 font-semibold sidebar-text">ANALYSE IA ✨</span>
            </button>
            
            <div class="h-px bg-cyber-border my-4 mx-2"></div>

            <div id="sidebarLegend" class="px-4 py-2 sidebar-text">
                <h3 class="text-xs font-semibold text-cyber-text uppercase tracking-wider mb-3">Légende</h3>
                <div class="space-y-3">
                    <div class="flex items-center gap-3"><div class="w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.8)]"></div><span class="text-xs text-gray-400">Réel</span></div>
                    <div class="flex items-center gap-3"><div class="w-2 h-2 rounded-full bg-cyan-500 shadow-[0_0_8px_rgba(6,182,212,0.8)]"></div><span class="text-xs text-gray-400">Estimé</span></div>
                    <div class="flex items-center gap-3 pt-2 border-t border-gray-800"><div class="w-4 h-0.5 bg-orange-500 shadow-[0_0_8px_rgba(249,115,22,0.8)]"></div><span class="text-xs text-gray-400">Température</span></div>
                </div>
            </div>
        </nav>

        <button onclick="toggleSidebar()" class="absolute bottom-4 right-[-12px] md:static md:w-full md:p-4 flex justify-end md:justify-center text-gray-500 hover:text-cyan-400 transition-colors focus:outline-none">
            <i id="collapseIcon" data-lucide="chevrons-left" class="w-5 h-5"></i>
        </button>
    </aside>

    <main class="flex-1 flex flex-col h-full overflow-hidden relative">
        <header class="h-auto md:h-16 py-2 border-b border-cyber-border bg-cyber-bg/80 backdrop-blur flex flex-wrap items-center justify-between px-4 md:px-8 z-10 gap-2 shrink-0">
            <div class="md:hidden flex items-center gap-2">
                 <div class="w-8 h-8 rounded bg-cyan-500/10 border border-cyan-500/50 flex items-center justify-center">
                    <i data-lucide="flame" class="w-4 h-4 text-cyan-400"></i>
                </div>
                 <h1 class="text-lg font-bold text-gray-200">NÉO-GAZ</h1>
            </div>

            <div class="flex flex-wrap items-center gap-2 ml-auto">
                <div class="flex bg-cyber-card rounded-lg p-1 border border-cyber-border">
                    <button onclick="setFilter('global')" class="filter-btn" data-period="global">Global</button>
                    <button onclick="setFilter('year')" class="filter-btn" data-period="year">Année</button>
                    <button onclick="setFilter('month')" class="filter-btn active-filter" data-period="month">Mois</button>
                    <button onclick="setFilter('custom')" class="filter-btn" data-period="custom">Perso</button>
                </div>
                
                <div id="dateNavigator" class="hidden flex items-center gap-1 border border-cyber-border rounded-lg p-1 bg-cyber-card">
                     <button onclick="changePeriod(-1)" class="p-1 hover:text-cyan-400 transition-colors"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                     <span id="currentPeriodLabel" class="text-xs font-mono text-cyan-400 min-w-[80px] text-center uppercase font-bold">...</span>
                     <button onclick="changePeriod(1)" class="p-1 hover:text-cyan-400 transition-colors"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                </div>

                <div id="customRangeSelector" class="hidden flex items-center gap-2">
                    <input type="date" id="customStart" onchange="updateUI()" class="bg-cyber-card border border-cyber-border rounded px-2 py-1 text-xs text-gray-300 focus:outline-none focus:border-cyan-500 w-28">
                    <span class="text-gray-500 text-xs">-</span>
                    <input type="date" id="customEnd" onchange="updateUI()" class="bg-cyber-card border border-cyber-border rounded px-2 py-1 text-xs text-gray-300 focus:outline-none focus:border-cyan-500 w-28">
                </div>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 pb-40 md:pb-12 scroll-smooth">
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="glass-panel rounded-xl p-4 relative overflow-hidden group">
                    <div class="absolute -right-4 -top-4 opacity-10 group-hover:opacity-20 transition-opacity"><i data-lucide="zap" class="w-24 h-24 text-cyan-500"></i></div>
                    <p class="text-[10px] text-cyan-400 uppercase tracking-widest mb-1">Volume Total</p>
                    <h2 class="text-2xl md:text-3xl font-bold text-white font-mono" id="kpiKwh">0</h2>
                    <p class="text-xs text-gray-500 mt-1">Moy. <span id="kpiAvg" class="text-gray-300 font-bold">0</span> kWh/j</p>
                </div>

                <div class="glass-panel rounded-xl p-4 relative overflow-hidden group">
                    <div class="absolute -right-4 -top-4 opacity-10 group-hover:opacity-20 transition-opacity"><i data-lucide="banknote" class="w-24 h-24 text-emerald-500"></i></div>
                    <p class="text-[10px] text-emerald-400 uppercase tracking-widest mb-1">Coût Estimé</p>
                    <h2 class="text-2xl md:text-3xl font-bold text-white font-mono" id="kpiCost">0 <span class="text-sm">€</span></h2>
                    <p class="text-xs text-gray-500 mt-1">TTC (Abo. inclus)</p>
                </div>

                <div class="glass-panel rounded-xl p-4 relative overflow-hidden group">
                    <div class="absolute -right-4 -top-4 opacity-10 group-hover:opacity-20 transition-opacity"><i data-lucide="thermometer" class="w-24 h-24 text-orange-500"></i></div>
                    <p class="text-[10px] text-orange-400 uppercase tracking-widest mb-1">Temp. Moyenne</p>
                    <h2 class="text-2xl md:text-3xl font-bold text-white font-mono" id="kpiAvgTemp">--°C</h2>
                    <p class="text-xs text-gray-500 mt-1">Extérieure</p>
               </div>
               
               <div class="glass-panel rounded-xl p-4 relative overflow-hidden group border-dashed border-gray-700">
                    <p class="text-[10px] text-gray-400 uppercase tracking-widest mb-1">Fiabilité</p>
                    <h2 class="text-2xl md:text-3xl font-bold text-white font-mono" id="kpiReliability">0%</h2>
                    <div class="w-full bg-gray-800 h-1 mt-2 rounded-full overflow-hidden">
                        <div id="reliablityBar" class="h-full bg-emerald-500 transition-all duration-1000" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div class="glass-panel rounded-xl p-6 flex flex-col">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-sm font-bold text-white flex items-center gap-2 uppercase tracking-wider">
                        <i data-lucide="activity" class="w-4 h-4 text-cyan-400"></i> Flux & Météo
                    </h3>
                    <div class="flex bg-cyber-bg rounded p-0.5 border border-cyber-border">
                         <button onclick="setChartMode('kwh')" class="chart-mode-btn active-chart-mode" data-mode="kwh">kWh</button>
                         <button onclick="setChartMode('cost')" class="chart-mode-btn" data-mode="cost">€</button>
                    </div>
                </div>
                
                <div class="relative h-64 w-full group flex-1" id="chartContainer">
                    <canvas id="mainCanvas" class="w-full h-full block cursor-crosshair"></canvas>
                    <div id="canvasTooltip" class="pointer-events-none absolute top-0 left-0 hidden z-50 bg-[#0f1219]/95 border border-cyan-500/50 p-2 rounded shadow-[0_0_15px_rgba(6,182,212,0.3)] backdrop-blur-md text-xs min-w-[120px]"></div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 glass-panel rounded-xl p-6 relative">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-sm font-bold text-white flex items-center gap-2 uppercase tracking-wider">
                            <i data-lucide="layout-grid" class="w-4 h-4 text-violet-400"></i> Matrice Temporelle
                        </h3>
                    </div>
                    
                    <div class="grid grid-cols-7 gap-1 md:gap-2 mb-2">
                        <div class="text-center text-[10px] text-gray-500">L</div><div class="text-center text-[10px] text-gray-500">M</div><div class="text-center text-[10px] text-gray-500">M</div><div class="text-center text-[10px] text-gray-500">J</div><div class="text-center text-[10px] text-gray-500">V</div><div class="text-center text-[10px] text-gray-500">S</div><div class="text-center text-[10px] text-gray-500">D</div>
                    </div>
                    <div id="heatmapGrid" class="grid grid-cols-7 gap-1 md:gap-2"></div>
                </div>

                <div class="glass-panel rounded-xl p-0 overflow-hidden flex flex-col h-full max-h-[400px]">
                    <div class="p-4 border-b border-gray-800 bg-black/20">
                        <h3 class="text-sm font-bold text-white flex items-center gap-2 uppercase tracking-wider">
                            <i data-lucide="database" class="w-4 h-4 text-emerald-400"></i> Logs Index
                        </h3>
                    </div>
                    <div class="overflow-y-auto flex-1 p-2 space-y-1 custom-scroll" id="historyList"></div>
                </div>
            </div>
            
            <div class="h-10 md:hidden"></div>
        </div>
    </main>

    <button onclick="openModule()" class="md:hidden fixed bottom-6 right-6 w-14 h-14 bg-cyan-600 rounded-full flex items-center justify-center shadow-[0_0_20px_rgba(8,145,178,0.6)] z-40 hover:scale-110 transition-transform border border-cyan-400">
        <i data-lucide="plus" class="w-6 h-6 text-white"></i>
    </button>

    <div id="hudOverlay" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 transition-opacity duration-300 opacity-0">
        <div id="hudContent" class="border border-cyan-500/30 bg-[#0a0c10] w-full max-w-2xl rounded-xl shadow-[0_0_50px_rgba(6,182,212,0.15)] overflow-hidden transform scale-95 transition-transform duration-300 relative flex flex-col max-h-[95dvh]">
            <div class="p-4 md:p-6 border-b border-gray-800 text-center relative overflow-hidden shrink-0">
                <button onclick="closeModule()" class="absolute top-4 right-4 text-gray-500 hover:text-white z-10"><i data-lucide="x" class="w-6 h-6"></i></button>
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-cyan-500 to-transparent opacity-50"></div>
                <h2 class="text-lg md:text-xl font-bold text-white tracking-[0.2em] uppercase neon-text-cyan">Entrée Manuelle</h2>
            </div>
            <div class="overflow-y-auto custom-scroll flex-1">
                <div class="grid grid-cols-1 md:grid-cols-2 h-full">
                    <div class="p-4 md:p-6 space-y-4 border-b md:border-b-0 md:border-r border-gray-800">
                        <div class="space-y-2">
                            <label class="text-[10px] text-cyan-500 uppercase tracking-wider font-bold block">Date & Heure</label>
                            <div class="flex gap-2">
                                <input type="date" id="hudDate" class="hud-input w-full px-3 py-2 rounded text-center" onfocus="activeInput=null">
                                <input type="time" id="hudTime" class="hud-input w-24 px-2 py-2 rounded text-center" onfocus="activeInput=null">
                            </div>
                        </div>
                        <div class="space-y-2">
                            <label class="text-[10px] text-cyan-500 uppercase tracking-wider font-bold block">Index Compteur (m³)</label>
                            <div class="relative"><input type="number" id="hudIndex" step="0.001" placeholder="00000.0" class="hud-input w-full px-4 py-3 rounded-lg text-xl md:text-2xl font-mono text-cyan-400 tracking-widest text-center" onfocus="activeInput='hudIndex'" readonly><div class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-600 text-xs">m³</div></div>
                        </div>
                        <div class="space-y-2 pt-2 border-t border-gray-800">
                             <label class="text-[10px] text-orange-500 uppercase tracking-wider font-bold block">Météo (Optionnel)</label>
                             <div class="relative"><input type="number" id="hudTemp" placeholder="--.-" class="hud-input w-full px-4 py-2 rounded text-center text-orange-400 font-bold" onfocus="activeInput='hudTemp'" readonly><div class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-600 text-xs">°C</div></div>
                        </div>
                    </div>
                    <div class="p-4 md:p-6 bg-[#050608] flex flex-col justify-center">
                        <div class="grid grid-cols-3 gap-2">
                            <button onclick="numpadPress('1')" class="p-3 bg-gray-800/50 rounded hover:bg-cyan-900/30 text-cyan-400 font-bold text-lg">1</button>
                            <button onclick="numpadPress('2')" class="p-3 bg-gray-800/50 rounded hover:bg-cyan-900/30 text-cyan-400 font-bold text-lg">2</button>
                            <button onclick="numpadPress('3')" class="p-3 bg-gray-800/50 rounded hover:bg-cyan-900/30 text-cyan-400 font-bold text-lg">3</button>
                            <button onclick="numpadPress('4')" class="p-3 bg-gray-800/50 rounded hover:bg-cyan-900/30 text-cyan-400 font-bold text-lg">4</button>
                            <button onclick="numpadPress('5')" class="p-3 bg-gray-800/50 rounded hover:bg-cyan-900/30 text-cyan-400 font-bold text-lg">5</button>
                            <button onclick="numpadPress('6')" class="p-3 bg-gray-800/50 rounded hover:bg-cyan-900/30 text-cyan-400 font-bold text-lg">6</button>
                            <button onclick="numpadPress('7')" class="p-3 bg-gray-800/50 rounded hover:bg-cyan-900/30 text-cyan-400 font-bold text-lg">7</button>
                            <button onclick="numpadPress('8')" class="p-3 bg-gray-800/50 rounded hover:bg-cyan-900/30 text-cyan-400 font-bold text-lg">8</button>
                            <button onclick="numpadPress('9')" class="p-3 bg-gray-800/50 rounded hover:bg-cyan-900/30 text-cyan-400 font-bold text-lg">9</button>
                            <button onclick="numpadPress('.')" class="p-3 bg-gray-800/50 rounded hover:bg-cyan-900/30 text-cyan-400 font-bold text-lg">.</button>
                            <button onclick="numpadPress('0')" class="p-3 bg-gray-800/50 rounded hover:bg-cyan-900/30 text-cyan-400 font-bold text-lg">0</button>
                            <button onclick="numpadPress('DEL')" class="p-3 bg-red-900/20 border border-red-900/50 rounded text-red-400 flex items-center justify-center"><i data-lucide="delete" class="w-5 h-5"></i></button>
                            <button onclick="numpadPress('-')" class="col-span-3 py-2 bg-gray-800/30 rounded text-xs text-orange-400 uppercase font-bold tracking-wider hover:bg-orange-900/20">Signe Négatif (Temp)</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-[#0f1219] border-t border-gray-800 flex flex-col md:flex-row items-center justify-between gap-4 shrink-0">
                <div class="flex gap-2 w-full md:w-auto">
                    <button onclick="document.getElementById('fileImport').click()" class="flex-1 px-3 py-2 rounded border border-gray-700 hover:border-emerald-500 text-xs text-gray-400 hover:text-emerald-400 transition-colors flex items-center justify-center gap-1"><i data-lucide="upload" class="w-3 h-3"></i> Import</button>
                    <button onclick="exportData()" class="flex-1 px-3 py-2 rounded border border-gray-700 hover:border-violet-500 text-xs text-gray-400 hover:text-violet-400 transition-colors flex items-center justify-center gap-1"><i data-lucide="save" class="w-3 h-3"></i> Backup</button>
                    <button onclick="fetchWeatherData()" class="px-3 py-2 rounded border border-gray-700 hover:border-orange-500 text-orange-400 transition-colors" title="Sync Météo"><i data-lucide="cloud-lightning" class="w-4 h-4"></i></button>
                    <button onclick="toggleSettings()" class="px-3 py-2 rounded border border-gray-700 hover:border-gray-500 text-gray-400 transition-colors"><i data-lucide="settings" class="w-4 h-4"></i></button>
                </div>
                <button onclick="submitHudForm()" class="w-full md:w-auto px-8 py-3 bg-cyan-600 hover:bg-cyan-500 text-white font-bold tracking-wider rounded shadow-[0_0_20px_rgba(8,145,178,0.4)] transition-all">VALIDER</button>
            </div>
            <input type="file" id="fileImport" class="hidden" accept=".json,.csv">
        </div>
    </div>

    <div id="aiOverlay" class="fixed inset-0 bg-black/95 z-[70] hidden flex items-center justify-center p-4 backdrop-blur-md">
        <div class="ai-panel w-full max-w-2xl rounded-2xl shadow-2xl relative overflow-hidden flex flex-col max-h-[90dvh]">
             <div class="p-6 border-b border-fuchsia-900/50 flex justify-between items-center bg-fuchsia-950/30">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-fuchsia-500/20 flex items-center justify-center border border-fuchsia-500/50 shadow-[0_0_15px_rgba(217,70,239,0.5)]">
                        <i data-lucide="brain-circuit" class="w-6 h-6 text-fuchsia-400 animate-pulse"></i>
                    </div>
                    <div>
                        <h3 class="text-white font-bold tracking-widest text-lg">NÉO-CORTEX</h3>
                        <p class="text-[10px] text-fuchsia-300/70 uppercase tracking-wider">Analyse Énergétique Intelligente</p>
                    </div>
                </div>
                <button onclick="closeAI()" class="text-fuchsia-400 hover:text-white transition-colors"><i data-lucide="x" class="w-6 h-6"></i></button>
             </div>
             <div id="aiContent" class="p-8 overflow-y-auto custom-scroll flex-1 font-mono text-sm leading-relaxed"></div>
             <div class="p-4 border-t border-fuchsia-900/50 bg-black/40 flex justify-end">
                 <button onclick="closeAI()" class="px-6 py-2 rounded border border-fuchsia-500/30 text-fuchsia-400 hover:bg-fuchsia-500/10 transition-colors text-xs tracking-widest">FERMER LE TERMINAL</button>
             </div>
        </div>
    </div>
    
    <div id="settingsOverlay" class="fixed inset-0 bg-black/90 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="glass-panel p-6 rounded-xl w-full max-w-sm border border-gray-800 bg-[#0a0c10] shadow-2xl relative">
             <div class="flex justify-between items-center mb-6">
                <h3 class="text-white font-bold uppercase tracking-wider text-sm flex items-center gap-2"><i data-lucide="settings" class="w-4 h-4 text-cyan-400"></i> Configuration</h3>
                <button onclick="toggleSettings()" class="text-gray-500 hover:text-white transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
             </div>
             <div class="space-y-4">
                <div><label class="text-[10px] text-cyan-600 uppercase tracking-wider font-bold mb-1 block">Prix kWh HT (€)</label><input type="number" id="setPrice" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white focus:border-cyan-500 focus:outline-none transition-colors text-xs"></div>
                <div><label class="text-[10px] text-cyan-600 uppercase tracking-wider font-bold mb-1 block">Abonnement Annuel HT (€)</label><input type="number" id="setSub" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white focus:border-cyan-500 focus:outline-none transition-colors text-xs"></div>
                <div><label class="text-[10px] text-cyan-600 uppercase tracking-wider font-bold mb-1 block">Coef. Conversion</label><input type="number" id="setCoef" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white focus:border-cyan-500 focus:outline-none transition-colors text-xs"></div>
                <div class="grid grid-cols-2 gap-2">
                    <div><label class="text-[10px] text-gray-500 uppercase tracking-wider font-bold mb-1 block">Lat</label><input type="number" id="setLat" step="0.0001" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white text-xs"></div>
                    <div><label class="text-[10px] text-gray-500 uppercase tracking-wider font-bold mb-1 block">Lon</label><input type="number" id="setLon" step="0.0001" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white text-xs"></div>
                </div>
                
                <div class="mt-2 pt-2 border-t border-gray-800">
                    <label class="text-[10px] text-fuchsia-500 uppercase tracking-wider font-bold mb-1 block">Clé API Gemini (IA)</label>
                    <input type="password" id="setApiKey" placeholder="AIzaSy..." class="w-full bg-black/50 border border-fuchsia-900/50 rounded p-2 text-fuchsia-100 focus:border-fuchsia-500 focus:outline-none transition-colors text-xs font-mono">
                </div>

                <button onclick="saveSettings()" class="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 rounded shadow-[0_0_15px_rgba(8,145,178,0.4)] mt-2 transition-all tracking-wider text-sm">ENREGISTRER</button>
                <button onclick="resetData()" class="w-full py-2 rounded border border-red-900/50 text-red-500 hover:bg-red-900/20 text-xs uppercase tracking-widest mt-4">Reset Factory</button>
             </div>
        </div>
    </div>

    <script>
        const DEFAULT_SETTINGS = { kwhPrice: 0.1045, subscription: 245.50, tva: 0.20, conversionCoef: 11.2, lat: 48.8566, lon: 2.3522, apiKey: "" };
        
        let state = {
            settings: { ...DEFAULT_SETTINGS },
            readings: [], 
            importedData: {}, 
            dailyWeather: {}, 
            computedDaily: [],
            ui: { periodFilter: 'month', currentDate: new Date(), chartMode: 'kwh' }
        };
        
        let activeInput = 'hudIndex';

        // --- INIT ---
        function init() {
            if (window.lucide) lucide.createIcons();
            loadData();
            
            // Set default date to last reading or today
            if (state.readings.length > 0) {
                const last = state.readings[state.readings.length-1];
                state.ui.currentDate = new Date(last.date);
            }

            // Populate Settings
            document.getElementById('setPrice').value = state.settings.kwhPrice;
            document.getElementById('setSub').value = state.settings.subscription;
            document.getElementById('setCoef').value = state.settings.conversionCoef;
            document.getElementById('setLat').value = state.settings.lat;
            document.getElementById('setLon').value = state.settings.lon;
            document.getElementById('setApiKey').value = state.settings.apiKey || "";

            // Custom Range Default
            const today = new Date();
            const lastMonth = new Date();
            lastMonth.setDate(today.getDate() - 30);
            document.getElementById('customStart').valueAsDate = lastMonth;
            document.getElementById('customEnd').valueAsDate = today;

            // Canvas Resizer
            const resizeObserver = new ResizeObserver(() => {
                if(state.computedDaily.length > 0) renderChart(state.computedDaily);
            });
            resizeObserver.observe(document.getElementById('chartContainer'));

            recalcEngine();
        }

        function loadData() {
            const s = localStorage.getItem('gt_settings');
            const r = localStorage.getItem('gt_readings');
            const i = localStorage.getItem('gt_imports');
            const w = localStorage.getItem('gt_weather');
            if (s) state.settings = { ...DEFAULT_SETTINGS, ...JSON.parse(s) };
            if (r) state.readings = JSON.parse(r);
            if (i) state.importedData = JSON.parse(i);
            if (w) state.dailyWeather = JSON.parse(w);
        }

        function saveData() {
            localStorage.setItem('gt_settings', JSON.stringify(state.settings));
            localStorage.setItem('gt_readings', JSON.stringify(state.readings));
            localStorage.setItem('gt_imports', JSON.stringify(state.importedData));
            localStorage.setItem('gt_weather', JSON.stringify(state.dailyWeather));
        }

        function resetData() { 
            if(confirm("PROTOCOLE D'URGENCE : Effacement total ?")) { 
                localStorage.clear(); 
                location.reload(); 
            } 
        }

        // --- CALCULATION ENGINE ---
        function recalcEngine() {
            // Sort
            state.readings.sort((a, b) => new Date(a.date + 'T' + (a.time || '00:00')) - new Date(b.date + 'T' + (b.time || '00:00')));
            
            const dailyMap = new Map(); 
            if (state.readings.length < 2) { state.computedDaily = []; updateUI(); return; }

            for (let i = 0; i < state.readings.length - 1; i++) {
                const start = state.readings[i];
                const end = state.readings[i+1];
                if (new Date(start.date) > new Date(end.date)) continue;

                const totalDelta = Math.max(0, end.value - start.value);
                const loopEnd = new Date(end.date);
                
                // Same day logic
                if(start.date === end.date) {
                    const k = start.date;
                    if(!dailyMap.has(k)) dailyMap.set(k, { m3: 0, kwh: 0, type: 'real', temp: null });
                    dailyMap.get(k).m3 += totalDelta;
                    continue;
                }

                const days = [];
                let current = new Date(start.date);
                while (current < loopEnd) {
                    days.push(current.toISOString().split('T')[0]);
                    current.setDate(current.getDate() + 1);
                }

                let knownVol = 0;
                let unknownDays = 0;
                days.forEach(d => { if(state.importedData[d] !== undefined) knownVol += state.importedData[d]; else unknownDays++; });

                const remainingVol = Math.max(0, totalDelta - knownVol);
                const avg = unknownDays > 0 ? remainingVol / unknownDays : 0;

                days.forEach(d => {
                    let val = avg;
                    let type = 'estimated';
                    if(state.importedData[d] !== undefined) { val = state.importedData[d]; type = 'real'; }
                    
                    let temp = state.dailyWeather[d] ? state.dailyWeather[d].temp : null;

                    if (!dailyMap.has(d)) dailyMap.set(d, { m3: 0, kwh: 0, type: type, temp: temp });
                    const entry = dailyMap.get(d);
                    entry.m3 += val;
                    entry.kwh += val * state.settings.conversionCoef;
                    if(type === 'real') entry.type = 'real';
                    if(temp !== null) entry.temp = temp;
                });
            }

            state.computedDaily = Array.from(dailyMap.entries())
                .map(([date, data]) => ({ date, ...data }))
                .sort((a,b) => new Date(a.date) - new Date(b.date));
                
            updateUI();
        }

        // --- CANVAS RENDERER ---
        function renderChart(data) {
            const canvas = document.getElementById('mainCanvas');
            const container = document.getElementById('chartContainer');
            if (!canvas || !container) return;

            const dpr = window.devicePixelRatio || 1;
            const rect = container.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            const ctx = canvas.getContext('2d');
            ctx.scale(dpr, dpr);
            ctx.clearRect(0, 0, rect.width, rect.height);

            if (data.length === 0) {
                ctx.fillStyle = "#374151";
                ctx.font = "12px 'Outfit', monospace";
                ctx.textAlign = "center";
                ctx.fillText("EN ATTENTE DE DONNÉES...", rect.width/2, rect.height/2);
                return;
            }

            // Aggregation logic
            let items = data;
            const tooMany = data.length > 100;
            if(tooMany) {
                const grouped = {};
                data.forEach(d => {
                    const k = d.date.substring(0, 7);
                    if (!grouped[k]) grouped[k] = { val:0, kwh:0, count:0, tempSum:0, tempCount:0, date: k+"-01" };
                    grouped[k].val += (state.ui.chartMode === 'kwh' ? d.kwh : (d.kwh * state.settings.kwhPrice));
                    grouped[k].kwh += d.kwh;
                    grouped[k].count++;
                    if(d.temp) { grouped[k].tempSum += d.temp; grouped[k].tempCount++; }
                });
                items = Object.values(grouped).sort((a,b) => a.date.localeCompare(b.date)).map(g => ({
                    ...g, val: g.val, temp: g.tempCount ? g.tempSum/g.tempCount : null, type: 'aggregate'
                }));
            } else {
                items = data.map(d => ({ ...d, val: state.ui.chartMode === 'kwh' ? d.kwh : (d.kwh * state.settings.kwhPrice) }));
            }

            const padding = { top: 20, bottom: 20, left: 0, right: 0 };
            const chartHeight = rect.height - padding.top - padding.bottom;
            const chartWidth = rect.width;
            const maxVal = Math.max(...items.map(i => i.val)) || 10;
            const barWidth = (chartWidth / items.length);
            const gap = Math.max(1, barWidth * 0.2);
            const trueBarWidth = barWidth - gap;

            // Temp Line
            ctx.beginPath();
            let hasTemp = false;
            items.forEach((item, i) => {
                if(item.temp !== null) {
                    const x = (i * barWidth) + (barWidth/2);
                    const tempY = padding.top + chartHeight - ((Math.max(-5, Math.min(35, item.temp)) + 5) / 40) * chartHeight;
                    if(!hasTemp) { ctx.moveTo(x, tempY); hasTemp = true; } else ctx.lineTo(x, tempY);
                }
            });
            if(hasTemp) {
                ctx.lineJoin = 'round';
                ctx.lineWidth = 2;
                ctx.strokeStyle = '#f97316';
                ctx.shadowColor = '#f97316';
                ctx.shadowBlur = 10;
                ctx.stroke();
                ctx.shadowBlur = 0;
            }

            // Bars
            items.forEach((item, i) => {
                const h = (item.val / maxVal) * chartHeight;
                const x = (i * barWidth) + (gap/2);
                const y = padding.top + chartHeight - h;

                let color = '#06b6d4';
                let glow = '#06b6d4';
                if(item.type === 'real') { color = '#10b981'; glow = '#10b981'; }
                
                const grd = ctx.createLinearGradient(x, y, x, y + h);
                grd.addColorStop(0, color);
                grd.addColorStop(1, 'rgba(0,0,0,0)');

                ctx.fillStyle = grd;
                ctx.shadowColor = glow;
                ctx.shadowBlur = 8;
                ctx.fillRect(x, y, trueBarWidth, h);
                
                ctx.fillStyle = '#fff';
                ctx.shadowBlur = 0;
                ctx.fillRect(x, y, trueBarWidth, 2);
            });

            // Grid
            ctx.strokeStyle = 'rgba(255,255,255,0.1)';
            ctx.lineWidth = 1;
            [0, 0.5, 1].forEach(p => {
                const y = padding.top + (chartHeight * p);
                ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(chartWidth, y); ctx.stroke();
            });

            canvas.chartData = { items, barWidth, rect, maxVal };
        }

        // Canvas Interaction
        document.getElementById('mainCanvas').addEventListener('mousemove', function(e) {
            const canvas = e.target;
            if(!canvas.chartData) return;
            const { items, barWidth } = canvas.chartData;
            const index = Math.floor(e.offsetX / barWidth);
            const tooltip = document.getElementById('canvasTooltip');

            if(index >= 0 && index < items.length) {
                const item = items[index];
                const dateStr = new Date(item.date).toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric', month: 'short' });
                const valUnit = state.ui.chartMode === 'kwh' ? 'kWh' : '€';
                
                tooltip.style.display = 'block';
                tooltip.style.left = (e.clientX + 10) + 'px';
                tooltip.style.top = (e.clientY + 10) + 'px';
                tooltip.innerHTML = `
                    <div class="font-bold text-white mb-1 border-b border-gray-700 pb-1">${dateStr}</div>
                    <div class="flex justify-between gap-4"><span class="text-gray-400">Vol.</span> <span class="text-cyan-400 font-mono">${item.val.toFixed(1)} ${valUnit}</span></div>
                    ${item.temp ? `<div class="flex justify-between gap-4"><span class="text-gray-400">Temp.</span> <span class="text-orange-400 font-mono">${item.temp.toFixed(1)}°C</span></div>` : ''}
                `;
            } else { tooltip.style.display = 'none'; }
        });
        document.getElementById('mainCanvas').addEventListener('mouseleave', () => document.getElementById('canvasTooltip').style.display = 'none');

        // --- UI ---
        function updateUI() {
            let data = state.computedDaily;
            const target = state.ui.currentDate;
            
            if (state.ui.periodFilter === 'year') {
                data = data.filter(d => new Date(d.date).getFullYear() === target.getFullYear());
                document.getElementById('currentPeriodLabel').innerText = target.getFullYear();
            } else if (state.ui.periodFilter === 'month') {
                const m = target.getMonth(), y = target.getFullYear();
                data = data.filter(d => { const x = new Date(d.date); return x.getMonth() === m && x.getFullYear() === y; });
                document.getElementById('currentPeriodLabel').innerText = target.toLocaleDateString('fr-FR', {month:'short', year:'numeric'});
            } else if (state.ui.periodFilter === 'custom') {
                const s = new Date(document.getElementById('customStart').value);
                const e = new Date(document.getElementById('customEnd').value);
                if(s && e) { data = data.filter(d => { const x = new Date(d.date); return x >= s && x <= e; }); }
            }

            const tkwh = data.reduce((a, b) => a + b.kwh, 0);
            const days = data.length || 1;
            const cost = (tkwh * state.settings.kwhPrice) + (state.settings.subscription * (days/365));
            const ttc = cost * (1 + state.settings.tva);
            const temps = data.filter(d => d.temp !== null).map(d => d.temp);
            const avgTemp = temps.length > 0 ? (temps.reduce((a,b)=>a+b,0) / temps.length).toFixed(1) : '--';
            const reliability = (data.filter(d => d.type === 'real').length / days) * 100;

            document.getElementById('kpiKwh').innerText = Math.round(tkwh).toLocaleString();
            document.getElementById('kpiAvg').innerText = (tkwh/days).toFixed(1);
            document.getElementById('kpiCost').innerHTML = ttc.toFixed(2) + ' <span class="text-sm">€</span>';
            document.getElementById('kpiAvgTemp').innerText = avgTemp + '°C';
            document.getElementById('kpiReliability').innerText = Math.round(reliability) + '%';
            document.getElementById('reliablityBar').style.width = reliability + '%';

            const nav = document.getElementById('dateNavigator');
            const cust = document.getElementById('customRangeSelector');
            if(state.ui.periodFilter === 'custom') { nav.classList.add('hidden'); cust.classList.remove('hidden'); }
            else if(state.ui.periodFilter === 'global') { nav.classList.add('hidden'); cust.classList.add('hidden'); }
            else { nav.classList.remove('hidden'); cust.classList.add('hidden'); }

            renderChart(data);
            renderHeatmap();
            renderHistory();
        }

        function renderHeatmap() {
            const grid = document.getElementById("heatmapGrid");
            grid.innerHTML = '';
            let target = state.ui.currentDate;
            if(state.ui.periodFilter === 'global') target = new Date();
            
            const year = target.getFullYear(); const month = target.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const startDay = new Date(year, month, 1).getDay(); 
            const offset = startDay === 0 ? 6 : startDay - 1;

            for(let i=0; i<offset; i++) grid.innerHTML += '<div></div>';
            
            const relevant = state.computedDaily.filter(d => new Date(d.date).getMonth() === month && new Date(d.date).getFullYear() === year);
            const max = Math.max(...relevant.map(d=>d.m3), 1);

            for(let d=1; d<=daysInMonth; d++) {
                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const found = relevant.find(x => x.date === dateStr);
                const el = document.createElement('div');
                el.className = "aspect-square rounded flex items-center justify-center text-[9px] text-gray-500 relative group cursor-default transition-all hover:scale-110";
                el.innerText = d;
                if(found) {
                    const alpha = 0.2 + (found.m3/max)*0.8;
                    const col = found.type === 'real' ? `rgba(16,185,129,${alpha})` : `rgba(6,182,212,${alpha})`;
                    el.style.backgroundColor = col; el.style.color = '#fff';
                    if(found.m3 > max*0.8) el.style.boxShadow = `0 0 8px ${col}`;
                    el.title = `${found.m3.toFixed(1)} m³`;
                } else { el.style.backgroundColor = 'rgba(255,255,255,0.05)'; }
                grid.appendChild(el);
            }
        }

        function renderHistory() {
            const list = document.getElementById('historyList');
            list.innerHTML = '';
            [...state.readings].sort((a,b) => new Date(b.date) - new Date(a.date)).forEach((r, i) => {
                const div = document.createElement('div');
                div.className = "bg-[#0f1219] p-3 rounded border border-gray-800 hover:border-gray-600 transition-colors group relative";
                div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="w-1 h-8 bg-gradient-to-b from-cyan-500 to-blue-600 rounded-full"></div>
                            <div>
                                <div class="text-xs text-white font-bold tracking-wider">${new Date(r.date).toLocaleDateString()}</div>
                                <div class="text-[10px] text-gray-500">${r.time || '00:00'}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm font-mono text-cyan-300 font-bold">${r.value.toLocaleString()}</div>
                            ${r.temp ? `<div class="text-[9px] text-orange-400 font-bold">${r.temp}°C</div>` : ''}
                        </div>
                    </div>
                    <button onclick="delReading('${r.date}', '${r.time||''}')" class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 text-red-500 hover:bg-red-900/30 p-1 rounded transition-all"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                `;
                list.appendChild(div);
            });
            if(window.lucide) lucide.createIcons();
        }

        // --- GEMINI AI ---
        async function callGeminiAnalysis() {
            const div = document.getElementById('aiContent');
            const key = state.settings.apiKey;
            if(!key) { div.innerHTML = `<div class="text-center p-4 border border-red-500/30 rounded bg-red-900/10"><h3 class="text-red-400 font-bold">ACCÈS REFUSÉ</h3><p class="text-xs text-red-300 mt-2">Clé de sécurité manquante.</p><button onclick="toggleSettings(); closeAI()" class="mt-4 px-4 py-2 bg-red-500/20 hover:bg-red-500/40 text-white text-xs rounded border border-red-500">CONFIGURER CLÉ API</button></div>`; return; }

            div.innerHTML = `<div class="flex flex-col items-center justify-center h-64 gap-4"><i data-lucide="cpu" class="w-12 h-12 text-fuchsia-500 animate-spin-slow"></i><p class="text-fuchsia-400 animate-pulse text-xs tracking-widest">NÉO-CORTEX EN TRAITEMENT...</p></div>`;
            if(window.lucide) lucide.createIcons();

            const data = state.computedDaily;
            const totalKwh = data.reduce((a, b) => a + b.kwh, 0).toFixed(0);
            const avgTemp = (data.filter(d=>d.temp).reduce((a,b)=>a+b.temp,0) / (data.filter(d=>d.temp).length || 1)).toFixed(1);
            const prompt = `Analyse Cyberpunk/Technique pour app de gestion gaz. Données: ${data.length} jours, ${totalKwh} kWh total, T° moy ${avgTemp}°C. Donne 3 conseils techniques concis (format Markdown avec titres et puces) pour optimisation thermique. Ton : Assistant IA Futuriste.`;

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const json = await res.json();
                const text = json.candidates?.[0]?.content?.parts?.[0]?.text;
                if (text) {
                    const html = text.replace(/^### (.*$)/gim, '<h3 class="text-fuchsia-400 font-bold mt-4 mb-2 uppercase text-sm tracking-wider">$1</h3>')
                                     .replace(/^\* (.*$)/gim, '<li class="ml-4 text-gray-300 text-xs mb-1 list-disc marker:text-fuchsia-600">$1</li>')
                                     .replace(/\*\*(.*)\*\*/gim, '<strong class="text-white">$1</strong>');
                    div.innerHTML = `<div class="prose-ai p-2">${html}</div>`;
                }
            } catch (e) { div.innerHTML = `<p class="text-red-400 text-xs">Erreur de connexion neurale: ${e.message}</p>`; }
        }

        // --- EVENTS ---
        function setFilter(p) { state.ui.periodFilter = p; updateUI(); document.querySelectorAll('.filter-btn').forEach(b => b.className = `filter-btn px-3 py-1 text-xs rounded transition-all ${b.dataset.period === p ? 'text-white bg-cyan-500/20 shadow-[0_0_10px_rgba(6,182,212,0.2)]' : 'text-gray-400 hover:text-white'}`); }
        function changePeriod(d) { const dt = state.ui.currentDate; state.ui.periodFilter === 'year' ? dt.setFullYear(dt.getFullYear()+d) : dt.setMonth(dt.getMonth()+d); state.ui.currentDate = new Date(dt); updateUI(); }
        function setChartMode(m) { state.ui.chartMode = m; updateUI(); document.querySelectorAll('.chart-mode-btn').forEach(b => b.className = `chart-mode-btn px-3 py-1 text-[10px] rounded transition-all ${b.dataset.mode === m ? 'text-white bg-cyan-500/20' : 'text-gray-400 hover:text-white'}`); }
        
        function openModule() { document.getElementById('hudOverlay').classList.remove('hidden'); setTimeout(() => { document.getElementById('hudOverlay').classList.remove('opacity-0'); document.getElementById('hudContent').classList.remove('scale-95'); }, 10); document.getElementById('hudDate').valueAsDate = new Date(); document.getElementById('hudTime').value = new Date().toTimeString().substring(0,5); activeInput='hudIndex'; }
        function closeModule() { document.getElementById('hudOverlay').classList.add('opacity-0'); document.getElementById('hudContent').classList.add('scale-95'); setTimeout(() => document.getElementById('hudOverlay').classList.add('hidden'), 300); }
        function submitHudForm() {
            const d = document.getElementById('hudDate').value; const t = document.getElementById('hudTime').value; const v = parseFloat(document.getElementById('hudIndex').value); const temp = parseFloat(document.getElementById('hudTemp').value);
            if(!d || isNaN(v)) return;
            const idx = state.readings.findIndex(r => r.date === d && r.time === t);
            const entry = { date: d, time: t, value: v, temp: isNaN(temp)?null:temp };
            if(idx > -1) { if(confirm("Écraser ?")) state.readings[idx] = entry; } else state.readings.push(entry);
            saveData(); recalcEngine(); closeModule();
        }
        function numpadPress(k) { const el = document.getElementById(activeInput); if(!el) return; if(k === 'DEL') el.value = el.value.slice(0, -1); else if(k === '-') el.value = el.value.startsWith('-') ? el.value.slice(1) : '-'+el.value; else el.value += k; }
        
        function toggleSettings() { document.getElementById('settingsOverlay').classList.toggle('hidden'); }
        function saveSettings() {
            state.settings.kwhPrice = parseFloat(document.getElementById('setPrice').value);
            state.settings.subscription = parseFloat(document.getElementById('setSub').value);
            state.settings.conversionCoef = parseFloat(document.getElementById('setCoef').value);
            state.settings.lat = parseFloat(document.getElementById('setLat').value);
            state.settings.lon = parseFloat(document.getElementById('setLon').value);
            state.settings.apiKey = document.getElementById('setApiKey').value;
            saveData(); recalcEngine(); toggleSettings();
        }

        function openAI() { document.getElementById('aiOverlay').classList.remove('hidden'); callGeminiAnalysis(); }
        function closeAI() { document.getElementById('aiOverlay').classList.add('hidden'); }
        function toggleSidebar() { const s = document.getElementById('mainSidebar'); s.classList.toggle('w-64'); s.classList.toggle('w-20'); }

        async function fetchWeatherData() {
            const btn = document.querySelector('button[title="Sync Météo"]'); const old = btn.innerHTML; btn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>'; if(window.lucide) lucide.createIcons();
            try {
                if(!state.readings.length) throw new Error("No dates");
                const dates = [...state.readings.map(r => r.date)].sort();
                const url = `https://archive-api.open-meteo.com/v1/archive?latitude=${state.settings.lat}&longitude=${state.settings.lon}&start_date=${dates[0]}&end_date=${new Date().toISOString().split('T')[0]}&daily=temperature_2m_mean&timezone=auto`;
                const d = await (await fetch(url)).json();
                if(d.daily) { d.daily.time.forEach((t, i) => state.dailyWeather[t] = { temp: d.daily.temperature_2m_mean[i] }); saveData(); recalcEngine(); }
            } catch(e) { alert("Erreur météo"); } finally { btn.innerHTML = old; if(window.lucide) lucide.createIcons(); }
        }

        function exportData() { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(state)], {type:"application/json"})); a.download = `NEOGAZ_${new Date().toISOString().split('T')[0]}.json`; a.click(); }
        
        // --- NEW IMPORT LOGIC ---
        document.getElementById('fileImport').addEventListener('change', e => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (evt) => {
                const content = evt.target.result;
                if (file.name.endsWith('.json')) {
                    try {
                        const json = JSON.parse(content);
                        if (json.readings || json.settings) {
                            state = { ...state, ...json };
                            saveData();
                            recalcEngine();
                            alert("Backup JSON importé avec succès !");
                        }
                    } catch(err) { alert("Erreur format JSON"); }
                } else if (file.name.endsWith('.csv')) {
                    parseCSVImport(content);
                }
            };
            reader.readAsText(file);
        });

        function parseCSVImport(csvText) {
            const lines = csvText.split(/\r?\n/).filter(l => l.trim() !== '');
            let importedCount = 0;

            // Simple Detection Logic
            const isIndexFile = lines.some(l => l.includes("Date de relevé de l'index") && l.includes("Index (m3)"));
            const isDailyFile = lines.some(l => l.includes("Date de consommation") && l.includes("Consommation (m3)"));

            if (isIndexFile) {
                // Format: Date;Type;Index;Coef
                lines.forEach(line => {
                    if (!line.match(/^\d{2}\/\d{2}\/\d{4}/)) return; // Skip headers
                    const cols = line.split(';');
                    if (cols.length < 3) return;

                    const dateParts = cols[0].split('/'); // DD/MM/YYYY
                    if (dateParts.length !== 3) return;
                    const dateISO = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`;
                    
                    const valStr = cols[2].replace(/"/g, '').replace(',', '.').replace(/\s/g, '');
                    const val = parseFloat(valStr);

                    if (!isNaN(val)) {
                        const exists = state.readings.find(r => r.date === dateISO);
                        if (!exists) {
                            state.readings.push({ date: dateISO, time: "00:00", value: val });
                            importedCount++;
                        }
                    }
                });
                alert(`${importedCount} relevés d'index importés.`);
            } else if (isDailyFile) {
                // Format: Date;Conso;Coef;Type
                lines.forEach(line => {
                    if (!line.match(/^\d{2}\/\d{2}\/\d{4}/)) return;
                    const cols = line.split(';');
                    if (cols.length < 2) return;

                    const dateParts = cols[0].split('/');
                    if (dateParts.length !== 3) return;
                    const dateISO = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`;

                    const valStr = cols[1].replace(/"/g, '').replace(',', '.').replace(/\s/g, '');
                    const val = parseFloat(valStr);

                    if (!isNaN(val)) {
                        state.importedData[dateISO] = val; // Store exact daily usage
                        importedCount++;
                    }
                });
                alert(`${importedCount} jours de consommation importés.`);
            } else {
                alert("Format CSV non reconnu. Utilisez les exports 'mes-index' ou 'ma-conso-quotidienne'.");
                return;
            }

            saveData();
            recalcEngine();
        }

        function delReading(d,t) { if(confirm("Supprimer ?")) { state.readings = state.readings.filter(r => r.date!==d || r.time!==t); saveData(); recalcEngine(); } }

        init();
    </script>
</body>
</html>

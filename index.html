<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suivi Gaz - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #111827 0%, #1e3a8a 50%, #4c1d95 100%);
            min-height: 100vh; color: #fff; background-attachment: fixed;
        }
        .card {
            background: rgba(31, 41, 55, 0.7); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 1rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2); transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover { box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3); border-color: rgba(255, 255, 255, 0.2); }
        input, select { background: rgba(0, 0, 0, 0.3) !important; border: 1px solid rgba(255, 255, 255, 0.1) !important; color: white !important; backdrop-filter: blur(5px); }
        input:focus, select:focus { border-color: #60a5fa !important; outline: none; box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.3); }
        
        .bar-container { display: flex; align-items: flex-end; justify-content: space-between; height: 220px; gap: 2px; padding-top: 20px; }
        .bar-wrapper { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; height: 100%; position: relative; min-width: 3px; }
        .bar { width: 100%; border-radius: 3px 3px 0 0; transition: height 0.5s cubic-bezier(0.4, 0, 0.2, 1); min-height: 2px; }
        .bar-wrapper:hover .bar { filter: brightness(1.3); }
        .bar-wrapper:hover::after { content: attr(data-tooltip); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: rgba(17, 24, 39, 0.95); color: white; padding: 6px 10px; border-radius: 8px; font-size: 0.75rem; font-weight: 600; white-space: pre; z-index: 50; border: 1px solid rgba(255,255,255,0.1); pointer-events: none; margin-bottom: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        .bar-label { font-size: 0.65rem; color: #94a3b8; margin-top: 6px; text-align: center; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .real .bar { background: linear-gradient(to top, #059669, #34d399); } 
        .estimated .bar { background: linear-gradient(to top, #7c3aed, #a78bfa); } 
        .mixed .bar { background: linear-gradient(to top, #2563eb, #60a5fa); }

        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
        .day-cell { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 8px; background: rgba(255,255,255,0.05); font-size: 0.8rem; position: relative; border: 1px solid transparent; transition: all 0.2s; }
        .day-cell.has-data:hover { transform: scale(1.1); z-index: 10; border-color: rgba(255,255,255,0.5); box-shadow: 0 8px 20px rgba(0,0,0,0.4); background: rgba(30, 41, 59, 0.9); }
        .intensity-bar { width: 70%; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; margin-top: 4px; overflow: hidden; }
        .intensity-fill { height: 100%; border-radius: 2px; }
        .marker-dot { position: absolute; top: 4px; right: 4px; width: 6px; height: 6px; border-radius: 50%; box-shadow: 0 0 5px currentColor;}
        .bg-real { background-color: #10b981; color: #10b981; }

        .btn-primary { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border: none; color: white; font-weight: 600; transition: all 0.2s; }
        .btn-primary:hover { transform: scale(1.05); box-shadow: 0 0 15px rgba(59, 130, 246, 0.5); }
        .btn-secondary { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: #e5e7eb; transition: all 0.2s; }
        .btn-secondary:hover { background: rgba(255, 255, 255, 0.2); }

        @media print { .print-hidden { display: none !important; } body { background: white !important; color: black !important; } .card { background: white !important; border: 1px solid #ccc !important; box-shadow: none !important; } .bar { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; } }
        .fab { position: fixed; bottom: 2rem; right: 2rem; width: 3.5rem; height: 3.5rem; border-radius: 50%; background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4); z-index: 50; transition: transform 0.2s; }
        .fab:active { transform: scale(0.9); }
        @media (min-width: 1024px) { .fab { display: none; } }
        .hidden { display: none; }
    </style>
</head>
<body class="p-4 md:p-8 pb-24">
    <div class="max-w-7xl mx-auto space-y-8">
        <header class="flex flex-col md:flex-row justify-between items-center pb-6 border-b border-white/10 print-hidden gap-6">
            <div>
                <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-white to-blue-200">Suivi Gaz</h1>
                <div class="flex items-center gap-4 mt-2 text-sm text-blue-200/80 font-medium">
                    <span class="flex items-center"><span class="w-2.5 h-2.5 rounded-full bg-emerald-400 mr-2 shadow-[0_0_10px_#34d399]"></span> Donn√©es R√©elles (GRDF)</span>
                    <span class="flex items-center"><span class="w-2.5 h-2.5 rounded-full bg-violet-400 mr-2 shadow-[0_0_10px_#a78bfa]"></span> Estim√© (Index)</span>
                </div>
            </div>
            <div class="flex flex-wrap gap-3">
                <button onclick="document.getElementById('file-input').click()" class="flex items-center space-x-2 px-5 py-2.5 btn-primary rounded-xl shadow-lg transform hover:scale-105 active:scale-95">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg><span>Importer GRDF</span>
                </button>
                <input type="file" id="file-input" class="hidden" accept=".csv,.json,.txt" onchange="handleImport(this)" multiple>
                <button onclick="exportData()" class="px-5 py-2.5 btn-secondary rounded-xl">Sauvegarder</button>
                <button onclick="window.print()" class="px-5 py-2.5 btn-secondary rounded-xl">Imprimer</button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-4 space-y-8">
                <section class="card p-6">
                    <div class="flex flex-wrap justify-between items-center mb-6 gap-3">
                        <h2 class="text-xl font-bold text-white flex items-center gap-2"><span class="text-2xl">üìä</span> Synth√®se</h2>
                        <div class="flex bg-black/20 rounded-lg p-1 gap-1">
                            <button onclick="setSynth('global')" id="btn-sy-global" class="px-3 py-1.5 text-xs font-medium rounded-md text-white bg-indigo-500 shadow-sm">Global</button>
                            <button onclick="setSynth('year')" id="btn-sy-year" class="px-3 py-1.5 text-xs font-medium rounded-md text-gray-400 hover:text-white hover:bg-white/5">An</button>
                            <button onclick="setSynth('month')" id="btn-sy-month" class="px-3 py-1.5 text-xs font-medium rounded-md text-gray-400 hover:text-white hover:bg-white/5">Mois</button>
                            <button onclick="setSynth('custom')" id="btn-sy-custom" class="px-3 py-1.5 text-xs font-medium rounded-md text-gray-400 hover:text-white hover:bg-white/5">Perso</button>
                        </div>
                    </div>
                    <div id="synth-controls" class="mb-6 hidden space-y-3 bg-black/20 p-3 rounded-lg border border-white/5">
                        <select id="synth-year-select" onchange="updateSynth()" class="w-full p-2 rounded-lg text-sm hidden"></select>
                        <input type="month" id="synth-month-select" onchange="updateSynth()" class="w-full p-2 rounded-lg text-sm hidden">
                        <div id="synth-custom-range" class="hidden flex gap-2">
                            <input type="date" id="synth-start" onchange="updateSynth()" class="w-1/2 p-2 rounded-lg text-sm">
                            <input type="date" id="synth-end" onchange="updateSynth()" class="w-1/2 p-2 rounded-lg text-sm">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-blue-500/10 p-4 rounded-xl border border-blue-500/20 relative overflow-hidden group">
                            <div class="absolute -right-4 -top-4 w-16 h-16 bg-blue-500/20 rounded-full blur-2xl group-hover:bg-blue-500/30 transition"></div>
                            <div class="text-xs text-blue-300 uppercase font-bold tracking-wider mb-1">Volume</div>
                            <div class="text-2xl font-bold text-white" id="disp-m3">0 m¬≥</div>
                            <div class="text-sm text-blue-200/60 font-mono mt-1" id="disp-kwh">0 kWh</div>
                        </div>
                        <div class="bg-emerald-500/10 p-4 rounded-xl border border-emerald-500/20 relative overflow-hidden group">
                            <div class="absolute -right-4 -top-4 w-16 h-16 bg-emerald-500/20 rounded-full blur-2xl group-hover:bg-emerald-500/30 transition"></div>
                            <div class="text-xs text-emerald-300 uppercase font-bold tracking-wider mb-1">Co√ªt TTC</div>
                            <div class="text-2xl font-bold text-white" id="disp-cost">0 ‚Ç¨</div>
                            <div class="text-sm text-emerald-200/60 font-mono mt-1" id="disp-cost-ht">HT: 0 ‚Ç¨</div>
                        </div>
                        <div class="col-span-2 text-xs text-center text-gray-500 italic mt-2 border-t border-white/5 pt-2" id="synth-label">P√©riode globale</div>
                    </div>
                </section>
                <section class="card p-6 print-hidden hidden lg:block relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-4 opacity-10 text-6xl">üìù</div>
                    <h2 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-5">Ajouter un Index</h2>
                    <form onsubmit="addManualIndex(event, 'desktop')" class="space-y-5">
                        <div><label class="text-xs text-gray-500 mb-1.5 block font-medium ml-1">Date du relev√©</label><input type="datetime-local" id="date-desktop" required class="w-full p-3 rounded-xl text-sm"></div>
                        <div><label class="text-xs text-gray-500 mb-1.5 block font-medium ml-1">Index Compteur (m¬≥)</label><input type="number" id="index-desktop" step="0.001" required placeholder="Ex: 5488" class="w-full p-3 rounded-xl text-sm font-mono"></div>
                        <button type="submit" class="w-full btn-primary py-3 rounded-xl text-sm shadow-lg">Enregistrer l'index</button>
                    </form>
                </section>
                <section class="card print-hidden">
                    <button onclick="document.getElementById('params-box').classList.toggle('hidden')" class="w-full p-5 flex justify-between items-center hover:bg-white/5 transition group"><span class="text-sm font-semibold text-gray-300 group-hover:text-white flex items-center gap-2"><span>‚öôÔ∏è</span> Param√®tres Facture</span><svg class="w-4 h-4 text-gray-500 group-hover:text-white transition" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg></button>
                    <div id="params-box" class="hidden px-5 pb-6 pt-2 border-t border-white/10 space-y-4 bg-black/10">
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-[0.65rem] uppercase text-gray-500 font-bold mb-1.5 block ml-1">Prix kWh HT (‚Ç¨)</label><input id="p-kwh" type="number" step="0.0001" value="0.0777" onchange="recalc()" class="w-full p-2 rounded-lg text-xs bg-black/20 border border-white/10 font-mono text-indigo-300"></div>
                            <div><label class="text-[0.65rem] uppercase text-gray-500 font-bold mb-1.5 block ml-1">Abo/Mois HT (‚Ç¨)</label><input id="p-abo" type="number" step="0.01" value="16.72" onchange="recalc()" class="w-full p-2 rounded-lg text-xs bg-black/20 border border-white/10 font-mono text-indigo-300"></div>
                            <div><label class="text-[0.65rem] uppercase text-gray-500 font-bold mb-1.5 block ml-1">TVA Conso %</label><input id="p-tva1" type="number" step="0.1" value="20" onchange="recalc()" class="w-full p-2 rounded-lg text-xs bg-black/20 border border-white/10 font-mono text-indigo-300"></div>
                            <div><label class="text-[0.65rem] uppercase text-gray-500 font-bold mb-1.5 block ml-1">TVA Abo %</label><input id="p-tva2" type="number" step="0.1" value="5.5" onchange="recalc()" class="w-full p-2 rounded-lg text-xs bg-black/20 border border-white/10 font-mono text-indigo-300"></div>
                            <div class="col-span-2"><label class="text-[0.65rem] uppercase text-gray-500 font-bold mb-1.5 block ml-1">Coef. Conv. (kWh/m¬≥)</label><input id="p-coef" type="number" step="0.01" value="11.36" onchange="recalc()" class="w-full p-2 rounded-lg text-xs bg-black/20 border border-white/10 font-mono text-indigo-300"></div>
                        </div>
                    </div>
                </section>
            </div>

            <div class="lg:col-span-8 space-y-8">
                <section class="card p-6">
                    <div class="flex flex-wrap gap-4 justify-between items-center mb-8 pb-4 border-b border-white/5">
                        <h2 class="text-xl font-bold text-white flex items-center gap-2"><span class="text-2xl">üìà</span> <span id="chart-title">√âvolution</span></h2>
                        <div class="flex gap-3">
                            <div class="flex bg-black/20 rounded-lg p-1 text-xs">
                                <button onclick="setChart('day')" id="btn-chart-day" class="px-3 py-1.5 rounded-md bg-indigo-600 text-white shadow-sm transition">Jour</button>
                                <button onclick="setChart('month')" id="btn-chart-month" class="px-3 py-1.5 rounded-md text-gray-400 hover:text-white hover:bg-white/5 transition">Mois</button>
                            </div>
                            <div class="flex bg-black/20 rounded-lg p-1 text-xs">
                                <button onclick="setView('cost')" id="btn-view-cost" class="px-3 py-1.5 rounded-md bg-emerald-600 text-white shadow-sm transition">‚Ç¨</button>
                                <button onclick="setView('kwh')" id="btn-view-kwh" class="px-3 py-1.5 rounded-md text-gray-400 hover:text-white hover:bg-white/5 transition">kWh</button>
                            </div>
                        </div>
                    </div>
                    <div id="chart-container" class="bar-container px-2"></div>
                    <div id="chart-empty" class="hidden h-48 flex items-center justify-center text-gray-500 text-sm italic">Aucune donn√©e pour cette p√©riode</div>
                </section>

                <section class="card p-6">
                    <div class="flex justify-between items-center mb-6 pb-4 border-b border-white/5">
                        <h2 class="text-xl font-bold text-white flex items-center gap-3"><div class="p-2 bg-violet-500/20 rounded-lg"><svg class="w-6 h-6 text-violet-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg></div> Calendrier</h2>
                        <div class="flex items-center gap-2 bg-black/20 rounded-lg p-1">
                            <button onclick="moveCal(-1)" class="p-2 hover:bg-white/10 rounded-md transition text-gray-400 hover:text-white"><svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg></button>
                            <h2 class="text-sm font-bold text-white capitalize w-32 text-center tracking-wide" id="cal-title">--</h2>
                            <button onclick="moveCal(1)" class="p-2 hover:bg-white/10 rounded-md transition text-gray-400 hover:text-white"><svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></button>
                        </div>
                    </div>
                    <div class="calendar-grid mb-3 text-center text-[0.65rem] text-gray-500 font-bold uppercase tracking-widest"><div>Lun</div><div>Mar</div><div>Mer</div><div>Jeu</div><div>Ven</div><div>Sam</div><div>Dim</div></div>
                    <div id="cal-grid" class="calendar-grid gap-2"></div>
                </section>

                <section class="card overflow-hidden">
                    <button onclick="document.getElementById('hist-content').classList.toggle('hidden')" class="w-full p-5 flex justify-between items-center hover:bg-white/5 transition group">
                        <h2 class="text-lg font-semibold text-white flex items-center gap-2"><span class="text-xl">üìã</span> Historique des Index</h2>
                        <svg class="w-5 h-5 text-gray-500 group-hover:text-white transition" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </button>
                    <div id="hist-content" class="hidden max-h-80 overflow-y-auto custom-scrollbar">
                        <table class="w-full text-left text-xs text-gray-400">
                            <thead class="bg-black/20 text-gray-200 sticky top-0 backdrop-blur-md z-10"><tr><th class="px-5 py-3 font-semibold">Date</th><th class="px-5 py-3 text-right font-semibold">Index</th><th class="px-5 py-3 text-right font-semibold">Co√ªt P√©riode (Est.)</th><th class="px-5 py-3 text-center font-semibold">Action</th></tr></thead>
                            <tbody id="hist-body" class="divide-y divide-gray-700/50"></tbody>
                        </table>
                    </div>
                </section>
                <div class="flex justify-end pt-2 print-hidden">
                    <button onclick="resetAll()" class="text-xs text-red-400/70 hover:text-red-400 hover:underline transition flex items-center gap-1">R√©initialiser</button>
                </div>
            </div>
        </div>
    </div>

    <div id="mob-modal" class="fixed inset-0 bg-black/90 backdrop-blur-md z-50 hidden flex items-center justify-center p-6" onclick="if(event.target===this)this.classList.add('hidden')">
        <div class="card w-full max-w-sm p-6 shadow-2xl transform transition-all scale-100">
            <h2 class="text-xl font-bold text-white mb-6">Ajouter Index</h2>
            <form onsubmit="addManualIndex(event, 'mobile')" class="space-y-5">
                <input type="datetime-local" id="date-mobile" required class="w-full p-3 rounded-lg text-sm">
                <input type="number" id="index-mobile" step="0.001" required placeholder="Index m¬≥" class="w-full p-3 rounded-lg text-sm">
                <button class="w-full btn-primary py-3 rounded-lg shadow-lg">Sauvegarder</button>
            </form>
        </div>
    </div>
    <button onclick="openMob()" class="fab print-hidden flex lg:hidden group"><svg class="w-8 h-8 group-active:rotate-90 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg></button>

    <script>
        const APP = { db: { indexes: [], realDays: {}, computedDays: {}, monthly: {} }, ui: { view: 'cost', chartMode: 'day', synthMode: 'global', synthFilter: {}, calDate: new Date() }, limits: { maxD: 1, maxM: 1 } };

        document.addEventListener('DOMContentLoaded', () => { initInputs(); loadDB(); recalc(); });

        function initInputs() {
            const now = new Date(); now.setMinutes(now.getMinutes()-now.getTimezoneOffset()); const iso = now.toISOString().slice(0,16);
            if(document.getElementById('date-desktop')) document.getElementById('date-desktop').value = iso;
            if(document.getElementById('date-mobile')) document.getElementById('date-mobile').value = iso;
            const y = new Date().getFullYear(), m = new Date().toISOString().slice(0,7);
            APP.ui.synthFilter = { year: y, month: m, start: `${y}-01-01`, end: new Date().toISOString().slice(0,10) };
        }

        function loadDB() { try { const s = localStorage.getItem('gaz_db_final_v5'); if(s) { const d = JSON.parse(s); APP.db.indexes = d.indexes||[]; APP.db.realDays = d.realDays||{}; } } catch(e) { console.error(e); } }
        function saveDB() { localStorage.setItem('gaz_db_final_v5', JSON.stringify({ indexes: APP.db.indexes, realDays: APP.db.realDays })); }

        function handleImport(input) {
            const f = input.files[0]; if(!f) return;
            const r = new FileReader();
            r.onload = (e) => {
                const txt = e.target.result; let cR=0, cI=0;
                try {
                    if(f.name.endsWith('.json')||txt.trim().startsWith('{')) {
                        const j = JSON.parse(txt); if(j.indexes) APP.db.indexes=j.indexes; if(j.realDays) APP.db.realDays=j.realDays; alert("Restaur√© !");
                    } else {
                        const lines = txt.split(/\r?\n/);
                        let headIdx=0, type='unknown';
                        for(let i=0; i<Math.min(20, lines.length); i++) {
                            const l = lines[i].toLowerCase();
                            if(l.includes('date') && l.includes('consommation')) { headIdx=i; type='daily'; break; }
                            if(l.includes('date') && l.includes('index')) { headIdx=i; type='index'; break; }
                        }
                        if(type==='unknown') throw new Error("Format inconnu");

                        for(let i=headIdx+1; i<lines.length; i++) {
                            const cl = lines[i].replace(/"/g,'').trim(); if(!cl || !/\d/.test(cl)) continue;
                            let p = cl.split(';'); if(p.length<2) p=cl.split(','); if(p.length<2) continue;
                            let dk = null; const dRaw = p[0].trim();
                            if(dRaw.match(/^\d{2}\/\d{2}\/\d{4}$/)) { const[d,m,y]=dRaw.split('/'); dk=`${y}-${m}-${d}`; }
                            else if(dRaw.match(/^\d{4}-\d{2}-\d{2}/)) { dk=dRaw.split(' ')[0]; }
                            if(!dk) continue;

                            if(type==='daily') {
                                let v = p[1]; if(isNaN(parseFloat(v.replace(',','.'))) && p[2]) v=p[2];
                                const m3 = parseFloat(v.replace(',','.'));
                                let cf = 11.2; if(p[2] && !isNaN(parseFloat(p[2].replace(',','.')))) cf=parseFloat(p[2].replace(',','.'));
                                else if(p[3] && !isNaN(parseFloat(p[3].replace(',','.')))) cf=parseFloat(p[3].replace(',','.'));
                                if(!isNaN(m3)) { APP.db.realDays[dk] = { m3, kwh: m3*cf }; cR++; }
                            } else {
                                let v = p[1]; if(isNaN(parseFloat(v.replace(',','.'))) && p[2]) v=p[2];
                                const idx = parseFloat(v.replace(',','.'));
                                if(!isNaN(idx) && idx>10) {
                                    if(!APP.db.indexes.some(x=>x.date.startsWith(dk))) { APP.db.indexes.push({id:Date.now()+Math.random(), date:dk+"T12:00", index: idx}); cI++; }
                                }
                            }
                        }
                        alert(`Import√©: ${cR} jours r√©els, ${cI} index.`);
                    }
                    saveDB(); recalc();
                } catch(err) { alert("Erreur: "+err.message); }
                input.value = '';
            };
            r.readAsText(f);
        }

        function exportData() {
            const b = new Blob([JSON.stringify({indexes: APP.db.indexes, realDays: APP.db.realDays})], {type:'application/json'});
            const u = URL.createObjectURL(b);
            const a = document.createElement('a'); a.href=u; a.download=`backup_gaz_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }

        function recalc() {
            const P = getParams();
            APP.db.computedDays = {}; APP.db.monthly = {}; APP.limits.maxD = 0; APP.limits.maxM = 0;

            // Real
            for(const [k,v] of Object.entries(APP.db.realDays)) {
                const costHT = v.kwh * P.kwh;
                const costTTC = (costHT*(1+P.tva1)) + ((P.abo*12/365)*(1+P.tva2));
                APP.db.computedDays[k] = { ...v, cost: costTTC, type: 'real' };
            }

            // Index
            APP.db.indexes.sort((a,b) => new Date(a.date) - new Date(b.date));
            for(let i=1; i<APP.db.indexes.length; i++) {
                const p = APP.db.indexes[i-1], c = APP.db.indexes[i];
                const d1 = new Date(p.date), d2 = new Date(c.date);
                const days = Math.ceil((d2-d1)/(86400000));

                const deltaM3 = c.index - p.index;
                if(deltaM3 >= 0) {
                    const kwhP = deltaM3 * P.coef;
                    const costP = (kwhP * P.kwh * (1+P.tva1)) + (P.abo * (days/30.5) * (1+P.tva2));
                    c.costPeriod = costP; // Stored for history table
                } else continue;

                if(days<=0) continue;
                const totKwh = deltaM3 * P.coef;
                let realKwh = 0, missing = [];
                for(let j=0; j<days; j++) {
                    const d = new Date(d1); d.setDate(d.getDate()+j);
                    const k = d.toISOString().slice(0,10);
                    if(APP.db.computedDays[k] && APP.db.computedDays[k].type==='real') realKwh += APP.db.computedDays[k].kwh;
                    else missing.push(k);
                }

                if(missing.length > 0) {
                    const remKwh = Math.max(0, totKwh - realKwh);
                    const estDay = remKwh / missing.length;
                    const estM3 = (deltaM3 - (realKwh/P.coef)) / missing.length;
                    const costDay = (estDay * P.kwh * (1+P.tva1)) + ((P.abo*12/365)*(1+P.tva2));
                    missing.forEach(k => { if(!APP.db.computedDays[k]) APP.db.computedDays[k] = { kwh: estDay, m3: Math.max(0,estM3), cost: costDay, type: 'estimated' }; });
                }
            }

            // Agg
            for(const [k,v] of Object.entries(APP.db.computedDays)) {
                const m = k.slice(0,7);
                if(!APP.db.monthly[m]) APP.db.monthly[m] = { kwh:0, cost:0, m3:0 };
                APP.db.monthly[m].kwh += v.kwh; APP.db.monthly[m].cost += v.cost; APP.db.monthly[m].m3 += v.m3;
                const val = APP.ui.view==='kwh'?v.kwh:v.cost;
                if(val>APP.limits.maxD) APP.limits.maxD = val;
            }
            for(const v of Object.values(APP.db.monthly)) {
                const val = APP.ui.view==='kwh'?v.kwh:v.cost;
                if(val>APP.limits.maxM) APP.limits.maxM = val;
            }
            renderAll();
        }

        function renderAll() { renderSynth(); renderChart(); renderCal(); renderHist(); }

        function renderSynth() {
            const mode = APP.ui.synthMode;
            const f = document.getElementById('synth-controls');
            const ys = document.getElementById('synth-year-select');
            const ms = document.getElementById('synth-month-select');
            const cs = document.getElementById('synth-custom-range');
            const lLabel = document.getElementById('synth-label');

            ['global','year','month','custom'].forEach(m => {
                const b = document.getElementById('btn-sy-'+m);
                if(m===mode) { b.classList.remove('text-gray-400','hover:text-white','hover:bg-white/5'); b.classList.add('text-white','bg-indigo-500','shadow-sm'); } 
                else { b.classList.add('text-gray-400','hover:text-white','hover:bg-white/5'); b.classList.remove('text-white','bg-indigo-500','shadow-sm'); }
            });

            f.classList.add('hidden'); ys.classList.add('hidden'); ms.classList.add('hidden'); cs.classList.add('hidden');
            if(mode !== 'global') f.classList.remove('hidden');

            let start=null, end=null, label="Donn√©es Globales";
            const allKeys = Object.keys(APP.db.computedDays).sort();

            if(mode==='year') {
                ys.classList.remove('hidden');
                const years = [...new Set(allKeys.map(k=>k.slice(0,4)))].sort().reverse();
                if(years.length===0) years.push(new Date().getFullYear());
                if(ys.options.length !== years.length) { ys.innerHTML=''; years.forEach(y=>ys.add(new Option(y,y))); }
                if(!years.includes(APP.ui.synthFilter.year.toString())) APP.ui.synthFilter.year = years[0];
                ys.value = APP.ui.synthFilter.year;
                start=new Date(ys.value,0,1); end=new Date(ys.value,11,31); label=`Ann√©e ${ys.value}`;
            } 
            else if(mode==='month') {
                ms.classList.remove('hidden');
                ms.value = APP.ui.synthFilter.month;
                const [y,m] = ms.value.split('-');
                start=new Date(y,m-1,1); end=new Date(y,m,0); label=new Date(y,m-1,1).toLocaleDateString('fr-FR',{month:'long', year:'numeric'});
            }
            else if(mode==='custom') {
                cs.classList.remove('hidden');
                document.getElementById('synth-start').value = APP.ui.synthFilter.start;
                document.getElementById('synth-end').value = APP.ui.synthFilter.end;
                start=new Date(APP.ui.synthFilter.start); end=new Date(APP.ui.synthFilter.end);
                label=`P√©riode personnalis√©e`;
            }

            let tk=0, tc=0, tm=0;
            allKeys.forEach(k => {
                const d = new Date(k);
                if(start && d<start) return;
                if(end && d>end) return;
                const v = APP.db.computedDays[k];
                tk+=v.kwh; tc+=v.cost; tm+=v.m3;
            });

            document.getElementById('disp-m3').innerText = tm.toLocaleString('fr-FR',{maximumFractionDigits:1}) + ' m¬≥';
            document.getElementById('disp-kwh').innerText = Math.round(tk).toLocaleString()+' kWh';
            document.getElementById('disp-cost').innerText = tc.toLocaleString('fr-FR',{style:'currency',currency:'EUR'});
            document.getElementById('disp-cost-ht').innerText = 'HT: ' + (tc/1.2).toLocaleString('fr-FR',{style:'currency',currency:'EUR'});
            lLabel.innerText = label;
        }

        function updateSynth() {
            APP.ui.synthFilter.year = document.getElementById('synth-year-select').value;
            APP.ui.synthFilter.month = document.getElementById('synth-month-select').value;
            APP.ui.synthFilter.start = document.getElementById('synth-start').value;
            APP.ui.synthFilter.end = document.getElementById('synth-end').value;
            renderSynth();
        }
        function setSynth(m) { APP.ui.synthMode = m; renderSynth(); }

        function renderChart() {
            const c = document.getElementById('chart-container'); c.innerHTML='';
            const isDay = APP.ui.chartMode === 'day';
            const btnDay = document.getElementById('btn-chart-day'); const btnMonth = document.getElementById('btn-chart-month');
            if(isDay) { btnDay.classList.add('bg-indigo-600','text-white'); btnDay.classList.remove('text-gray-400'); btnMonth.classList.remove('bg-indigo-600','text-white'); } 
            else { btnMonth.classList.add('bg-indigo-600','text-white'); btnMonth.classList.remove('text-gray-400'); btnDay.classList.remove('bg-indigo-600','text-white'); }
            const btnCost = document.getElementById('btn-view-cost'); const btnKwh = document.getElementById('btn-view-kwh');
            if(APP.ui.view==='cost') { btnCost.classList.add('bg-emerald-600','text-white'); btnCost.classList.remove('text-gray-400'); btnKwh.classList.remove('bg-emerald-600','text-white'); }
            else { btnKwh.classList.add('bg-emerald-600','text-white'); btnKwh.classList.remove('text-gray-400'); btnCost.classList.remove('bg-emerald-600','text-white'); }

            let data={}, max=0, keys=[];
            
            if(isDay) {
                const y = APP.ui.calDate.getFullYear(), m = APP.ui.calDate.getMonth();
                const dim = new Date(y,m+1,0).getDate();
                document.getElementById('chart-title').innerText = "√âvolution " + new Date(y,m,1).toLocaleDateString('fr-FR',{month:'long', year:'numeric'});
                max = APP.limits.maxD;
                for(let d=1; d<=dim; d++) {
                    const k = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    const v = APP.db.computedDays[k];
                    data[k] = { label:d, val: v ? (APP.ui.view==='kwh'?v.kwh:v.cost) : 0, type: v?.type };
                    keys.push(k);
                }
                keys.sort(); // Ensure chronological sort
            } else {
                document.getElementById('chart-title').innerText = "√âvolution Annuelle";
                max = APP.limits.maxM;
                keys = Object.keys(APP.db.monthly).sort();
                keys.forEach(k => {
                    const v = APP.db.monthly[k];
                    const [yy,mm] = k.split('-');
                    data[k] = { label: `${mm}/${yy.slice(2)}`, val: APP.ui.view==='kwh'?v.kwh:v.cost, type: 'mixed' };
                });
            }

            if(keys.length===0 || max===0) { document.getElementById('chart-empty').classList.remove('hidden'); return; }
            document.getElementById('chart-empty').classList.add('hidden');

            keys.forEach(k => {
                const item = data[k];
                const pct = (item.val/max)*100;
                const el = document.createElement('div');
                el.className = `bar-wrapper ${item.type||'estimated'} ${keys.length>30?'dense':''}`;
                el.setAttribute('data-tooltip', `${item.label}: ${item.val.toLocaleString('fr-FR',{maximumFractionDigits:1})} ${APP.ui.view==='cost'?'‚Ç¨':'kWh'}`);
                el.innerHTML = `<div class="bar" style="height:${Math.max(4, pct)}%"></div><div class="bar-label">${item.label}</div>`;
                c.appendChild(el);
            });
        }

        function renderCal() {
            const g = document.getElementById('cal-grid'); g.innerHTML='';
            const y = APP.ui.calDate.getFullYear(), m = APP.ui.calDate.getMonth();
            document.getElementById('cal-title').innerText = new Date(y,m,1).toLocaleDateString('fr-FR',{month:'long', year:'numeric'});
            const fd = new Date(y,m,1).getDay()||7, dim = new Date(y,m+1,0).getDate();
            for(let i=1; i<fd; i++) g.appendChild(document.createElement('div'));
            for(let d=1; d<=dim; d++) {
                const k = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const v = APP.db.computedDays[k];
                const c = document.createElement('div'); c.className = "day-cell";
                if(v) {
                    c.classList.add('has-data');
                    const val = APP.ui.view==='kwh'?v.kwh:v.cost;
                    const r = APP.limits.maxD>0 ? val/APP.limits.maxD : 0;
                    let bg = 'rgba(255,255,255,0.05)';
                    if(val>0) { if(r<0.25) bg='rgba(6, 78, 59, 0.6)'; else if(r<0.5) bg='rgba(113, 63, 18, 0.6)'; else if(r<0.75) bg='rgba(124, 45, 18, 0.6)'; else bg='rgba(127, 29, 29, 0.6)'; }
                    c.style.backgroundColor = bg;
                    if(v.type==='real') c.innerHTML += `<div class="marker-dot bg-real"></div>`;
                    c.innerHTML += `<span class="font-bold text-white z-10">${d}</span><div class="z-10 day-val text-gray-200 font-mono">${Math.round(val)}</div>`;
                    c.title = `${k}\n${v.type==='real'?'R√©el':'Estim√©'}\n${val.toFixed(2)}`;
                } else { c.innerHTML = `<span class="text-gray-600">${d}</span>`; }
                g.appendChild(c);
            }
        }

        function renderHist() {
            const b = document.getElementById('hist-body'); b.innerHTML='';
            [...APP.db.indexes].reverse().forEach(r => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-white/5 transition";
                const d = new Date(r.date).toLocaleDateString('fr-FR', {day: '2-digit', month: '2-digit', year: '2-digit'});
                const cost = r.costPeriod ? `<span class="text-emerald-400 font-bold">${r.costPeriod.toFixed(2)} ‚Ç¨</span>` : '<span class="text-gray-600">-</span>';
                tr.innerHTML = `<td class="px-4 py-3 text-gray-300 font-medium">${d}</td><td class="px-4 py-3 text-right font-mono text-white">${r.index}</td><td class="px-4 py-3 text-right">${cost}</td><td class="px-2 py-3 text-center"><button onclick="delIndex(${r.id})" class="p-1 text-red-400 hover:text-red-300 hover:bg-red-400/10 rounded">√ó</button></td>`;
                b.appendChild(tr);
            });
        }

        function addManualIndex(e, m) {
            e.preventDefault(); const s = m==='mobile'?'-mobile':'-desktop';
            const d = document.getElementById('date'+s).value;
            const v = parseFloat(document.getElementById('index'+s).value);
            if(!d || isNaN(v)) return;
            if(APP.db.indexes.some(x=>x.date===d)) return alert("Date existe");
            APP.db.indexes.push({ id: Date.now(), date: d, index: v });
            saveDB(); recalc();
            document.getElementById('index'+s).value='';
            if(m==='mobile') document.getElementById('mob-modal').classList.add('hidden');
        }
        function delIndex(id) { if(confirm("Supprimer ?")) { APP.db.indexes = APP.db.indexes.filter(x=>x.id!==id); saveDB(); recalc(); } }
        function resetAll() { if(confirm("TOUT SUPPRIMER ?")) { localStorage.removeItem('gaz_db_final_v5'); APP.db.indexes=[]; APP.db.realDays={}; recalc(); } }
        function moveCal(d) { APP.ui.calDate.setMonth(APP.ui.calDate.getMonth()+d); renderCal(); if(APP.ui.chartMode==='day') renderChart(); }
        function setView(v) { APP.ui.view=v; renderChart(); renderCal(); }
        function setChart(m) { APP.ui.chartMode=m; renderChart(); }
        function openMob() { initInputs(); document.getElementById('mob-modal').classList.remove('hidden'); }
        function getParams() { return { kwh: parseFloat(document.getElementById('p-kwh').value)||0.0777, abo: parseFloat(document.getElementById('p-abo').value)||16.72, coef: parseFloat(document.getElementById('p-coef').value)||11.36, tva1: (parseFloat(document.getElementById('p-tva1').value)||20)/100, tva2: (parseFloat(document.getElementById('p-tva2').value)||5.5)/100 }; }
    </script>
</body>
</html>

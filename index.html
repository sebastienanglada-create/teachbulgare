<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suivi Gaz - Dashboard Ultimate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        dark: { 950: '#0a0a0f', 900: '#121218', 800: '#1a1a24', 700: '#242432' },
                        accent: { blue: '#3b82f6', purple: '#8b5cf6', green: '#10b981' }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #0a0a0f; color: #e5e7eb; background-image: radial-gradient(circle at top center, #1a1a24 0%, #0a0a0f 100%); background-attachment: fixed; }

        /* UI Components */
        .dashboard-card {
            background-image: linear-gradient(145deg, rgba(30, 30, 40, 0.8) 0%, rgba(20, 20, 30, 0.8) 100%);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1.25rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .input-field {
            background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.1); color: white;
            padding: 0.75rem 1rem; border-radius: 0.75rem; width: 100%; transition: all 0.2s;
        }
        .input-field:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); outline: none; }
        input[type="datetime-local"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }

        .btn-neon-primary {
            background: linear-gradient(135deg, #3b82f6, #6366f1); color: white; font-weight: 600;
            padding: 0.75rem 1.5rem; border-radius: 0.75rem; transition: all 0.2s;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3); border: none;
        }
        .btn-neon-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4); }
        
        .btn-glass {
            background: rgba(255, 255, 255, 0.05); color: #d1d5db; font-weight: 500;
            padding: 0.6rem 1.2rem; border-radius: 0.75rem; border: 1px solid rgba(255, 255, 255, 0.1); transition: all 0.2s;
        }
        .btn-glass:hover { background: rgba(255, 255, 255, 0.1); color: white; border-color: rgba(255, 255, 255, 0.2); }

        /* Tabs */
        .tab-group { background: rgba(0,0,0,0.3); padding: 0.25rem; border-radius: 0.75rem; display: inline-flex; flex-wrap: wrap; gap: 4px; }
        .tab-btn { padding: 0.5rem 1rem; font-size: 0.75rem; font-weight: 600; border-radius: 0.6rem; color: #9ca3af; transition: all 0.2s; flex: 1; text-align: center; min-width: 60px; }
        .tab-btn.active-blue { background: #3b82f6; color: white; box-shadow: 0 2px 10px rgba(59, 130, 246, 0.3); }
        .tab-btn.active-indigo { background: #6366f1; color: white; box-shadow: 0 2px 10px rgba(99, 102, 241, 0.3); }
        .tab-btn.active-emerald { background: #10b981; color: white; box-shadow: 0 2px 10px rgba(16, 185, 129, 0.3); }
        .tab-btn:hover:not([class*="active"]) { color: white; background: rgba(255,255,255,0.05); }

        /* Graphique */
        .bar-container { display: flex; align-items: flex-end; justify-content: space-between; height: 240px; gap: 2px; padding-top: 25px; }
        .bar-wrapper { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; height: 100%; position: relative; min-width: 4px; }
        .bar { width: 100%; border-radius: 4px 4px 0 0; transition: height 0.5s cubic-bezier(0.4, 0, 0.2, 1); min-height: 2px; position: relative; overflow: hidden; }
        .bar::after { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 40%; background: linear-gradient(to bottom, rgba(255,255,255,0.3), transparent); }
        
        .bar-wrapper:hover .bar { filter: brightness(1.2); transform: scaleX(1.1); z-index: 10; }
        .bar-wrapper:hover::after {
            content: attr(data-tooltip); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
            background: rgba(10, 10, 15, 0.95); color: white; padding: 8px 12px; border-radius: 10px; font-size: 0.75rem; font-weight: 700;
            white-space: pre; z-index: 50; border: 1px solid rgba(255,255,255,0.15); pointer-events: none; margin-bottom: 10px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.5); backdrop-filter: blur(8px);
        }
        .bar-label { font-size: 0.6rem; color: #6b7280; margin-top: 8px; text-align: center; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 600; }
        .bar-wrapper.dense:nth-child(odd) .bar-label { display: none; }
        @media (min-width: 768px) { .bar-wrapper.dense:nth-child(odd) .bar-label { display: block; } }

        /* Couleurs Graph */
        .real .bar { background: linear-gradient(to top, #059669, #10b981); box-shadow: 0 0 15px rgba(16, 185, 129, 0.3); }
        .estimated .bar { background: linear-gradient(to top, #6366f1, #8b5cf6); box-shadow: 0 0 15px rgba(139, 92, 246, 0.3); }
        .mixed .bar { background: linear-gradient(to top, #2563eb, #3b82f6); box-shadow: 0 0 15px rgba(59, 130, 246, 0.3); }

        /* Calendrier */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
        .day-cell { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-radius: 12px; background-color: rgba(255,255,255,0.03); font-size: 0.75rem; position: relative; border: 1px solid transparent; transition: all 0.2s; }
        .day-cell.has-data:hover { transform: scale(1.15); z-index: 10; border-color: rgba(255,255,255,0.3); box-shadow: 0 8px 25px rgba(0,0,0,0.5); background-color: #1a1a24; }
        .intensity-bar { width: 60%; height: 3px; background: rgba(255,255,255,0.1); border-radius: 2px; margin-top: 4px; overflow: hidden; }
        .intensity-fill { height: 100%; border-radius: 2px; }
        .marker-dot { position: absolute; top: 5px; right: 5px; width: 6px; height: 6px; border-radius: 50%; box-shadow: 0 0 8px currentColor;}
        .bg-real { background-color: #10b981; color: #10b981; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }

        @media print {
            .print-hidden { display: none !important; }
            body { background: white !important; color: black !important; background-image: none !important; }
            .dashboard-card { background: white !important; border: 1px solid #ccc !important; box-shadow: none !important; backdrop-filter: none !important; }
            .bar { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; box-shadow: none !important; }
        }

        .fab { position: fixed; bottom: 2rem; right: 2rem; width: 4rem; height: 4rem; border-radius: 50%; background: linear-gradient(135deg, #3b82f6, #6366f1); color: white; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4); z-index: 50; transition: transform 0.2s; }
        .fab:active { transform: scale(0.95); }
        @media (min-width: 1024px) { .fab { display: none; } }
        .hidden { display: none; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8 pb-32">

    <div class="max-w-[1400px] mx-auto grid grid-cols-1 lg:grid-cols-[340px_1fr] gap-8">

        <!-- === SIDEBAR (GAUCHE) === -->
        <aside class="space-y-6">
            <!-- Titre -->
            <div class="dashboard-card p-6 text-center lg:text-left print-hidden">
                <h1 class="text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-violet-400 mb-3">Suivi Gaz <span class="text-white">Pro</span></h1>
                <div class="flex flex-wrap justify-center lg:justify-start gap-3 text-xs font-medium text-gray-400">
                    <span class="flex items-center px-2 py-1 rounded-full bg-emerald-500/10 border border-emerald-500/20"><span class="w-2 h-2 rounded-full bg-emerald-500 mr-2 shadow-[0_0_6px_#10b981]"></span> R√©el (GRDF)</span>
                    <span class="flex items-center px-2 py-1 rounded-full bg-violet-500/10 border border-violet-500/20"><span class="w-2 h-2 rounded-full bg-violet-500 mr-2 shadow-[0_0_6px_#8b5cf6]"></span> Estim√©</span>
                </div>
            </div>

            <!-- Actions -->
            <section class="dashboard-card p-6 print-hidden space-y-3">
                <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4">Donn√©es & Actions</h3>
                <button onclick="document.getElementById('file-input').click()" class="btn-neon-primary w-full flex items-center justify-center gap-2 text-sm">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
                    Importer GRDF / Backup
                </button>
                <input type="file" id="file-input" class="hidden" accept=".csv,.json,.txt" onchange="handleImport(this)" multiple>
                
                <div class="grid grid-cols-2 gap-3 pt-2">
                    <button onclick="exportData()" class="btn-glass flex items-center justify-center gap-2 text-sm">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/></svg>
                        Sauvegarder
                    </button>
                    <button onclick="window.print()" class="btn-glass flex items-center justify-center gap-2 text-sm">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/></svg>
                        Imprimer
                    </button>
                </div>
            </section>

            <!-- Saisie Manuelle -->
            <section class="dashboard-card p-6 print-hidden hidden lg:block relative overflow-hidden">
                <div class="absolute -top-6 -right-6 text-8xl opacity-5 rotate-12">üìù</div>
                <h2 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4 relative z-10">Ajouter un Index</h2>
                <form onsubmit="addManualIndex(event, 'desktop')" class="space-y-4 relative z-10">
                    <div><label class="text-xs text-gray-500 mb-1.5 block font-semibold ml-1">Date</label><input type="datetime-local" id="date-desktop" required class="input-field text-sm"></div>
                    <div><label class="text-xs text-gray-500 mb-1.5 block font-semibold ml-1">Index (m¬≥)</label><input type="number" id="index-desktop" step="0.001" required placeholder="Ex: 5488" class="input-field font-mono text-sm"></div>
                    <button type="submit" class="btn-neon-primary w-full py-3 text-sm">Enregistrer l'index</button>
                </form>
            </section>

            <!-- Param√®tres -->
            <section class="dashboard-card print-hidden overflow-hidden">
                <button onclick="document.getElementById('params-box').classList.toggle('hidden')" class="w-full p-5 flex justify-between items-center hover:bg-white/5 transition group">
                    <span class="text-sm font-bold text-gray-300 group-hover:text-white flex items-center gap-3">
                        <span class="p-1.5 bg-gray-800 rounded-lg"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.942-3.313-.823-2.308-2.368a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.942-1.543.823-3.313 2.368-2.308a1.724 1.724 0 002.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg></span>
                        Param√®tres Facture
                    </span>
                    <svg class="w-5 h-5 text-gray-500 group-hover:text-white transition" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                </button>
                <div id="params-box" class="hidden px-5 pb-6 pt-2 border-t border-white/5 space-y-4 bg-black/10">
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-[0.65rem] uppercase text-gray-500 font-bold mb-1 block ml-1">Prix kWh HT</label><input id="p-kwh" type="number" step="0.0001" value="0.0777" onchange="recalc()" class="input-field text-xs font-mono text-indigo-300"></div>
                        <div><label class="text-[0.65rem] uppercase text-gray-500 font-bold mb-1 block ml-1">Abo/Mois HT</label><input id="p-abo" type="number" step="0.01" value="16.72" onchange="recalc()" class="input-field text-xs font-mono text-indigo-300"></div>
                        <div><label class="text-[0.65rem] uppercase text-gray-500 font-bold mb-1 block ml-1">TVA Conso %</label><input id="p-tva1" type="number" step="0.1" value="20" onchange="recalc()" class="input-field text-xs font-mono text-indigo-300"></div>
                        <div><label class="text-[0.65rem] uppercase text-gray-500 font-bold mb-1 block ml-1">TVA Abo %</label><input id="p-tva2" type="number" step="0.1" value="5.5" onchange="recalc()" class="input-field text-xs font-mono text-indigo-300"></div>
                        <div class="col-span-2"><label class="text-[0.65rem] uppercase text-gray-500 font-bold mb-1 block ml-1">Coef. Conv.</label><input id="p-coef" type="number" step="0.01" value="11.36" onchange="recalc()" class="input-field text-xs font-mono text-indigo-300"></div>
                    </div>
                </div>
            </section>
        </aside>

        <!-- === MAIN CONTENT (DROITE) === -->
        <main class="space-y-8">

            <!-- SECTION 1: SYNTH√àSE -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Contr√¥les -->
                <div class="dashboard-card p-6 md:col-span-3 lg:col-span-1 flex flex-col justify-between">
                    <div>
                        <h2 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><span class="text-xl">üìÖ</span> P√©riode</h2>
                        <div class="tab-group w-full mb-4">
                            <button onclick="setSynth('global')" id="btn-sy-global" class="tab-btn active-indigo flex-1 text-center">Global</button>
                            <button onclick="setSynth('year')" id="btn-sy-year" class="tab-btn flex-1 text-center">Ann√©e</button>
                            <button onclick="setSynth('month')" id="btn-sy-month" class="tab-btn flex-1 text-center">Mois</button>
                            <button onclick="setSynth('custom')" id="btn-sy-custom" class="tab-btn flex-1 text-center">Perso</button>
                        </div>
                        <div id="synth-controls" class="hidden space-y-3">
                            <select id="synth-year-select" onchange="updateSynth()" class="input-field text-sm hidden"></select>
                            <input type="month" id="synth-month-select" onchange="updateSynth()" class="input-field text-sm hidden">
                            <div id="synth-custom-range" class="hidden flex gap-2">
                                <input type="date" id="synth-start" onchange="updateSynth()" class="input-field text-sm w-full">
                                <input type="date" id="synth-end" onchange="updateSynth()" class="input-field text-sm w-full">
                            </div>
                        </div>
                    </div>
                    <div class="text-xs text-center text-gray-500 italic mt-4 pt-3 border-t border-white/5" id="synth-label">Chargement...</div>
                </div>

                <!-- Stats Volume -->
                <div class="dashboard-card p-6 relative overflow-hidden group">
                    <div class="absolute -right-6 -top-6 w-24 h-24 bg-blue-500/10 rounded-full blur-3xl group-hover:bg-blue-500/20 transition-all duration-500"></div>
                    <div class="relative z-10">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="p-2 bg-blue-500/20 rounded-lg"><svg class="w-5 h-5 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/></svg></div>
                            <h3 class="text-sm font-bold text-blue-300 uppercase tracking-wider">Volume</h3>
                        </div>
                        <div class="text-3xl font-extrabold text-white tracking-tight" id="disp-m3">0 <span class="text-lg font-semibold text-gray-400">m¬≥</span></div>
                        <div class="text-sm text-blue-300/70 font-mono mt-2 flex items-center gap-1"><svg class="w-4 h-4 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg><span id="disp-kwh">0 kWh</span></div>
                    </div>
                </div>

                <!-- Stats Co√ªt -->
                <div class="dashboard-card p-6 relative overflow-hidden group">
                    <div class="absolute -right-6 -top-6 w-24 h-24 bg-emerald-500/10 rounded-full blur-3xl group-hover:bg-emerald-500/20 transition-all duration-500"></div>
                    <div class="relative z-10">
                         <div class="flex items-center gap-3 mb-3">
                            <div class="p-2 bg-emerald-500/20 rounded-lg"><svg class="w-5 h-5 text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div>
                            <h3 class="text-sm font-bold text-emerald-300 uppercase tracking-wider">Co√ªt TTC</h3>
                        </div>
                        <div class="text-3xl font-extrabold text-white tracking-tight" id="disp-cost">0 ‚Ç¨</div>
                        <div class="text-sm text-emerald-300/70 font-mono mt-2">HT: <span id="disp-cost-ht">0 ‚Ç¨</span></div>
                    </div>
                </div>
            </div>

            <!-- SECTION 2: GRAPHIQUE -->
            <section class="dashboard-card p-6">
                <div class="flex flex-wrap gap-4 justify-between items-center mb-8 pb-4 border-b border-white/5">
                    <h2 class="text-2xl font-bold text-white flex items-center gap-3">
                        <div class="p-2 bg-indigo-500/20 rounded-lg"><svg class="w-6 h-6 text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg></div>
                        <span id="chart-title">√âvolution</span>
                    </h2>
                    <div class="flex gap-4">
                        <div class="tab-group"><button onclick="setChart('day')" id="btn-chart-day" class="tab-btn active-indigo">Jour</button><button onclick="setChart('month')" id="btn-chart-month" class="tab-btn">Mois</button></div>
                        <div class="tab-group"><button onclick="setView('cost')" id="btn-view-cost" class="tab-btn active-emerald">Co√ªt</button><button onclick="setView('kwh')" id="btn-view-kwh" class="tab-btn">kWh</button></div>
                    </div>
                </div>
                <div id="chart-container" class="bar-container px-2"></div>
                <div id="chart-empty" class="hidden h-64 flex items-center justify-center text-gray-500 italic">Aucune donn√©e</div>
            </section>

            <!-- SECTION 3: CALENDRIER & HISTO -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- CALENDRIER -->
                <section class="dashboard-card p-6">
                    <div class="flex justify-between items-center mb-6 pb-4 border-b border-white/5">
                        <h2 class="text-xl font-bold text-white flex items-center gap-3">
                             <div class="p-2 bg-violet-500/20 rounded-lg"><svg class="w-6 h-6 text-violet-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg></div>
                            Calendrier
                        </h2>
                        <div class="flex items-center gap-2 bg-black/20 rounded-lg p-1">
                            <button onclick="moveCal(-1)" class="p-2 hover:bg-white/10 rounded-md transition text-gray-400 hover:text-white"><svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg></button>
                            <h2 class="text-sm font-bold text-white capitalize w-32 text-center tracking-wide" id="cal-title">--</h2>
                            <button onclick="moveCal(1)" class="p-2 hover:bg-white/10 rounded-md transition text-gray-400 hover:text-white"><svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></button>
                        </div>
                    </div>
                    <div class="calendar-grid mb-3 text-center text-[0.65rem] text-gray-500 font-bold uppercase tracking-widest"><div>Lun</div><div>Mar</div><div>Mer</div><div>Jeu</div><div>Ven</div><div>Sam</div><div>Dim</div></div>
                    <div id="cal-grid" class="calendar-grid gap-2"></div>
                </section>

                <!-- HISTORIQUE -->
                <section class="dashboard-card p-6 flex flex-col max-h-[500px]">
                    <div class="flex justify-between items-center mb-4 pb-4 border-b border-white/5">
                        <h2 class="text-xl font-bold text-white flex items-center gap-3">
                            <div class="p-2 bg-gray-700/50 rounded-lg"><svg class="w-6 h-6 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/></svg></div>
                            Historique Index
                        </h2>
                    </div>
                    <div class="overflow-y-auto flex-1 -mx-4 px-4">
                        <table class="w-full text-left text-sm text-gray-400">
                            <thead class="text-xs uppercase bg-black/20 text-gray-500 sticky top-0 backdrop-blur-md z-10">
                                <tr><th class="px-4 py-3 font-bold rounded-tl-lg">Date</th><th class="px-4 py-3 text-right font-bold">Index</th><th class="px-4 py-3 text-right font-bold">Co√ªt P√©riode</th><th class="px-4 py-3 text-center font-bold rounded-tr-lg"></th></tr>
                            </thead>
                            <tbody id="hist-body" class="divide-y divide-gray-800/50"></tbody>
                        </table>
                    </div>
                </section>
            </div>
            
            <!-- Reset -->
            <div class="flex justify-center pt-4 print-hidden col-span-full opacity-50 hover:opacity-100 transition">
                <button onclick="resetAll()" class="text-sm text-red-400/70 hover:text-red-400 transition flex items-center gap-2 px-4 py-2 rounded-lg hover:bg-red-500/10">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg> R√©initialiser
                </button>
            </div>
        </main>
    </div>

    <!-- MOBILE MODAL -->
    <div id="mob-modal" class="fixed inset-0 bg-black/90 backdrop-blur-md z-50 hidden flex items-center justify-center p-6" onclick="if(event.target===this)this.classList.add('hidden')">
        <div class="dashboard-card w-full max-w-sm p-8 shadow-2xl relative overflow-hidden">
             <div class="absolute top-0 right-0 p-4 opacity-10 text-8xl text-blue-500 -rotate-12 pointer-events-none">üìù</div>
            <h2 class="text-2xl font-bold text-white mb-8 flex items-center gap-3 relative z-10">
                 <div class="p-2 bg-blue-500/20 rounded-lg"><svg class="w-6 h-6 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg></div> Ajouter Index
            </h2>
            <form onsubmit="addManualIndex(event, 'mobile')" class="space-y-6 relative z-10">
                <div><label class="text-sm text-gray-400 mb-2 block font-medium ml-1">Date</label><input type="datetime-local" id="date-mobile" required class="input-field text-lg"></div>
                <div><label class="text-sm text-gray-400 mb-2 block font-medium ml-1">Index (m¬≥)</label><input type="number" id="index-mobile" step="0.001" required placeholder="Ex: 5488" class="input-field text-lg font-mono"></div>
                <button class="w-full btn-neon-primary py-4 text-lg shadow-lg mt-4">Sauvegarder</button>
            </form>
        </div>
    </div>
    <button onclick="openMob()" class="fab print-hidden flex lg:hidden group"><svg class="w-8 h-8 group-active:rotate-90 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg></button>

    <!-- SCRIPT -->
    <script>
        // --- STATE ---
        const APP = {
            db: { indexes: [], realDays: {}, computedDays: {}, monthly: {} },
            ui: { view: 'cost', chartMode: 'day', synthMode: 'global', synthFilter: {}, calDate: new Date() },
            limits: { maxD: 1, maxM: 1 }
        };

        document.addEventListener('DOMContentLoaded', () => { initInputs(); loadDB(); recalc(); });

        function initInputs() {
            const now = new Date(); now.setMinutes(now.getMinutes()-now.getTimezoneOffset()); const iso = now.toISOString().slice(0,16);
            if(document.getElementById('date-desktop')) document.getElementById('date-desktop').value = iso;
            if(document.getElementById('date-mobile')) document.getElementById('date-mobile').value = iso;
            
            const y = new Date().getFullYear(), m = new Date().toISOString().slice(0,7);
            APP.ui.synthFilter = { year: y, month: m, start: `${y}-01-01`, end: new Date().toISOString().slice(0,10) };
        }

        function loadDB() { try { const s = localStorage.getItem('gaz_db_final_v5'); if(s) { const d = JSON.parse(s); APP.db.indexes = d.indexes||[]; APP.db.realDays = d.realDays||{}; } } catch(e) { console.error(e); } }
        function saveDB() { localStorage.setItem('gaz_db_final_v5', JSON.stringify({ indexes: APP.db.indexes, realDays: APP.db.realDays })); }

        // --- IMPORT ---
        function handleImport(input) {
            const f = input.files[0]; if(!f) return;
            const r = new FileReader();
            r.onload = (e) => {
                const txt = e.target.result; let cR=0, cI=0;
                try {
                    if(f.name.endsWith('.json')||txt.trim().startsWith('{')) {
                        const j = JSON.parse(txt); if(j.indexes) APP.db.indexes=j.indexes; if(j.realDays) APP.db.realDays=j.realDays; alert("Restaur√© !");
                    } else {
                        const lines = txt.split(/\r?\n/);
                        let headIdx=0, type='unknown';
                        for(let i=0; i<Math.min(20, lines.length); i++) {
                            const l = lines[i].toLowerCase();
                            if(l.includes('date') && l.includes('consommation')) { headIdx=i; type='daily'; break; }
                            if(l.includes('date') && l.includes('index')) { headIdx=i; type='index'; break; }
                        }
                        if(type==='unknown') throw new Error("Format inconnu");

                        for(let i=headIdx+1; i<lines.length; i++) {
                            const cl = lines[i].replace(/"/g,'').trim(); if(!cl || !/\d/.test(cl)) continue;
                            let p = cl.split(';'); if(p.length<2) p=cl.split(','); if(p.length<2) continue;

                            let dk = null; const dRaw = p[0].trim();
                            if(dRaw.match(/^\d{2}\/\d{2}\/\d{4}$/)) { const[d,m,y]=dRaw.split('/'); dk=`${y}-${m}-${d}`; }
                            else if(dRaw.match(/^\d{4}-\d{2}-\d{2}/)) { dk=dRaw.split(' ')[0]; }
                            if(!dk) continue;

                            if(type==='daily') {
                                let v = p[1]; if(isNaN(parseFloat(v.replace(',','.'))) && p[2]) v=p[2];
                                const m3 = parseFloat(v.replace(',','.'));
                                let cf = 11.2; if(p[2] && !isNaN(parseFloat(p[2].replace(',','.')))) cf=parseFloat(p[2].replace(',','.'));
                                else if(p[3] && !isNaN(parseFloat(p[3].replace(',','.')))) cf=parseFloat(p[3].replace(',','.'));
                                if(!isNaN(m3)) { APP.db.realDays[dk] = { m3, kwh: m3*cf }; cR++; }
                            } else {
                                let v = p[1]; if(isNaN(parseFloat(v.replace(',','.'))) && p[2]) v=p[2];
                                const idx = parseFloat(v.replace(',','.'));
                                if(!isNaN(idx) && idx>10) {
                                    if(!APP.db.indexes.some(x=>x.date.startsWith(dk))) {
                                        APP.db.indexes.push({id:Date.now()+Math.random(), date:dk+"T12:00", index: idx}); cI++;
                                    }
                                }
                            }
                        }
                        alert(`Import√©: ${cR} jours r√©els, ${cI} index.`);
                    }
                    saveDB(); recalc();
                } catch(err) { alert("Erreur: "+err.message); }
                input.value = '';
            };
            r.readAsText(f);
        }

        function exportData() {
            const b = new Blob([JSON.stringify({indexes: APP.db.indexes, realDays: APP.db.realDays})], {type:'application/json'});
            const u = URL.createObjectURL(b);
            const a = document.createElement('a'); a.href=u; a.download=`backup_gaz_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }

        // --- CALCULATION ---
        function recalc() {
            const P = getParams();
            APP.db.computedDays = {}; APP.db.monthly = {}; APP.limits.maxD = 0; APP.limits.maxM = 0;

            // 1. Real Data
            for(const [k,v] of Object.entries(APP.db.realDays)) {
                const costHT = v.kwh * P.kwh;
                const costTTC = (costHT*(1+P.tva1)) + ((P.abo*12/365)*(1+P.tva2));
                APP.db.computedDays[k] = { ...v, cost: costTTC, type: 'real' };
            }

            // 2. Index Filling
            APP.db.indexes.sort((a,b) => new Date(a.date) - new Date(b.date));
            for(let i=1; i<APP.db.indexes.length; i++) {
                const p = APP.db.indexes[i-1], c = APP.db.indexes[i];
                const d1 = new Date(p.date), d2 = new Date(c.date);
                const days = Math.ceil((d2-d1)/(86400000));

                // Cost Period Calculation for History Table
                const deltaM3 = c.index - p.index;
                if(deltaM3 >= 0) {
                    const kwhP = deltaM3 * P.coef;
                    const costP = (kwhP * P.kwh * (1+P.tva1)) + (P.abo * (days/30.5) * (1+P.tva2));
                    c.costPeriod = costP;
                } else continue;

                if(days<=0) continue;
                const totKwh = deltaM3 * P.coef;
                let realKwh = 0, missing = [];

                for(let j=0; j<days; j++) {
                    const d = new Date(d1); d.setDate(d.getDate()+j);
                    const k = d.toISOString().slice(0,10);
                    if(APP.db.computedDays[k] && APP.db.computedDays[k].type==='real') realKwh += APP.db.computedDays[k].kwh;
                    else missing.push(k);
                }

                if(missing.length > 0) {
                    const remKwh = Math.max(0, totKwh - realKwh);
                    const estDay = remKwh / missing.length;
                    const estM3 = (deltaM3 - (realKwh/P.coef)) / missing.length;
                    const costDay = (estDay * P.kwh * (1+P.tva1)) + ((P.abo*12/365)*(1+P.tva2));
                    missing.forEach(k => { if(!APP.db.computedDays[k]) APP.db.computedDays[k] = { kwh: estDay, m3: Math.max(0,estM3), cost: costDay, type: 'estimated' }; });
                }
            }

            // 3. Aggregate
            for(const [k,v] of Object.entries(APP.db.computedDays)) {
                const m = k.slice(0,7);
                if(!APP.db.monthly[m]) APP.db.monthly[m] = { kwh:0, cost:0, m3:0 };
                APP.db.monthly[m].kwh += v.kwh; APP.db.monthly[m].cost += v.cost; APP.db.monthly[m].m3 += v.m3;
                const val = APP.ui.view==='kwh'?v.kwh:v.cost;
                if(val>APP.limits.maxD) APP.limits.maxD = val;
            }
            for(const v of Object.values(APP.db.monthly)) {
                const val = APP.ui.view==='kwh'?v.kwh:v.cost;
                if(val>APP.limits.maxM) APP.limits.maxM = val;
            }
            renderAll();
        }

        function renderAll() { renderSynth(); renderChart(); renderCal(); renderHist(); }

        // --- RENDERERS ---
        function renderSynth() {
            const mode = APP.ui.synthMode;
            const f = document.getElementById('synth-controls');
            const ys = document.getElementById('synth-year-select');
            const ms = document.getElementById('synth-month-select');
            const cs = document.getElementById('synth-custom-range');
            const lLabel = document.getElementById('synth-label');

            ['global','year','month','custom'].forEach(m => {
                const b = document.getElementById('btn-sy-'+m);
                if(m===mode) { b.classList.add('active-indigo'); } else { b.classList.remove('active-indigo'); }
            });

            f.classList.add('hidden'); ys.classList.add('hidden'); ms.classList.add('hidden'); cs.classList.add('hidden');
            if(mode !== 'global') f.classList.remove('hidden');

            let start=null, end=null, label="Donn√©es Globales";
            const allKeys = Object.keys(APP.db.computedDays).sort();

            if(mode==='year') {
                ys.classList.remove('hidden');
                const years = [...new Set(allKeys.map(k=>k.slice(0,4)))].sort().reverse();
                if(years.length===0) years.push(new Date().getFullYear());
                if(ys.options.length !== years.length) { ys.innerHTML=''; years.forEach(y=>ys.add(new Option(y,y))); }
                if(!years.includes(APP.ui.synthFilter.year.toString())) APP.ui.synthFilter.year = years[0];
                ys.value = APP.ui.synthFilter.year;
                start=new Date(ys.value,0,1); end=new Date(ys.value,11,31); label=`Ann√©e ${ys.value}`;
            } 
            else if(mode==='month') {
                ms.classList.remove('hidden');
                ms.value = APP.ui.synthFilter.month;
                const [y,m] = ms.value.split('-');
                start=new Date(y,m-1,1); end=new Date(y,m,0); label=new Date(y,m-1,1).toLocaleDateString('fr-FR',{month:'long', year:'numeric'});
            }
            else if(mode==='custom') {
                cs.classList.remove('hidden');
                document.getElementById('synth-start').value = APP.ui.synthFilter.start;
                document.getElementById('synth-end').value = APP.ui.synthFilter.end;
                start=new Date(APP.ui.synthFilter.start); end=new Date(APP.ui.synthFilter.end);
                label=`P√©riode personnalis√©e`;
            }

            let tk=0, tc=0, tm=0;
            allKeys.forEach(k => {
                const d = new Date(k);
                if(start && d<start) return;
                if(end && d>end) return;
                const v = APP.db.computedDays[k];
                tk+=v.kwh; tc+=v.cost; tm+=v.m3;
            });

            document.getElementById('disp-m3').innerText = tm.toLocaleString('fr-FR',{maximumFractionDigits:1});
            document.getElementById('disp-kwh').innerText = Math.round(tk).toLocaleString()+' kWh';
            document.getElementById('disp-cost').innerText = tc.toLocaleString('fr-FR',{style:'currency',currency:'EUR'});
            document.getElementById('disp-cost-ht').innerText = 'HT: ' + (tc/1.2).toLocaleString('fr-FR',{style:'currency',currency:'EUR'});
            lLabel.innerText = label;
        }

        function updateSynth() {
            APP.ui.synthFilter.year = document.getElementById('synth-year-select').value;
            APP.ui.synthFilter.month = document.getElementById('synth-month-select').value;
            APP.ui.synthFilter.start = document.getElementById('synth-start').value;
            APP.ui.synthFilter.end = document.getElementById('synth-end').value;
            renderSynth();
        }
        function setSynth(m) { APP.ui.synthMode = m; renderSynth(); }

        function renderChart() {
            const c = document.getElementById('chart-container'); c.innerHTML='';
            const isDay = APP.ui.chartMode === 'day';
            const btnDay = document.getElementById('btn-chart-day'); const btnMonth = document.getElementById('btn-chart-month');
            if(isDay) { btnDay.classList.add('active-indigo'); btnMonth.classList.remove('active-indigo'); } else { btnMonth.classList.add('active-indigo'); btnDay.classList.remove('active-indigo'); }
            const btnCost = document.getElementById('btn-view-cost'); const btnKwh = document.getElementById('btn-view-kwh');
            if(APP.ui.view==='cost') { btnCost.classList.add('active-emerald'); btnKwh.classList.remove('active-emerald'); } else { btnKwh.classList.add('active-emerald'); btnCost.classList.remove('active-emerald'); }

            let data={}, max=0, keys=[];
            
            if(isDay) {
                const y = APP.ui.calDate.getFullYear(), m = APP.ui.calDate.getMonth();
                const dim = new Date(y,m+1,0).getDate();
                document.getElementById('chart-title').innerText = "√âvolution " + new Date(y,m,1).toLocaleDateString('fr-FR',{month:'long', year:'numeric'});
                max = APP.limits.maxD;
                for(let d=1; d<=dim; d++) {
                    const k = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    const v = APP.db.computedDays[k];
                    data[k] = { label:d, val: v ? (APP.ui.view==='kwh'?v.kwh:v.cost) : 0, type: v?.type };
                    keys.push(k);
                }
            } else {
                document.getElementById('chart-title').innerText = "√âvolution Annuelle";
                max = APP.limits.maxM;
                keys = Object.keys(APP.db.monthly).sort();
                keys.forEach(k => {
                    const v = APP.db.monthly[k];
                    const [yy,mm] = k.split('-');
                    data[k] = { label: `${mm}/${yy.slice(2)}`, val: APP.ui.view==='kwh'?v.kwh:v.cost, type: 'mixed' };
                });
            }

            if(keys.length===0 || max===0) { document.getElementById('chart-empty').classList.remove('hidden'); return; }
            document.getElementById('chart-empty').classList.add('hidden');

            keys.forEach(k => {
                const item = data[k];
                const pct = (item.val/max)*100;
                const el = document.createElement('div');
                el.className = `bar-wrapper ${item.type||'estimated'} ${keys.length>30?'dense':''}`;
                el.setAttribute('data-tooltip', `${item.label}: ${item.val.toLocaleString('fr-FR',{maximumFractionDigits:1})} ${APP.ui.view==='cost'?'‚Ç¨':'kWh'}`);
                el.innerHTML = `<div class="bar" style="height:${Math.max(4, pct)}%"></div><div class="bar-label">${item.label}</div>`;
                c.appendChild(el);
            });
        }

        function renderCal() {
            const g = document.getElementById('cal-grid'); g.innerHTML='';
            const y = APP.ui.calDate.getFullYear(), m = APP.ui.calDate.getMonth();
            document.getElementById('cal-title').innerText = new Date(y,m,1).toLocaleDateString('fr-FR',{month:'long', year:'numeric'});
            const fd = new Date(y,m,1).getDay()||7, dim = new Date(y,m+1,0).getDate();
            for(let i=1; i<fd; i++) g.appendChild(document.createElement('div'));
            for(let d=1; d<=dim; d++) {
                const k = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const v = APP.db.computedDays[k];
                const c = document.createElement('div'); c.className = "day-cell";
                if(v) {
                    c.classList.add('has-data');
                    const val = APP.ui.view==='kwh'?v.kwh:v.cost;
                    const r = APP.limits.maxD>0 ? val/APP.limits.maxD : 0;
                    let bg = 'rgba(255,255,255,0.05)';
                    if(val>0) { if(r<0.25) bg='rgba(6, 78, 59, 0.6)'; else if(r<0.5) bg='rgba(113, 63, 18, 0.6)'; else if(r<0.75) bg='rgba(124, 45, 18, 0.6)'; else bg='rgba(127, 29, 29, 0.6)'; }
                    c.style.backgroundColor = bg;
                    if(v.type==='real') c.innerHTML += `<div class="marker-dot bg-real"></div>`;
                    c.innerHTML += `<span class="font-bold text-white z-10">${d}</span><div class="z-10 day-val text-gray-200 font-mono">${Math.round(val)}</div>`;
                    c.title = `${k}\n${v.type==='real'?'R√©el':'Estim√©'}\n${val.toFixed(2)}`;
                } else { c.innerHTML = `<span class="text-gray-600">${d}</span>`; }
                g.appendChild(c);
            }
        }

        function renderHist() {
            const b = document.getElementById('hist-body'); b.innerHTML='';
            [...APP.db.indexes].reverse().forEach(r => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-white/5 transition";
                const d = new Date(r.date).toLocaleDateString('fr-FR', {day: '2-digit', month: '2-digit', year: '2-digit'});
                const cost = r.costPeriod ? `<span class="text-emerald-400 font-bold">${r.costPeriod.toFixed(2)} ‚Ç¨</span>` : '<span class="text-gray-600">-</span>';
                tr.innerHTML = `<td class="px-4 py-3 text-gray-300 font-medium">${d}</td><td class="px-4 py-3 text-right font-mono text-white">${r.index}</td><td class="px-4 py-3 text-right">${cost}</td><td class="px-2 py-3 text-center"><button onclick="delIndex(${r.id})" class="p-1 text-red-400 hover:text-red-300 hover:bg-red-400/10 rounded">√ó</button></td>`;
                b.appendChild(tr);
            });
        }

        function addManualIndex(e, m) {
            e.preventDefault(); const s = m==='mobile'?'-mobile':'-desktop';
            const d = document.getElementById('date'+s).value;
            const v = parseFloat(document.getElementById('index'+s).value);
            if(!d || isNaN(v)) return;
            if(APP.db.indexes.some(x=>x.date===d)) return alert("Date existe");
            APP.db.indexes.push({ id: Date.now(), date: d, index: v });
            saveDB(); recalc();
            document.getElementById('index'+s).value='';
            if(m==='mobile') document.getElementById('mob-modal').classList.add('hidden');
        }
        function delIndex(id) { if(confirm("Supprimer ?")) { APP.db.indexes = APP.db.indexes.filter(x=>x.id!==id); saveDB(); recalc(); } }
        function resetAll() { if(confirm("TOUT SUPPRIMER ?")) { localStorage.removeItem('gaz_db_final_v5'); APP.db.indexes=[]; APP.db.realDays={}; recalc(); } }
        function moveCal(d) { APP.ui.calDate.setMonth(APP.ui.calDate.getMonth()+d); renderCal(); if(APP.ui.chartMode==='day') renderChart(); }
        function setView(v) { APP.ui.view=v; renderChart(); renderCal(); }
        function setChart(m) { APP.ui.chartMode=m; renderChart(); }
        function openMob() { initInputs(); document.getElementById('mob-modal').classList.remove('hidden'); }
        function getParams() { return { kwh: parseFloat(document.getElementById('p-kwh').value)||0.0777, abo: parseFloat(document.getElementById('p-abo').value)||16.72, coef: parseFloat(document.getElementById('p-coef').value)||11.36, tva1: (parseFloat(document.getElementById('p-tva1').value)||20)/100, tva2: (parseFloat(document.getElementById('p-tva2').value)||5.5)/100 }; }
    </script>
</body>
</html>

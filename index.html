<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NÉO-ENERGIE | Terminal de Contrôle</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@200;300;400;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', "Liberation Mono", "Courier New", 'monospace'],
                    },
                    colors: {
                        cyber: {
                            bg: '#05070a',
                            card: '#0f1219',
                            border: '#1e293b',
                            gas: '#06b6d4',   // Cyan for Gas
                            elec: '#f59e0b',  // Amber for Elec
                            text: '#94a3b8'
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #05070a;
            background-image: radial-gradient(circle at 50% 0%, #1e293b 0%, #05070a 70%);
            color: #e2e8f0;
            overflow-x: hidden;
            height: 100dvh;
            max-height: 100dvh;
            touch-action: manipulation; /* Improves touch response */
        }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #05070a; }
        ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #06b6d4; }

        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        .custom-scroll::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 2px; }

        .glass-panel {
            background: rgba(15, 18, 25, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
        }
        
        /* Dynamic Theme Borders based on Energy Mode */
        body[data-mode="gas"] .theme-border { border-color: rgba(6, 182, 212, 0.3); }
        body[data-mode="elec"] .theme-border { border-color: rgba(245, 158, 11, 0.3); }
        
        body[data-mode="gas"] .theme-text { color: #06b6d4; }
        body[data-mode="elec"] .theme-text { color: #f59e0b; }
        
        body[data-mode="gas"] .theme-bg { background-color: #06b6d4; }
        body[data-mode="elec"] .theme-bg { background-color: #f59e0b; }

        body[data-mode="gas"] .theme-shadow { box-shadow: 0 0 10px rgba(6, 182, 212, 0.2); }
        body[data-mode="elec"] .theme-shadow { box-shadow: 0 0 10px rgba(245, 158, 11, 0.2); }

        .hud-input {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
            font-family: 'Outfit', sans-serif;
            transition: all 0.3s ease;
        }
        .hud-input:focus { outline: none; border-color: currentColor; }
        .hud-input.active-input { border-color: #fff; background: rgba(255,255,255,0.05); box-shadow: inset 0 0 10px rgba(0,0,0,0.5); }

        .numpad-btn {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: inherit;
            font-size: 1.25rem;
            font-weight: bold;
            transition: all 0.1s;
            user-select: none;
        }
        .numpad-btn:active { transform: scale(0.95); background: rgba(255, 255, 255, 0.05); }

        .temp-line {
            stroke-dasharray: 2000;
            stroke-dashoffset: 2000;
            animation: drawLine 2.5s ease-out forwards;
            filter: drop-shadow(0 0 3px rgba(249,115,22,0.6));
        }
        @keyframes drawLine { to { stroke-dashoffset: 0; } }

        #mainSidebar { transition: width 0.3s ease; }
        .sidebar-text { transition: opacity 0.2s ease; opacity: 1; }
        .sidebar-collapsed .sidebar-text { opacity: 0; display: none; }
        .sidebar-collapsed .logo-container { justify-content: center; padding-left: 0; }
        .sidebar-collapsed .nav-btn { justify-content: center; }
        .sidebar-collapsed .nav-btn span { display: none; }
        .sidebar-collapsed #sidebarLegend { display: none; }
        .sidebar-collapsed #energySwitcher { flex-direction: column; gap: 10px; }
        
        .weather-btn.active { color: white; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); }
    </style>
</head>
<body class="flex h-[100dvh] overflow-hidden selection:bg-white selection:text-black font-sans" data-mode="gas">

    <!-- SIDEBAR -->
    <aside id="mainSidebar" class="hidden md:flex w-64 flex-col border-r border-cyber-border bg-cyber-bg/95 backdrop-blur z-20 relative theme-border">
        <div class="h-16 flex items-center justify-start px-6 border-b border-cyber-border logo-container transition-all theme-border">
            <div class="w-8 h-8 rounded bg-white/5 border border-white/10 flex items-center justify-center theme-shadow shrink-0">
                <i data-lucide="zap" class="w-5 h-5 theme-text"></i>
            </div>
            <span class="ml-3 font-bold tracking-widest theme-text sidebar-text whitespace-nowrap">
                NÉO-ENERGIE
            </span>
        </div>

        <!-- Energy Switcher -->
        <div class="p-4 border-b border-cyber-border theme-border">
            <div id="energySwitcher" class="flex bg-black/40 rounded-lg p-1 border border-white/5">
                <button onclick="switchMode('gas')" class="flex-1 py-2 rounded-md text-xs font-bold uppercase transition-all flex items-center justify-center gap-2 mode-btn" id="btn-gas">
                    <i data-lucide="flame" class="w-4 h-4"></i> <span class="sidebar-text">Gaz</span>
                </button>
                <button onclick="switchMode('elec')" class="flex-1 py-2 rounded-md text-xs font-bold uppercase transition-all flex items-center justify-center gap-2 mode-btn" id="btn-elec">
                    <i data-lucide="zap" class="w-4 h-4"></i> <span class="sidebar-text">Élec</span>
                </button>
            </div>
        </div>

        <nav class="flex-1 py-6 space-y-2 px-2">
            <button onclick="openModule()" class="nav-btn w-full flex items-center justify-start p-3 rounded-lg bg-white/5 border border-white/10 theme-text hover:bg-white/10 theme-shadow transition-all group whitespace-nowrap">
                <i data-lucide="plus-square" class="w-6 h-6 shrink-0"></i>
                <span class="ml-3 font-semibold sidebar-text">Saisie / Import</span>
            </button>
            
            <div class="h-px bg-cyber-border my-4 mx-2"></div>

            <div id="sidebarLegend" class="px-4 py-2">
                <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3 whitespace-nowrap">Légende</h3>
                <div class="space-y-3">
                    <div class="flex items-center gap-3">
                        <div class="w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.8)] shrink-0"></div>
                        <span class="text-xs text-gray-400">Réel (Relevé/Import)</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="w-2 h-2 rounded-full theme-bg theme-shadow shrink-0"></div>
                        <span class="text-xs text-gray-400">Estimé (Calculé)</span>
                    </div>
                    <div class="flex items-center gap-3 mt-2 pt-2 border-t border-gray-800">
                        <div class="w-2 h-0.5 bg-orange-500 shadow-[0_0_8px_rgba(249,115,22,0.8)] shrink-0"></div>
                        <span class="text-xs text-gray-400">Température</span>
                    </div>
                </div>
            </div>
        </nav>

        <button onclick="toggleSidebar()" class="absolute bottom-4 right-[-12px] md:static md:w-full md:p-4 flex justify-end md:justify-center text-gray-500 hover:text-white transition-colors focus:outline-none">
            <i id="collapseIcon" data-lucide="chevrons-left" class="w-5 h-5"></i>
        </button>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col h-full overflow-hidden relative">
        <!-- Header -->
        <header class="h-auto md:h-16 py-2 border-b border-cyber-border bg-cyber-bg/80 backdrop-blur flex flex-wrap items-center justify-between px-4 md:px-8 z-10 gap-2 shrink-0 theme-border">
            <div class="md:hidden flex items-center gap-2">
                 <div class="w-8 h-8 rounded bg-white/5 border border-white/10 flex items-center justify-center"><i data-lucide="activity" class="w-4 h-4 theme-text"></i></div>
                 <h1 class="text-lg font-bold text-gray-200">NÉO-<span class="theme-text" id="mobileTitle">GAZ</span></h1>
            </div>

            <div class="flex flex-wrap items-center gap-2 ml-auto">
                <div class="flex bg-cyber-card rounded-lg p-1 border border-cyber-border">
                    <button onclick="setFilter('global')" class="filter-btn px-3 py-1 text-xs rounded transition-all text-gray-400 hover:text-white" data-period="global">Global</button>
                    <button onclick="setFilter('year')" class="filter-btn px-3 py-1 text-xs rounded text-gray-400 hover:text-white transition-all" data-period="year">Année</button>
                    <button onclick="setFilter('month')" class="filter-btn px-3 py-1 text-xs rounded transition-all text-white theme-bg active-filter" data-period="month">Mois</button>
                </div>
                
                <div id="dateNavigator" class="hidden flex items-center gap-1 border border-cyber-border rounded-lg p-1 bg-cyber-card">
                     <button onclick="changePeriod(-1)" class="p-1 theme-text hover:text-white transition-colors"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                     <span id="currentPeriodLabel" class="text-xs font-mono theme-text min-w-[80px] text-center">...</span>
                     <button onclick="changePeriod(1)" class="p-1 theme-text hover:text-white transition-colors"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                </div>
            </div>
        </header>

        <!-- Dashboard Content -->
        <div class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 pb-40 md:pb-12 scroll-smooth custom-scroll">
            
            <!-- KPIs -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="glass-panel rounded-xl p-4 relative overflow-hidden group theme-border">
                    <div class="absolute -right-4 -top-4 opacity-10 group-hover:opacity-20 transition-opacity">
                        <i data-lucide="zap" class="w-24 h-24 theme-text"></i>
                    </div>
                    <p class="text-[10px] theme-text uppercase tracking-widest mb-1">Conso Totale</p>
                    <h2 class="text-2xl md:text-3xl font-bold text-white font-mono" id="kpiKwh">0</h2>
                    <p class="text-xs text-gray-500 mt-1">kWh</p>
                </div>

                <div class="glass-panel rounded-xl p-4 relative overflow-hidden group theme-border">
                    <div class="absolute -right-4 -top-4 opacity-10 group-hover:opacity-20 transition-opacity">
                        <i data-lucide="euro" class="w-24 h-24 text-emerald-500"></i>
                    </div>
                    <p class="text-[10px] text-emerald-400 uppercase tracking-widest mb-1">Coût Estimé</p>
                    <h2 class="text-2xl md:text-3xl font-bold text-white font-mono" id="kpiCost">0 <span class="text-sm">€</span></h2>
                    <p class="text-xs text-gray-500 mt-1">TTC (Abo. inclus)</p>
                </div>

                <div class="glass-panel rounded-xl p-4 relative overflow-hidden group theme-border">
                    <div class="absolute -right-4 -top-4 opacity-10 group-hover:opacity-20 transition-opacity">
                        <i data-lucide="bar-chart-3" class="w-24 h-24 text-violet-500"></i>
                    </div>
                    <p class="text-[10px] text-violet-400 uppercase tracking-widest mb-1">Moyenne Jour</p>
                    <h2 class="text-2xl md:text-3xl font-bold text-white font-mono" id="kpiAvg">0</h2>
                    <p class="text-xs text-gray-500 mt-1">kWh / Jour</p>
               </div>
               
               <div class="glass-panel rounded-xl p-4 relative overflow-hidden group border-dashed border-gray-700">
                   <div class="absolute -right-4 -top-4 opacity-10 group-hover:opacity-20 transition-opacity">
                        <i data-lucide="thermometer" class="w-24 h-24 text-orange-500"></i>
                    </div>
                    <p class="text-[10px] text-orange-400 uppercase tracking-widest mb-1">Temp. Moy.</p>
                    <h2 class="text-2xl md:text-3xl font-bold text-white font-mono" id="kpiAvgTemp">--°C</h2>
                    <p class="text-xs text-gray-500 mt-1">Extérieur</p>
                </div>
            </div>

            <!-- Main Chart -->
            <div class="glass-panel rounded-xl p-6 theme-border">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-sm font-bold text-white flex items-center gap-2 uppercase tracking-wider">
                        <i data-lucide="activity" class="w-4 h-4 theme-text"></i>
                        Flux & Météo
                    </h3>
                    <div class="flex bg-cyber-bg rounded p-0.5 border border-cyber-border">
                         <button onclick="setChartMode('kwh')" class="chart-mode-btn px-3 py-1 text-[10px] rounded hover:text-white transition-all active-chart-mode theme-bg" data-mode="kwh">kWh</button>
                         <button onclick="setChartMode('cost')" class="chart-mode-btn px-3 py-1 text-[10px] rounded text-gray-400 hover:text-white transition-all" data-mode="cost">€</button>
                    </div>
                </div>
                <div class="relative h-64 w-full" id="chartContainer">
                    <div class="absolute inset-0 flex items-center justify-center text-gray-600 text-sm animate-pulse">En attente de données...</div>
                </div>
                <div class="relative h-6 w-full mt-2" id="chartLabels"></div>
            </div>

            <!-- Heatmap & History -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 glass-panel rounded-xl p-6 relative theme-border">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-sm font-bold text-white flex items-center gap-2 uppercase tracking-wider">
                            <i data-lucide="layout-grid" class="w-4 h-4 text-violet-400"></i>
                            Matrice Temporelle
                        </h3>
                        <div class="flex gap-3">
                            <div class="flex items-center gap-1.5">
                                <div class="w-2 h-2 rounded-sm bg-emerald-500/80 shadow-[0_0_5px_rgba(16,185,129,0.5)]"></div>
                                <span class="text-[9px] text-gray-500 uppercase tracking-wider font-bold">Réel</span>
                            </div>
                            <div class="flex items-center gap-1.5">
                                <div class="w-2 h-2 rounded-sm theme-bg theme-shadow"></div>
                                <span class="text-[9px] text-gray-500 uppercase tracking-wider font-bold">Estimé</span>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-7 gap-1 md:gap-2 mb-2">
                        <div class="text-center text-[10px] text-gray-500">L</div>
                        <div class="text-center text-[10px] text-gray-500">M</div>
                        <div class="text-center text-[10px] text-gray-500">M</div>
                        <div class="text-center text-[10px] text-gray-500">J</div>
                        <div class="text-center text-[10px] text-gray-500">V</div>
                        <div class="text-center text-[10px] text-gray-500">S</div>
                        <div class="text-center text-[10px] text-gray-500">D</div>
                    </div>
                    <div id="heatmapGrid" class="grid grid-cols-7 gap-1 md:gap-2"></div>
                </div>

                <div class="glass-panel rounded-xl p-0 overflow-hidden flex flex-col h-full max-h-[400px] theme-border">
                    <div class="p-4 border-b border-gray-800 bg-black/20">
                        <h3 class="text-sm font-bold text-white flex items-center gap-2 uppercase tracking-wider">
                            <i data-lucide="database" class="w-4 h-4 text-emerald-400"></i>
                            Logs Index
                        </h3>
                    </div>
                    <div class="overflow-y-auto flex-1 p-2 space-y-1 custom-scroll" id="historyList"></div>
                </div>
            </div>
            
            <div class="h-10 md:hidden"></div>
        </div>
    </main>

    <!-- FAB -->
    <button onclick="openModule()" class="md:hidden fixed bottom-6 right-6 w-14 h-14 theme-bg rounded-full flex items-center justify-center theme-shadow z-40 hover:scale-110 transition-transform border border-white/20">
        <i data-lucide="plus" class="w-6 h-6 text-white"></i>
    </button>

    <!-- HUD MODAL -->
    <div id="hudOverlay" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 transition-opacity duration-300 opacity-0">
        <div id="hudContent" class="hud-border bg-[#0a0c10] w-full max-w-2xl rounded-xl shadow-2xl overflow-hidden transform scale-95 transition-transform duration-300 relative flex flex-col max-h-[95dvh] theme-border">
            <div class="p-4 md:p-6 border-b border-gray-800 text-center relative overflow-hidden shrink-0">
                <button onclick="closeModule()" class="absolute top-4 right-4 theme-text hover:text-white z-10"><i data-lucide="x" class="w-6 h-6"></i></button>
                <h2 class="text-lg md:text-xl font-bold text-white tracking-[0.2em] uppercase theme-text">Entrée Manuelle</h2>
                <p class="text-[10px] text-gray-500 uppercase mt-1" id="hudSubtitle">Relevé & Météo</p>
            </div>
            <div class="overflow-y-auto custom-scroll">
                <div class="grid grid-cols-1 md:grid-cols-2">
                    <div class="p-4 md:p-6 space-y-4 md:space-y-6 border-b md:border-b-0 md:border-r border-gray-800 relative">
                        <div class="space-y-2">
                            <label class="text-[10px] theme-text uppercase tracking-wider font-bold block">Date & Heure</label>
                            <div class="flex gap-2">
                                <div class="relative flex-1"><input type="date" id="hudDate" class="hud-input w-full px-3 py-2 rounded text-center text-sm md:text-base cursor-pointer"></div>
                                <div class="relative w-24 md:w-28"><input type="time" id="hudTime" class="hud-input w-full px-2 py-2 rounded text-center text-sm md:text-base cursor-pointer"></div>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <label class="text-[10px] theme-text uppercase tracking-wider font-bold block" id="hudIndexLabel">Index Compteur</label>
                            <div class="relative">
                                <input type="number" id="hudIndex" step="0.001" placeholder="00000.0" class="hud-input w-full px-4 py-3 rounded-lg text-xl md:text-2xl font-mono theme-text tracking-widest text-center" onfocus="setActiveInput('hudIndex')" readonly>
                                <div class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-600 text-xs" id="hudUnit">m³</div>
                            </div>
                        </div>
                        <div class="space-y-2 pt-2 border-t border-gray-800">
                            <label class="text-[10px] text-orange-500 uppercase tracking-wider font-bold block">Conditions Météo</label>
                            <div class="flex gap-2 items-center">
                                 <div class="relative w-24">
                                    <input type="number" id="hudTemp" placeholder="°C" class="hud-input w-full px-2 py-2 rounded text-center text-orange-400 font-bold" onfocus="setActiveInput('hudTemp')" readonly>
                                    <span class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-600 text-xs">°C</span>
                                 </div>
                                 <div class="flex-1 flex justify-between gap-1" id="weatherIcons">
                                     <button type="button" class="weather-btn p-2 rounded text-gray-400 hover:text-yellow-400" data-weather="sun" onclick="selectWeather('sun')"><i data-lucide="sun" class="w-5 h-5"></i></button>
                                     <button type="button" class="weather-btn p-2 rounded text-gray-400 hover:text-gray-200" data-weather="cloud" onclick="selectWeather('cloud')"><i data-lucide="cloud" class="w-5 h-5"></i></button>
                                     <button type="button" class="weather-btn p-2 rounded text-gray-400 hover:text-blue-400" data-weather="rain" onclick="selectWeather('rain')"><i data-lucide="cloud-rain" class="w-5 h-5"></i></button>
                                     <button type="button" class="weather-btn p-2 rounded text-gray-400 hover:text-white" data-weather="snow" onclick="selectWeather('snow')"><i data-lucide="snowflake" class="w-5 h-5"></i></button>
                                 </div>
                            </div>
                        </div>
                    </div>
                    <div class="p-4 md:p-6 bg-[#050608]">
                        <div class="grid grid-cols-3 gap-2 md:gap-3 h-full">
                            <button onclick="numpadPress('1')" class="numpad-btn rounded py-3 theme-text">1</button><button onclick="numpadPress('2')" class="numpad-btn rounded py-3 theme-text">2</button><button onclick="numpadPress('3')" class="numpad-btn rounded py-3 theme-text">3</button>
                            <button onclick="numpadPress('4')" class="numpad-btn rounded py-3 theme-text">4</button><button onclick="numpadPress('5')" class="numpad-btn rounded py-3 theme-text">5</button><button onclick="numpadPress('6')" class="numpad-btn rounded py-3 theme-text">6</button>
                            <button onclick="numpadPress('7')" class="numpad-btn rounded py-3 theme-text">7</button><button onclick="numpadPress('8')" class="numpad-btn rounded py-3 theme-text">8</button><button onclick="numpadPress('9')" class="numpad-btn rounded py-3 theme-text">9</button>
                            <button onclick="numpadPress('.')" class="numpad-btn rounded text-2xl py-3 theme-text">.</button><button onclick="numpadPress('0')" class="numpad-btn rounded py-3 theme-text">0</button><button onclick="numpadPress('DEL')" class="numpad-btn rounded text-red-400 border-red-900/30 hover:bg-red-900/20 py-3"><i data-lucide="delete" class="w-6 h-6 mx-auto"></i></button>
                            <button onclick="numpadPress('-')" class="numpad-btn rounded text-orange-400 border-orange-900/30 text-xs md:text-sm py-2 md:py-0 col-span-3 mt-2">NEGATIF (Temp)</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-[#0f1219] border-t border-gray-800 flex flex-col md:flex-row items-center justify-between gap-4 shrink-0">
                <div class="flex gap-2 w-full md:w-auto">
                    <button onclick="document.getElementById('fileImport').click()" class="flex-1 md:flex-none px-3 py-2 rounded border border-gray-700 hover:border-white text-xs text-gray-400 hover:text-white transition-colors flex items-center justify-center gap-1"><i data-lucide="upload" class="w-3 h-3"></i> Import</button>
                    <button onclick="exportData()" class="flex-1 md:flex-none px-3 py-2 rounded border border-gray-700 hover:border-violet-500 text-xs text-gray-400 hover:text-violet-400 transition-colors flex items-center justify-center gap-1"><i data-lucide="save" class="w-3 h-3"></i> Sauvegarder</button>
                    <button onclick="fetchWeatherData()" class="px-3 py-2 rounded border border-gray-700 hover:border-orange-500 text-orange-400 transition-colors" title="Sync Météo" id="weatherSyncBtn"><i data-lucide="cloud-lightning" class="w-4 h-4"></i></button>
                    <button onclick="toggleSettings()" class="px-3 py-2 rounded border border-gray-700 hover:border-gray-500 text-gray-400 transition-colors"><i data-lucide="settings" class="w-4 h-4"></i></button>
                </div>
                <button onclick="submitHudForm()" class="w-full md:w-auto px-8 py-3 text-white font-bold tracking-wider rounded shadow-lg transition-all transform hover:scale-[1.02] theme-bg theme-shadow">VALIDER</button>
            </div>
            <input type="file" id="fileImport" class="hidden" accept=".json,.csv">
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div id="settingsOverlay" class="fixed inset-0 bg-black/90 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity duration-300">
        <div class="glass-panel p-6 rounded-xl w-full max-w-sm border border-gray-800 bg-[#0a0c10] shadow-2xl relative theme-border transform transition-transform">
             <div class="flex justify-between items-center mb-6">
                <h3 class="text-white font-bold uppercase tracking-wider text-sm flex items-center gap-2"><i data-lucide="settings" class="w-4 h-4 theme-text"></i> Configuration <span id="confMode" class="text-xs text-gray-500">(Gaz)</span></h3>
                <button onclick="toggleSettings()" class="text-gray-500 hover:text-white transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
             </div>
             <div class="space-y-4">
                <div><label class="text-[10px] theme-text uppercase tracking-wider font-bold mb-1 block">Prix kWh HT (€)</label><input type="number" id="setPrice" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white focus:border-white focus:outline-none transition-colors"></div>
                <div><label class="text-[10px] theme-text uppercase tracking-wider font-bold mb-1 block">Abonnement Annuel HT (€)</label><input type="number" id="setSub" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white focus:border-white focus:outline-none transition-colors"></div>
                <div id="coefContainer"><label class="text-[10px] theme-text uppercase tracking-wider font-bold mb-1 block">Coef. Conversion (m³ -> kWh)</label><input type="number" id="setCoef" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white focus:border-white focus:outline-none transition-colors"></div>
                <div class="grid grid-cols-2 gap-2 pt-2 border-t border-gray-800">
                    <div><label class="text-[10px] text-gray-500 uppercase tracking-wider font-bold mb-1 block">Latitude</label><input type="number" id="setLat" step="0.0001" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white text-xs"></div>
                    <div><label class="text-[10px] text-gray-500 uppercase tracking-wider font-bold mb-1 block">Longitude</label><input type="number" id="setLon" step="0.0001" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white text-xs"></div>
                </div>
                <button onclick="saveSettings()" class="w-full text-white font-bold py-3 rounded shadow-lg mt-2 transition-all tracking-wider text-sm theme-bg theme-shadow">ENREGISTRER</button>
                <div class="pt-4 mt-4 border-t border-gray-800">
                    <button onclick="resetData()" class="w-full py-3 rounded border border-red-900/50 text-red-500 hover:bg-red-900/20 hover:border-red-500 flex items-center justify-center gap-2 transition-all group"><i data-lucide="trash-2" class="w-4 h-4 group-hover:animate-bounce"></i><span class="font-bold text-xs uppercase tracking-widest">EFFACER TOUTES LES DONNÉES</span></button>
                </div>
             </div>
        </div>
    </div>

    <script>
        // --- DATA STRUCTURE ---
        const DEFAULT_SETTINGS_GAS = { kwhPrice: 0.1045, subscription: 245.50, tva: 0.20, conversionCoef: 11.2 };
        const DEFAULT_SETTINGS_ELEC = { kwhPrice: 0.2276, subscription: 150.00, tva: 0.20, conversionCoef: 1 }; // 1 for Elec
        const LOC_SETTINGS = { lat: 48.8566, lon: 2.3522 };

        let state = {
            mode: 'gas', // 'gas' or 'elec'
            gas: { settings: {...DEFAULT_SETTINGS_GAS}, readings: [], importedData: {}, computed: [] },
            elec: { settings: {...DEFAULT_SETTINGS_ELEC}, readings: [], importedData: {}, computed: [] },
            dailyWeather: {}, // Shared
            ui: { periodFilter: 'month', currentDate: new Date(), chartMode: 'kwh' },
            loc: {...LOC_SETTINGS}
        };

        // --- HUD State ---
        let hudState = { activeInput: 'hudIndex', selectedWeather: null };

        // --- INIT ---
        function init() {
            loadData();
            switchMode(state.mode);
            initDateInputs();
            
            // Sidebar mobile toggle
            window.toggleSidebar = function() {
                const sb = document.getElementById('mainSidebar');
                sb.classList.toggle('w-64');
                sb.classList.toggle('w-0');
                sb.classList.toggle('overflow-hidden'); // Hide content when collapsed
                document.getElementById('collapseIcon').classList.toggle('rotate-180');
            }
            if(window.lucide) lucide.createIcons();
        }

        function initDateInputs() {
            const now = new Date();
            document.getElementById('hudDate').valueAsDate = now;
            document.getElementById('hudTime').value = now.toTimeString().substring(0,5);
        }

        function switchMode(mode) {
            state.mode = mode;
            document.body.setAttribute('data-mode', mode);
            
            // Buttons UI
            document.getElementById('btn-gas').className = `flex-1 py-2 rounded-md text-xs font-bold uppercase transition-all flex items-center justify-center gap-2 mode-btn ${mode==='gas'?'bg-[#06b6d4] text-white shadow-[0_0_10px_rgba(6,182,212,0.5)]':'text-gray-500 hover:text-white'}`;
            document.getElementById('btn-elec').className = `flex-1 py-2 rounded-md text-xs font-bold uppercase transition-all flex items-center justify-center gap-2 mode-btn ${mode==='elec'?'bg-[#f59e0b] text-white shadow-[0_0_10px_rgba(245,158,11,0.5)]':'text-gray-500 hover:text-white'}`;
            
            // Texts
            document.getElementById('mobileTitle').innerText = mode === 'gas' ? 'GAZ' : 'ELEC';
            document.getElementById('hudUnit').innerText = mode === 'gas' ? 'm³' : 'kWh';
            document.getElementById('hudIndexLabel').innerText = `Index Compteur (${mode === 'gas' ? 'm³' : 'kWh'})`;
            
            // Settings Inputs
            const s = state[mode].settings;
            document.getElementById('setPrice').value = s.kwhPrice;
            document.getElementById('setSub').value = s.subscription;
            document.getElementById('setCoef').value = s.conversionCoef;
            document.getElementById('coefContainer').style.display = mode === 'gas' ? 'block' : 'none';
            document.getElementById('confMode').innerText = mode === 'gas' ? '(Gaz)' : '(Élec)';
            document.getElementById('setLat').value = state.loc.lat;
            document.getElementById('setLon').value = state.loc.lon;

            // Jump to last date
            const readings = state[mode].readings;
            if (readings.length > 0) {
                const last = readings[readings.length-1];
                if(last) state.ui.currentDate = new Date(last.date);
            }

            recalcEngine();
            if(window.lucide) lucide.createIcons();
        }

        // --- STORAGE ---
        function loadData() {
            const saved = localStorage.getItem('neogaz_db');
            if(saved) {
                try {
                    const parsed = JSON.parse(saved);
                    // Minimal migration check
                    if(parsed.settings && !parsed.gas) { // Old format
                        state.gas.settings = parsed.settings;
                        state.gas.readings = parsed.readings || [];
                        state.gas.importedData = parsed.importedData || {};
                        state.dailyWeather = parsed.dailyWeather || {};
                    } else {
                        state = parsed;
                    }
                    // Ensure deep structure exists
                    if(!state.elec) state.elec = { settings: {...DEFAULT_SETTINGS_ELEC}, readings: [], importedData: {}, computed: [] };
                    if(!state.loc) state.loc = {...LOC_SETTINGS};
                } catch(e) { console.error("Corrupt data", e); }
            }
        }

        function saveData() {
            localStorage.setItem('neogaz_db', JSON.stringify(state));
        }
        
        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "neo_energie_backup.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function resetData() {
            if(confirm("ATTENTION : Cela va effacer TOUTES vos données (Gaz et Élec). Confirmer ?")) {
                localStorage.removeItem('neogaz_db');
                location.reload();
            }
        }

        // --- CALCULATION ENGINE ---
        function recalcEngine() {
            const mode = state.mode;
            const currentData = state[mode];
            const readings = currentData.readings;
            const imported = currentData.importedData;
            const settings = currentData.settings;
            
            readings.sort((a, b) => new Date(a.date + 'T' + (a.time || '00:00')) - new Date(b.date + 'T' + (b.time || '00:00')));
            
            const dailyMap = new Map(); 
            
            // 1. Process Imported Daily Data (Orphaned)
            Object.keys(imported).forEach(date => {
                const t = state.dailyWeather[date] ? state.dailyWeather[date].temp : null;
                dailyMap.set(date, { val: imported[date], type: 'real', temp: t });
            });

            // 2. Process Readings Intervals
            for (let i = 0; i < readings.length - 1; i++) {
                const start = readings[i];
                const end = readings[i+1];
                const dStart = new Date(start.date);
                const dEnd = new Date(end.date);
                
                // Value difference
                let delta = end.value - start.value;
                if(delta < 0) delta = 0; // Prevent negative if meter loop or error

                // Same day reading?
                if (start.date === end.date) {
                    // Update only if no imported data exists for this day, or accumulate? 
                    // Strategy: Readings override everything.
                    // But if multiple readings same day, delta is 0 usually unless consumption.
                    // Let's assume daily map already populated by imports. We just update temp.
                    continue; 
                }

                // Days between
                const days = [];
                let current = new Date(dStart);
                while (current < dEnd) {
                    days.push(current.toISOString().split('T')[0]);
                    current.setDate(current.getDate() + 1);
                }
                if (days.length === 0) continue;

                // Subtract known imported volume from interval total
                let knownVol = 0;
                let knownCount = 0;
                days.forEach(d => { 
                    if (dailyMap.has(d) && dailyMap.get(d).type === 'real') { 
                        knownVol += dailyMap.get(d).val; 
                        knownCount++; 
                    } 
                });

                let remainingVol = delta - knownVol;
                if(remainingVol < 0) remainingVol = 0; // Imported data exceeds meter diff?
                const remainingDays = days.length - knownCount;
                
                // Distribute remainder
                if(remainingDays > 0) {
                    const avg = remainingVol / remainingDays;
                    days.forEach(d => {
                        if (!dailyMap.has(d) || dailyMap.get(d).type !== 'real') {
                            const t = state.dailyWeather[d] ? state.dailyWeather[d].temp : null;
                            dailyMap.set(d, { val: avg, type: 'estimated', temp: t });
                        }
                    });
                }
            }
            
            // Convert to array
            currentData.computed = Array.from(dailyMap.entries()).map(([date, data]) => {
                const m3 = mode === 'gas' ? data.val : 0; // Purely indicative for gas
                // For Elec, data.val is kWh. For Gas, data.val is m3.
                // Final kWh calculation:
                const kwh = mode === 'gas' ? (data.val * settings.conversionCoef) : data.val;
                return { date, m3, kwh, type: data.type, temp: data.temp };
            }).sort((a,b) => new Date(a.date) - new Date(b.date));

            updateUI();
        }

        // --- UI UPDATES ---
        function updateUI() {
            const mode = state.mode;
            const dataFull = state[mode].computed;
            const settings = state[mode].settings;
            
            // Filter
            let data = dataFull;
            const target = state.ui.currentDate;
            const nav = document.getElementById('dateNavigator');
            const periodLabel = document.getElementById('currentPeriodLabel');

            nav.classList.add('hidden');

            if (state.ui.periodFilter === 'year') {
                data = data.filter(d => new Date(d.date).getFullYear() === target.getFullYear());
                periodLabel.innerText = target.getFullYear();
                nav.classList.remove('hidden');
            } else if (state.ui.periodFilter === 'month') {
                const m = target.getMonth(), y = target.getFullYear();
                data = data.filter(d => { const x = new Date(d.date); return x.getMonth() === m && x.getFullYear() === y; });
                periodLabel.innerText = target.toLocaleDateString('fr-FR', {month:'long', year:'numeric'});
                nav.classList.remove('hidden');
            }

            // KPIs
            const tkwh = data.reduce((a, b) => a + b.kwh, 0);
            const days = data.length || 1;
            // Cost: (Conso * Price) + (Sub / 365 * days)
            const energyCost = tkwh * settings.kwhPrice;
            const subCost = (settings.subscription / 365) * days;
            const totalHT = energyCost + subCost;
            const ttc = totalHT * (1 + settings.tva);
            
            const avg = tkwh / days;
            const temps = data.filter(d => d.temp !== null && d.temp !== undefined).map(d => d.temp);
            const avgTemp = temps.length > 0 ? (temps.reduce((a,b)=>a+b,0) / temps.length).toFixed(1) : '--';

            document.getElementById('kpiKwh').innerText = Math.round(tkwh).toLocaleString();
            document.getElementById('kpiCost').innerHTML = ttc.toFixed(2) + ' <span class="text-sm">€</span>';
            document.getElementById('kpiAvg').innerText = avg.toFixed(1);
            document.getElementById('kpiAvgTemp').innerText = avgTemp + '°C';
            
            renderChart(data);
            renderHeatmap(data);
            renderHistory();
        }

        // --- RENDERERS ---
        function renderChart(data) {
             const container = document.getElementById('chartContainer');
             const labels = document.getElementById('chartLabels');
             container.innerHTML = ''; labels.innerHTML = '';
             
             if (data.length === 0) { 
                 container.innerHTML = '<div class="absolute inset-0 flex items-center justify-center text-gray-700 text-xs">Pas de données pour cette période</div>'; 
                 return; 
             }

             // Downsample for chart if too many points
             let items = data;
             const isKwh = state.ui.chartMode === 'kwh';
             const settings = state[state.mode].settings;

             const maxVal = Math.max(...items.map(i => isKwh ? i.kwh : (i.kwh * settings.kwhPrice))) || 1;
             
             const barsContainer = document.createElement('div');
             barsContainer.className = "absolute inset-0 flex items-end justify-between w-full h-full gap-[1px]";
             
             // SVG for Temp
             const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
             svg.setAttribute("class", "absolute inset-0 w-full h-full pointer-events-none z-20");
             svg.setAttribute("preserveAspectRatio", "none");
             let points = "";

             items.forEach((item, i) => {
                const val = isKwh ? item.kwh : (item.kwh * settings.kwhPrice);
                const h = (val / maxVal) * 100;
                const isReal = item.type === 'real';
                
                // Dynamic Color
                let bgClass = isReal ? 'bg-emerald-500' : (state.mode === 'gas' ? 'bg-[#06b6d4]' : 'bg-[#f59e0b]');
                
                const el = document.createElement('div');
                el.className = `flex-1 rounded-t-sm ${bgClass} opacity-80 hover:opacity-100 transition-all relative group`;
                el.style.height = `${Math.max(h, 0.5)}%`; 
                
                // Tooltip
                 const dateStr = new Date(item.date).toLocaleDateString('fr-FR');
                 el.innerHTML = `
                    <div class="hidden group-hover:block absolute bottom-full left-1/2 -translate-x-1/2 mb-2 bg-[#0f1219] text-gray-200 text-[10px] p-2 rounded border border-gray-700 whitespace-nowrap z-50 shadow-xl pointer-events-none">
                        <div class="font-bold text-white mb-1 border-b border-gray-800 pb-1">${dateStr}</div>
                        <div class="flex justify-between gap-4">
                            <span>${item.type === 'real' ? 'Relevé' : 'Estimé'}</span>
                            <span class="font-bold text-white">${val.toFixed(2)} ${isKwh ? 'kWh' : '€'}</span>
                        </div>
                        ${item.temp !== null ? `<div class="mt-1 text-orange-400 font-bold text-center pt-1 border-t border-gray-800">${item.temp.toFixed(1)}°C</div>` : ''}
                    </div>`;
                
                barsContainer.appendChild(el);
                
                // Temp Line Points
                if (item.temp !== null && item.temp !== undefined) {
                    const x = (i / (items.length - 1 || 1)) * 100;
                    // Map temp -5°C to 40°C to 0-100% height. Inverted for SVG y.
                    // Let's say range is -10 to 40 (delta 50).
                    const y = 100 - ((item.temp + 10) / 50 * 100); 
                    points += `${x},${y} `;
                }
             });
             container.appendChild(barsContainer);
             
             if(points) {
                const polyline = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
                polyline.setAttribute("points", points);
                polyline.setAttribute("fill", "none");
                polyline.setAttribute("stroke", "#f97316"); // Orange-500
                polyline.setAttribute("stroke-width", "2");
                polyline.setAttribute("vector-effect", "non-scaling-stroke");
                polyline.setAttribute("class", "temp-line");
                svg.setAttribute("viewBox", `0 0 100 100`);
                svg.appendChild(polyline);
                container.appendChild(svg);
             }
        }
        
        function renderHeatmap(data) {
             const grid = document.getElementById("heatmapGrid");
             grid.innerHTML = '';
             
             let target = state.ui.currentDate;
             if(state.ui.periodFilter === 'global') target = new Date(); 
             
             const year = target.getFullYear(); const month = target.getMonth();
             const daysInMonth = new Date(year, month + 1, 0).getDate();
             const startDay = new Date(year, month, 1).getDay(); 
             const offset = startDay === 0 ? 6 : startDay - 1; // Mon=0
             
             for(let i=0; i<offset; i++) grid.innerHTML += '<div></div>';
             
             const relevant = data.filter(d => new Date(d.date).getMonth() === month && new Date(d.date).getFullYear() === year);
             const max = Math.max(...relevant.map(d=>d.kwh), 1);

             for(let d=1; d<=daysInMonth; d++) {
                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const found = relevant.find(x => x.date === dateStr);
                const el = document.createElement('div');
                el.className = "aspect-square rounded flex items-center justify-center text-[9px] text-gray-500 relative group cursor-default transition-transform hover:scale-110 hover:z-10";
                el.innerText = d;
                
                if(found) {
                    const alpha = 0.3 + (found.kwh/max)*0.7;
                    const isReal = found.type === 'real';
                    let col = isReal ? `rgba(16,185,129,${alpha})` : (state.mode==='gas' ? `rgba(6,182,212,${alpha})` : `rgba(245, 158, 11,${alpha})`);
                    
                    el.style.backgroundColor = col; el.style.color = '#fff';
                    const tempHtml = found.temp ? `<span class="text-orange-400 block mt-1 font-bold">${found.temp.toFixed(1)}°</span>` : '';
                    el.innerHTML += `<div class="hidden group-hover:block absolute bottom-full left-1/2 -translate-x-1/2 mb-2 z-30 bg-black p-2 rounded border border-gray-700 whitespace-nowrap shadow-xl"><div class="font-bold text-white text-xs mb-1">${new Date(found.date).toLocaleDateString()}</div><div class="flex flex-col gap-1 text-[10px]"><div class="flex justify-between gap-3"><span class="theme-text font-bold">${found.kwh.toFixed(1)} kWh</span></div>${tempHtml}</div></div>`;
                } else { 
                    el.style.backgroundColor = 'rgba(255,255,255,0.05)'; 
                }
                grid.appendChild(el);
             }
        }
        
        function renderHistory() {
            const histContainer = document.getElementById('historyList');
            histContainer.innerHTML = '';
            const readings = state[state.mode].readings;
            // Display latest first
            const sorted = [...readings].sort((a,b) => new Date(b.date + 'T' + (b.time||'00:00')) - new Date(a.date + 'T' + (a.time||'00:00')));
            
            sorted.forEach((r, i) => {
                let detailsHtml = '';
                // Calculate consumption since previous reading (which is i+1 in descending sort)
                 if (i < sorted.length - 1) {
                    const prev = sorted[i+1];
                    const diffVal = r.value - prev.value;
                    const d1 = new Date(r.date); const d2 = new Date(prev.date);
                    const daysDiff = Math.max(1, Math.ceil(Math.abs(d1 - d2) / (1000 * 60 * 60 * 24)));
                    
                    let unit = state.mode === 'gas' ? 'm³' : 'kWh';
                    
                    if (diffVal >= 0) {
                        detailsHtml = `<div class="text-[10px] text-gray-500 mt-1 flex justify-between border-t border-gray-800 pt-1"><span>Conso: +${diffVal.toFixed(0)} ${unit}</span><span>${daysDiff} jours</span></div>`;
                    }
                }
                
                const unit = state.mode === 'gas' ? 'm³' : 'kWh';
                
                const div = document.createElement('div');
                div.className = "bg-gray-900/50 p-3 rounded border border-gray-800 hover:border-gray-700 transition-colors group";
                div.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-gray-400 font-mono flex flex-col">
                                <span>${new Date(r.date).toLocaleDateString()}</span>
                                <span class="text-[9px] text-gray-600">${r.time || '--:--'}</span>
                            </span>
                            ${r.weather ? `<i data-lucide="${getWeatherIcon(r.weather)}" class="w-3 h-3 text-gray-500"></i>` : ''}
                            ${r.temp ? `<span class="text-[9px] text-orange-400 font-bold">${r.temp}°</span>` : ''}
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-sm font-bold theme-text font-mono">${r.value.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 1})} <span class="text-[10px] text-gray-600">${unit}</span></span>
                            <button onclick="delReading('${r.date}', '${r.time||''}')" class="text-red-900 opacity-0 group-hover:opacity-100 hover:text-red-500 transition-all"><i data-lucide="trash" class="w-3 h-3"></i></button>
                        </div>
                    </div>
                    ${detailsHtml}`;
                histContainer.appendChild(div);
            });
            if(window.lucide) lucide.createIcons();
        }

        // --- HUD / INTERACTION LOGIC ---
        function openModule() {
            document.getElementById('hudOverlay').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('hudOverlay').classList.remove('opacity-0');
                document.getElementById('hudContent').classList.remove('scale-95');
            }, 10);
            setActiveInput('hudIndex'); // Default focus
        }

        function closeModule() {
            document.getElementById('hudOverlay').classList.add('opacity-0');
            document.getElementById('hudContent').classList.add('scale-95');
            setTimeout(() => {
                document.getElementById('hudOverlay').classList.add('hidden');
            }, 300);
            // Clear inputs
            document.getElementById('hudIndex').value = '';
            document.getElementById('hudTemp').value = '';
            selectWeather(null);
        }

        function toggleSettings() {
            const ol = document.getElementById('settingsOverlay');
            if(ol.classList.contains('hidden')) {
                ol.classList.remove('hidden');
                // Fill current loc
                document.getElementById('setLat').value = state.loc.lat;
                document.getElementById('setLon').value = state.loc.lon;
            } else {
                ol.classList.add('hidden');
            }
        }
        
        function saveSettings() {
             const m = state.mode;
             state[m].settings.kwhPrice = parseFloat(document.getElementById('setPrice').value);
             state[m].settings.subscription = parseFloat(document.getElementById('setSub').value);
             state[m].settings.conversionCoef = parseFloat(document.getElementById('setCoef').value);
             
             state.loc.lat = parseFloat(document.getElementById('setLat').value);
             state.loc.lon = parseFloat(document.getElementById('setLon').value);

             saveData();
             recalcEngine();
             toggleSettings();
             alert("Configuration sauvegardée !");
        }

        function setActiveInput(id) {
            if(id === 'none') {
                document.querySelectorAll('.hud-input').forEach(e => e.classList.remove('active-input'));
                hudState.activeInput = null;
                return;
            }
            hudState.activeInput = id;
            document.querySelectorAll('.hud-input').forEach(e => e.classList.remove('active-input'));
            document.getElementById(id).classList.add('active-input');
        }

        function numpadPress(key) {
            if(!hudState.activeInput) return;
            const el = document.getElementById(hudState.activeInput);
            if(key === 'DEL') {
                el.value = el.value.slice(0, -1);
            } else if (key === '-') {
                if(el.value.startsWith('-')) el.value = el.value.substring(1);
                else el.value = '-' + el.value;
            } else {
                el.value += key;
            }
        }

        function selectWeather(w) {
            hudState.selectedWeather = w;
            document.querySelectorAll('.weather-btn').forEach(b => {
                if(b.dataset.weather === w) b.classList.add('active');
                else b.classList.remove('active');
            });
        }
        
        function getWeatherIcon(w) {
            if(w==='sun') return 'sun';
            if(w==='cloud') return 'cloud';
            if(w==='rain') return 'cloud-rain';
            if(w==='snow') return 'snowflake';
            return 'cloud';
        }

        function submitHudForm() {
            const date = document.getElementById('hudDate').value;
            const time = document.getElementById('hudTime').value;
            const idxStr = document.getElementById('hudIndex').value;
            const tempStr = document.getElementById('hudTemp').value;
            
            if(!date || !idxStr) { alert("Date et Index requis."); return; }
            
            const val = parseFloat(idxStr);
            const temp = tempStr ? parseFloat(tempStr) : null;
            
            // Add Reading
            state[state.mode].readings.push({
                date: date,
                time: time || '12:00',
                value: val,
                temp: temp,
                weather: hudState.selectedWeather
            });
            
            // If temp provided, save to dailyWeather too for interpolation
            if(temp !== null) {
                state.dailyWeather[date] = { temp: temp, icon: hudState.selectedWeather };
            }

            saveData();
            recalcEngine();
            closeModule();
        }

        // --- WEATHER FETCH (Open-Meteo) ---
        async function fetchWeatherData() {
            const btn = document.getElementById('weatherSyncBtn');
            btn.classList.add('animate-spin');
            
            try {
                const lat = state.loc.lat;
                const lon = state.loc.lon;
                
                // Fetch last 60 days
                const today = new Date();
                const past = new Date(); past.setDate(today.getDate() - 90);
                const startStr = past.toISOString().split('T')[0];
                const endStr = today.toISOString().split('T')[0];

                const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=temperature_2m_mean&start_date=${startStr}&end_date=${endStr}&timezone=auto`;
                
                const res = await fetch(url);
                const data = await res.json();
                
                if(data.daily && data.daily.time) {
                    let count = 0;
                    data.daily.time.forEach((t, i) => {
                        const temp = data.daily.temperature_2m_mean[i];
                        if(temp !== null) {
                            state.dailyWeather[t] = { temp: temp };
                            count++;
                        }
                    });
                    saveData();
                    recalcEngine();
                    alert(`${count} températures synchronisées avec succès !`);
                }
            } catch(e) {
                console.error(e);
                alert("Erreur de synchronisation météo. Vérifiez votre connexion.");
            } finally {
                btn.classList.remove('animate-spin');
            }
        }

        // --- HELPERS ---
        function setFilter(p){ state.ui.periodFilter = p; updateUI(); updateBtnStyles(); }
        function setChartMode(m){ state.ui.chartMode=m; updateUI(); updateBtnStyles(); }
        function updateBtnStyles() {
            document.querySelectorAll('.filter-btn').forEach(b => {
                b.className = `filter-btn px-3 py-1 text-xs rounded transition-all ${b.dataset.period===state.ui.periodFilter ? 'text-white theme-bg active-filter' : 'text-gray-400 hover:text-white'}`;
            });
             document.querySelectorAll('.chart-mode-btn').forEach(b => {
                b.className = `chart-mode-btn px-3 py-1 text-[10px] rounded transition-all ${b.dataset.mode===state.ui.chartMode ? 'text-white theme-bg' : 'text-gray-400 hover:text-white'}`;
            });
        }
        function changePeriod(d){ 
            const dt = state.ui.currentDate; 
            if(state.ui.periodFilter==='year') dt.setFullYear(dt.getFullYear()+d); 
            else dt.setMonth(dt.getMonth()+d); 
            state.ui.currentDate = new Date(dt); updateUI(); 
        }
        function delReading(d, t) { 
            if(confirm('Supprimer ce relevé ?')) { 
                state[state.mode].readings = state[state.mode].readings.filter(r => !(r.date === d && (r.time||'00:00') === (t||'00:00'))); 
                saveData(); recalcEngine(); 
            } 
        }

        // --- IMPORT CSV LOGIC ---
        document.getElementById('fileImport').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const rawText = e.target.result.replace(/^\uFEFF/, '').replace(/\r\n/g, '\n');
                const mode = state.mode; 
                
                // JSON Check
                try {
                    const json = JSON.parse(rawText);
                    if (json.gas && json.elec) {
                        state = json; 
                        alert("Base de données complète restaurée !");
                        saveData(); recalcEngine(); return;
                    }
                } catch(e){}

                // CSV Parse
                const lines = rawText.split('\n');
                let count = 0;
                let type = 'unknown';

                if (rawText.indexOf("Index (m3)") > -1) type = 'gas_index';
                else if (rawText.indexOf("Date de consommation") > -1 && rawText.indexOf("(m3)") > -1) type = 'gas_daily';
                else if (rawText.indexOf("Index Heures") > -1 || rawText.indexOf("Index (kWh)") > -1) type = 'elec_index'; // Linky
                else if (rawText.indexOf("Date de consommation") > -1 && rawText.indexOf("(kWh)") > -1) type = 'elec_daily';
                
                if(type.startsWith('gas') && mode !== 'gas') { alert("Attention: Fichier Gaz détecté alors que vous êtes en mode Élec."); }
                if(type.startsWith('elec') && mode !== 'elec') { alert("Attention: Fichier Élec détecté alors que vous êtes en mode Gaz."); }

                const currentData = state[mode];
                lines.forEach(line => {
                     const clean = line.trim();
                     if(!clean || clean.startsWith('Année') || clean.startsWith('Date') || clean.startsWith('Période') || clean.startsWith('Identifiant')) return;
                     const parts = clean.split(';');
                     if(parts.length < 2) return;
                     const cols = parts.map(p => p.replace(/"/g, '').trim());
                     
                     // GRDF Daily / ENEDIS Daily
                     if(type.includes('daily')) {
                         const dStr = cols[0];
                         const [d,m,y] = dStr.split(/[-\/]/); // Handle / or -
                         if(!y || y.length !== 4) return;
                         const iso = `${y}-${m}-${d}`;
                         const val = parseFloat(cols[1].replace(/\s/g, '').replace(',', '.'));
                         if(!isNaN(val)) { currentData.importedData[iso] = val; count++; }
                     } 
                     // Indexes (Manual or Export)
                     else if (type.includes('index')) {
                         const dStr = cols[0];
                         const [d,m,y] = dStr.split(/[-\/]/);
                         if(!y) return;
                         const iso = `${y}-${m}-${d}`;
                         let val = 0;
                         if (mode === 'gas') {
                             val = parseFloat(cols[2].replace(/\s/g, '').replace(',', '.'));
                         } else {
                             // Linky simplistic sum
                             for(let k=2; k<cols.length; k++) {
                                 const v = parseFloat(cols[k].replace(/\s/g, ''));
                                 if(!isNaN(v)) val += v;
                             }
                         }
                         if(!isNaN(val) && val > 0) {
                              const exists = currentData.readings.find(r=>r.date === iso);
                              if(exists) exists.value = val;
                              else currentData.readings.push({ date: iso, time: "00:00", value: val });
                              count++;
                         }
                     }
                });
                
                alert(`${count} points de données importés.`);
                saveData(); recalcEngine(); e.target.value = '';
            };
            reader.readAsText(file);
        });

        init();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gaz Tracker | Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'sans-serif'] },
                    colors: {
                        // Palette inspirée de l'image (Dark Interface)
                        app: {
                            bg: '#0B0E14',       // Fond principal très sombre
                            card: '#151A25',     // Fond des cartes
                            cardHover: '#1C2230', // Hover cartes
                            border: '#2A3241',   // Bordures subtiles
                            primary: '#6366F1',  // Indigo vibrant (Boutons)
                            accent: '#A855F7',   // Violet (Gradients)
                            text: '#E2E8F0',     // Texte principal
                            muted: '#94A3B8'     // Texte secondaire
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #0B0E14; color: #E2E8F0; }
        
        /* --- UI Components Futuristes --- */
        .dashboard-card {
            background-color: #151A25;
            border: 1px solid #2A3241;
            border-radius: 1rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }
        .dashboard-card:hover {
            border-color: #374151;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }

        .glass-input {
            background: #0f1219;
            border: 1px solid #2A3241;
            color: white;
            transition: all 0.2s;
        }
        .glass-input:focus {
            border-color: #6366F1;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
            outline: none;
        }

        /* Bouton avec effet "Glow" */
        .btn-glow {
            background: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%);
            position: relative;
            overflow: hidden;
            border: none;
            color: white;
            transition: all 0.3s;
        }
        .btn-glow:hover {
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.4);
            transform: translateY(-1px);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid #2A3241;
            color: #94A3B8;
            transition: all 0.2s;
        }
        .btn-outline:hover {
            border-color: #6366F1;
            color: white;
            background: rgba(99, 102, 241, 0.05);
        }

        /* Graphique Barres */
        .bar-container { display: flex; align-items: flex-end; justify-content: space-between; height: 200px; gap: 2px; padding-top: 20px; }
        .bar-wrapper { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; height: 100%; position: relative; min-width: 3px; }
        .bar { width: 100%; border-radius: 4px 4px 0 0; transition: height 0.5s cubic-bezier(0.4, 0, 0.2, 1); min-height: 2px; position: relative; }
        
        /* Effet néon sur les barres */
        .real .bar { background: linear-gradient(to top, #059669, #34d399); box-shadow: 0 0 10px rgba(16, 185, 129, 0.2); } 
        .estimated .bar { background: linear-gradient(to top, #4f46e5, #818cf8); box-shadow: 0 0 10px rgba(99, 102, 241, 0.2); }

        .bar-wrapper:hover .bar { filter: brightness(1.3); z-index: 10; }
        .bar-wrapper:hover::after {
            content: attr(data-tooltip); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
            background: #1e293b; color: white; padding: 6px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 600;
            white-space: pre; z-index: 50; border: 1px solid #334155; pointer-events: none; margin-bottom: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }
        .bar-label { font-size: 0.6rem; color: #64748b; margin-top: 6px; text-align: center; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .bar-wrapper.dense:nth-child(odd) .bar-label { display: none; }
        @media (min-width: 768px) { .bar-wrapper.dense:nth-child(odd) .bar-label { display: block; } }

        /* Calendrier Heatmap */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
        .day-cell { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-radius: 8px; background-color: #1e293b; font-size: 0.75rem; position: relative; border: 1px solid transparent; transition: all 0.2s; }
        .day-cell.has-data:hover { transform: scale(1.15); z-index: 20; border-color: #6366f1; box-shadow: 0 0 15px rgba(99, 102, 241, 0.3); background-color: #1e293b; }
        
        .marker-dot { position: absolute; top: 4px; right: 4px; width: 5px; height: 5px; border-radius: 50%; box-shadow: 0 0 5px currentColor;}
        .bg-real { background-color: #10b981; color: #10b981; }

        /* Scrollbar moderne */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0B0E14; }
        ::-webkit-scrollbar-thumb { background: #2A3241; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #3B82F6; }

        /* Print & Mobile */
        @media print { .print-hidden { display: none !important; } body { background: white !important; color: black !important; } .dashboard-card { border: 1px solid #ccc !important; box-shadow: none !important; background: white !important; } }
        .hidden { display: none; }
    </style>
</head>
<body class="p-4 md:p-6 pb-24 min-h-screen">

    <div class="max-w-[1600px] mx-auto grid grid-cols-1 xl:grid-cols-[320px_1fr] gap-6">

        <!-- === SIDEBAR (CONTRÔLES) === -->
        <aside class="space-y-6">
            
            <!-- Header / Titre -->
            <div class="dashboard-card p-6 flex flex-col items-center text-center xl:items-start xl:text-left">
                <div class="flex items-center gap-3 mb-2">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center shadow-lg shadow-indigo-500/30">
                        <svg class="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold tracking-tight text-white">Gaz Tracker</h1>
                        <p class="text-xs text-gray-500 font-medium uppercase tracking-wider">Dashboard Hybride</p>
                    </div>
                </div>
                
                <!-- Légende -->
                <div class="mt-4 flex flex-wrap justify-center xl:justify-start gap-2 w-full">
                    <div class="px-2 py-1 rounded bg-emerald-500/10 border border-emerald-500/20 text-[10px] text-emerald-400 flex items-center">
                        <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 mr-1.5 shadow-[0_0_5px_currentColor]"></span> Réel (GRDF)
                    </div>
                    <div class="px-2 py-1 rounded bg-indigo-500/10 border border-indigo-500/20 text-[10px] text-indigo-400 flex items-center">
                        <span class="w-1.5 h-1.5 rounded-full bg-indigo-500 mr-1.5 shadow-[0_0_5px_currentColor]"></span> Estimé
                    </div>
                </div>
            </div>

            <!-- Actions Rapides -->
            <section class="dashboard-card p-6 print-hidden space-y-4">
                <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-2">Données</h3>
                
                <button onclick="document.getElementById('file-input').click()" class="btn-glow w-full py-3 rounded-xl flex items-center justify-center gap-2 text-sm font-semibold shadow-lg shadow-indigo-500/20">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                    Importer (GRDF/JSON)
                </button>
                <input type="file" id="file-input" class="hidden" accept=".csv,.json,.txt" onchange="handleImport(this)" multiple>

                <div class="grid grid-cols-2 gap-3">
                    <button onclick="exportData()" class="btn-outline py-2 rounded-lg text-xs font-medium flex flex-col items-center justify-center gap-1">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/></svg>
                        Sauvegarder
                    </button>
                    <button onclick="window.print()" class="btn-outline py-2 rounded-lg text-xs font-medium flex flex-col items-center justify-center gap-1">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/></svg>
                        Imprimer
                    </button>
                </div>
            </section>

            <!-- Saisie Manuelle (Desktop) -->
            <section class="dashboard-card p-6 print-hidden hidden lg:block">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest">Saisie Index</h3>
                    <div class="w-2 h-2 rounded-full bg-green-500 shadow-[0_0_5px_#22c55e]"></div>
                </div>
                <form onsubmit="addManualIndex(event, 'desktop')" class="space-y-4">
                    <div>
                        <label class="text-[10px] text-gray-400 uppercase font-bold mb-1 block ml-1">Date</label>
                        <input type="datetime-local" id="date-desktop" required class="glass-input text-sm rounded-lg w-full">
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-400 uppercase font-bold mb-1 block ml-1">Index (m³)</label>
                        <input type="number" id="index-desktop" step="0.001" required placeholder="Ex: 5488" class="glass-input text-sm font-mono w-full rounded-lg">
                    </div>
                    <button type="submit" class="btn-outline w-full py-2.5 rounded-lg text-sm hover:bg-indigo-500/10 hover:text-indigo-400 hover:border-indigo-500/50">Valider l'index</button>
                </form>
            </section>

            <!-- Paramètres -->
            <section class="dashboard-card print-hidden">
                <button onclick="document.getElementById('params-box').classList.toggle('hidden')" class="w-full p-4 flex justify-between items-center hover:bg-white/5 transition rounded-xl">
                    <span class="text-sm font-medium text-gray-300">⚙️ Paramètres Facture</span>
                    <svg class="w-4 h-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                </button>
                <div id="params-box" class="hidden px-4 pb-4 pt-2 border-t border-[#2A3241] space-y-3 bg-[#0B0E14]/50 rounded-b-xl">
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="text-[10px] uppercase text-gray-500 font-bold">Prix kWh HT</label><input id="p-kwh" type="number" step="0.0001" value="0.0777" onchange="recalc()" class="glass-input text-xs rounded p-1.5 w-full"></div>
                        <div><label class="text-[10px] uppercase text-gray-500 font-bold">Abo/Mois HT</label><input id="p-abo" type="number" step="0.01" value="16.72" onchange="recalc()" class="glass-input text-xs rounded p-1.5 w-full"></div>
                        <div><label class="text-[10px] uppercase text-gray-500 font-bold">TVA Conso %</label><input id="p-tva1" type="number" step="0.1" value="20" onchange="recalc()" class="glass-input text-xs rounded p-1.5 w-full"></div>
                        <div><label class="text-[10px] uppercase text-gray-500 font-bold">TVA Abo %</label><input id="p-tva2" type="number" step="0.1" value="5.5" onchange="recalc()" class="glass-input text-xs rounded p-1.5 w-full"></div>
                        <div class="col-span-2"><label class="text-[10px] uppercase text-gray-500 font-bold">Coef. Conv.</label><input id="p-coef" type="number" step="0.01" value="11.36" onchange="recalc()" class="glass-input text-xs rounded p-1.5 w-full"></div>
                    </div>
                </div>
            </section>
        </aside>

        <!-- === MAIN CONTENT (DROITE) === -->
        <main class="space-y-6">

            <!-- LIGNE 1: SYNTHÈSE -->
            <div class="dashboard-card p-6">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                    <h2 class="text-lg font-bold text-white">Synthèse <span class="text-gray-500 font-normal text-sm ml-2" id="synth-label">Global</span></h2>
                    
                    <!-- Filtres -->
                    <div class="flex bg-[#0B0E14] p-1 rounded-lg border border-[#2A3241]">
                        <button onclick="setSynth('global')" id="btn-sy-global" class="px-3 py-1.5 text-xs font-medium rounded-md text-white bg-[#2A3241]">Global</button>
                        <button onclick="setSynth('year')" id="btn-sy-year" class="px-3 py-1.5 text-xs font-medium rounded-md text-gray-400 hover:text-white">Année</button>
                        <button onclick="setSynth('month')" id="btn-sy-month" class="px-3 py-1.5 text-xs font-medium rounded-md text-gray-400 hover:text-white">Mois</button>
                        <button onclick="setSynth('custom')" id="btn-sy-custom" class="px-3 py-1.5 text-xs font-medium rounded-md text-gray-400 hover:text-white">Perso</button>
                    </div>
                </div>

                <!-- Contrôles Filtres -->
                <div id="synth-controls" class="mb-6 hidden p-3 bg-[#0B0E14]/50 rounded-lg border border-[#2A3241]">
                    <select id="synth-year-select" onchange="updateSynth()" class="glass-input text-sm w-full rounded p-2 hidden"></select>
                    <input type="month" id="synth-month-select" onchange="updateSynth()" class="glass-input text-sm w-full rounded p-2 hidden">
                    <div id="synth-custom-range" class="hidden flex gap-2">
                        <input type="date" id="synth-start" onchange="updateSynth()" class="glass-input text-sm w-full rounded p-2">
                        <input type="date" id="synth-end" onchange="updateSynth()" class="glass-input text-sm w-full rounded p-2">
                    </div>
                </div>

                <!-- KPIs -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- KPI 1 -->
                    <div class="bg-[#0B0E14] border border-[#2A3241] rounded-xl p-4 relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-3 opacity-10 text-blue-500"><svg class="w-12 h-12" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg></div>
                        <p class="text-xs font-bold text-gray-500 uppercase tracking-wider">Consommation</p>
                        <p class="text-2xl font-bold text-white mt-1" id="disp-kwh">0 <span class="text-sm font-normal text-gray-500">kWh</span></p>
                        <p class="text-xs text-blue-400 mt-1 font-mono" id="disp-m3">0 m³</p>
                    </div>
                    <!-- KPI 2 -->
                    <div class="bg-[#0B0E14] border border-[#2A3241] rounded-xl p-4 relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-3 opacity-10 text-emerald-500"><svg class="w-12 h-12" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div>
                        <p class="text-xs font-bold text-gray-500 uppercase tracking-wider">Coût TTC</p>
                        <p class="text-2xl font-bold text-emerald-400 mt-1" id="disp-cost">0 €</p>
                        <p class="text-xs text-gray-500 mt-1 font-mono" id="disp-cost-ht">HT: 0 €</p>
                    </div>
                    <!-- KPI 3 (Info) -->
                     <div class="bg-[#0B0E14] border border-[#2A3241] rounded-xl p-4 flex items-center justify-center text-center">
                        <p class="text-xs text-gray-400 italic">
                            "L'énergie la moins chère est celle qu'on ne consomme pas."
                        </p>
                    </div>
                </div>
            </div>

            <!-- LIGNE 2: GRAPHIQUE -->
            <section class="dashboard-card p-6">
                <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                    <h2 class="text-lg font-bold text-white flex items-center gap-2">
                        <span class="w-2 h-6 bg-indigo-500 rounded-full"></span>
                        <span id="chart-title">Évolution</span>
                    </h2>
                    <div class="flex gap-2">
                         <div class="flex bg-[#0B0E14] rounded-lg p-1 text-xs border border-[#2A3241]">
                            <button onclick="setChart('day')" id="btn-chart-day" class="px-3 py-1.5 rounded-md bg-indigo-600 text-white transition">Jour</button>
                            <button onclick="setChart('month')" id="btn-chart-month" class="px-3 py-1.5 rounded-md text-gray-400 hover:text-white transition">Mois</button>
                        </div>
                        <div class="flex bg-[#0B0E14] rounded-lg p-1 text-xs border border-[#2A3241]">
                            <button onclick="setView('cost')" id="btn-view-cost" class="px-3 py-1.5 rounded-md bg-emerald-600 text-white transition">€</button>
                            <button onclick="setView('kwh')" id="btn-view-kwh" class="px-3 py-1.5 rounded-md text-gray-400 hover:text-white transition">kWh</button>
                        </div>
                    </div>
                </div>
                <div id="chart-container" class="bar-container px-2 border-b border-[#2A3241]"></div>
                <div id="chart-empty" class="hidden h-48 flex items-center justify-center text-gray-500 text-sm italic">Aucune donnée</div>
            </section>

            <!-- LIGNE 3: CALENDRIER & HISTO -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- CALENDRIER -->
                <section class="dashboard-card p-6">
                    <div class="flex justify-between items-center mb-6">
                         <h2 class="text-lg font-bold text-white">Calendrier</h2>
                         <div class="flex items-center gap-2 bg-[#0B0E14] rounded-lg p-1 border border-[#2A3241]">
                            <button onclick="moveCal(-1)" class="p-2 hover:text-white text-gray-400"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg></button>
                            <span class="text-xs font-bold text-white w-24 text-center uppercase" id="cal-title">--</span>
                            <button onclick="moveCal(1)" class="p-2 hover:text-white text-gray-400"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></button>
                        </div>
                    </div>
                    <div class="calendar-grid mb-2 text-center text-[10px] text-gray-500 font-bold uppercase tracking-widest">
                        <div>Lun</div><div>Mar</div><div>Mer</div><div>Jeu</div><div>Ven</div><div>Sam</div><div>Dim</div>
                    </div>
                    <div id="cal-grid" class="calendar-grid gap-2"></div>
                </section>

                <!-- HISTORIQUE -->
                <section class="dashboard-card p-6 flex flex-col h-[400px]">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold text-white">Relevés d'Index</h2>
                         <button onclick="resetAll()" class="text-[10px] text-red-500/70 hover:text-red-400 uppercase tracking-wider font-bold border border-red-900/30 px-2 py-1 rounded hover:bg-red-900/20 transition">Reset All</button>
                    </div>
                    <div class="overflow-y-auto flex-1 -mx-4 px-4 custom-scrollbar">
                        <table class="w-full text-left text-xs text-gray-400">
                            <thead class="text-[10px] uppercase bg-[#0B0E14] text-gray-500 sticky top-0 z-10">
                                <tr>
                                    <th class="px-4 py-3 font-bold rounded-l-lg">Date</th>
                                    <th class="px-4 py-3 text-right font-bold">Index</th>
                                    <th class="px-4 py-3 text-right font-bold">Coût Période</th>
                                    <th class="px-2 py-3 text-center font-bold rounded-r-lg"></th>
                                </tr>
                            </thead>
                            <tbody id="hist-body" class="divide-y divide-[#2A3241]"></tbody>
                        </table>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- MODALES (HIDDEN) -->
    <div id="mob-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-50 hidden flex items-center justify-center p-6">
        <div class="dashboard-card w-full max-w-sm p-8 shadow-2xl border border-[#2A3241]">
            <h2 class="text-xl font-bold text-white mb-6">Ajouter Index</h2>
            <form onsubmit="addManualIndex(event, 'mobile')" class="space-y-5">
                <input type="datetime-local" id="date-mobile" required class="glass-input w-full p-3 rounded-lg text-sm">
                <input type="number" id="index-mobile" step="0.001" required placeholder="Index" class="glass-input w-full p-3 rounded-lg text-sm font-mono">
                <div class="flex gap-3 mt-6">
                    <button type="button" onclick="document.getElementById('mob-modal').classList.add('hidden')" class="flex-1 btn-outline py-3 rounded-lg text-sm">Annuler</button>
                    <button type="submit" class="flex-1 btn-neon-primary py-3 rounded-lg text-sm">Sauvegarder</button>
                </div>
            </form>
        </div>
    </div>

    <!-- FAB MOBILE -->
    <button onclick="openMob()" class="fab lg:hidden"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg></button>

    <!-- LOGIQUE JS (COPIE EXACTE VERSION FONCTIONNELLE) -->
    <script>
        const APP = {
            db: { indexes: [], realDays: {}, computedDays: {}, monthly: {} },
            ui: { view: 'cost', chartMode: 'day', synthMode: 'global', synthFilter: {}, calDate: new Date() },
            limits: { maxD: 1, maxM: 1 }
        };

        document.addEventListener('DOMContentLoaded', () => { initInputs(); loadDB(); recalc(); });

        function initInputs() {
            const now = new Date(); now.setMinutes(now.getMinutes()-now.getTimezoneOffset()); const iso = now.toISOString().slice(0,16);
            if(document.getElementById('date-desktop')) document.getElementById('date-desktop').value = iso;
            if(document.getElementById('date-mobile')) document.getElementById('date-mobile').value = iso;
            const y = new Date().getFullYear(), m = new Date().toISOString().slice(0,7);
            APP.ui.synthFilter = { year: y, month: m, start: `${y}-01-01`, end: new Date().toISOString().slice(0,10) };
        }

        function loadDB() { try { const s = localStorage.getItem('gaz_db_final_v6'); if(s) { const d = JSON.parse(s); APP.db.indexes = d.indexes||[]; APP.db.realDays = d.realDays||{}; } } catch(e) {} }
        function saveDB() { localStorage.setItem('gaz_db_final_v6', JSON.stringify({ indexes: APP.db.indexes, realDays: APP.db.realDays })); }

        function handleImport(input) {
            const f = input.files[0]; if(!f) return;
            const r = new FileReader();
            r.onload = (e) => {
                const txt = e.target.result; let cR=0, cI=0;
                try {
                    if(f.name.endsWith('.json')||txt.trim().startsWith('{')) {
                        const j = JSON.parse(txt); if(j.indexes) APP.db.indexes=j.indexes; if(j.realDays) APP.db.realDays=j.realDays; alert("Restauré !");
                    } else {
                        const lines = txt.split(/\r?\n/);
                        let headIdx=0, type='unknown';
                        for(let i=0; i<Math.min(20, lines.length); i++) {
                            const l = lines[i].toLowerCase();
                            if(l.includes('date') && l.includes('consommation')) { headIdx=i; type='daily'; break; }
                            if(l.includes('date') && l.includes('index')) { headIdx=i; type='index'; break; }
                        }
                        if(type==='unknown') throw new Error("Format inconnu");
                        for(let i=headIdx+1; i<lines.length; i++) {
                            const cl = lines[i].replace(/"/g,'').trim(); if(!cl || !/\d/.test(cl)) continue;
                            let p = cl.split(';'); if(p.length<2) p=cl.split(','); if(p.length<2) continue;
                            let dk = null; const dRaw = p[0].trim();
                            if(dRaw.match(/^\d{2}\/\d{2}\/\d{4}$/)) { const[d,m,y]=dRaw.split('/'); dk=`${y}-${m}-${d}`; }
                            else if(dRaw.match(/^\d{4}-\d{2}-\d{2}/)) { dk=dRaw.split(' ')[0]; }
                            if(!dk) continue;
                            if(type==='daily') {
                                let v = p[1]; if(isNaN(parseFloat(v.replace(',','.'))) && p[2]) v=p[2];
                                const m3 = parseFloat(v.replace(',','.'));
                                let cf = 11.2; if(p[2] && !isNaN(parseFloat(p[2].replace(',','.')))) cf=parseFloat(p[2].replace(',','.'));
                                else if(p[3] && !isNaN(parseFloat(p[3].replace(',','.')))) cf=parseFloat(p[3].replace(',','.'));
                                if(!isNaN(m3)) { APP.db.realDays[dk] = { m3, kwh: m3*cf }; cR++; }
                            } else {
                                let v = p[1]; if(isNaN(parseFloat(v.replace(',','.'))) && p[2]) v=p[2];
                                const idx = parseFloat(v.replace(',','.'));
                                if(!isNaN(idx) && idx>10) {
                                    if(!APP.db.indexes.some(x=>x.date.startsWith(dk))) { APP.db.indexes.push({id:Date.now()+Math.random(), date:dk+"T12:00", index: idx}); cI++; }
                                }
                            }
                        }
                        alert(`Importé: ${cR} jours réels, ${cI} index.`);
                    }
                    saveDB(); recalc();
                } catch(err) { alert("Erreur: "+err.message); }
                input.value = '';
            };
            r.readAsText(f);
        }

        function exportData() {
            const b = new Blob([JSON.stringify({indexes: APP.db.indexes, realDays: APP.db.realDays})], {type:'application/json'});
            const u = URL.createObjectURL(b);
            const a = document.createElement('a'); a.href=u; a.download=`gaz_backup_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }

        function recalc() {
            const P = getParams();
            APP.db.computedDays = {}; APP.db.monthly = {}; APP.limits.maxD = 0; APP.limits.maxM = 0;

            // 1. Real
            for(const [k,v] of Object.entries(APP.db.realDays)) {
                const costHT = v.kwh * P.kwh;
                const costTTC = (costHT*(1+P.tva1)) + ((P.abo*12/365)*(1+P.tva2));
                APP.db.computedDays[k] = { ...v, cost: costTTC, type: 'real' };
            }

            // 2. Index
            APP.db.indexes.sort((a,b) => new Date(a.date) - new Date(b.date));
            for(let i=1; i<APP.db.indexes.length; i++) {
                const p = APP.db.indexes[i-1], c = APP.db.indexes[i];
                const d1 = new Date(p.date), d2 = new Date(c.date);
                const days = Math.ceil((d2-d1)/(86400000));
                const deltaM3 = c.index - p.index;
                if(deltaM3 >= 0) {
                    const kwhP = deltaM3 * P.coef;
                    c.costPeriod = (kwhP * P.kwh * (1+P.tva1)) + (P.abo * (days/30.5) * (1+P.tva2));
                } else continue;
                if(days<=0) continue;
                const totKwh = deltaM3 * P.coef;
                let realKwh = 0, missing = [];
                for(let j=0; j<days; j++) {
                    const d = new Date(d1); d.setDate(d.getDate()+j);
                    const k = d.toISOString().slice(0,10);
                    if(APP.db.computedDays[k] && APP.db.computedDays[k].type==='real') realKwh += APP.db.computedDays[k].kwh;
                    else missing.push(k);
                }
                if(missing.length > 0) {
                    const remKwh = Math.max(0, totKwh - realKwh);
                    const estDay = remKwh / missing.length;
                    const estM3 = (deltaM3 - (realKwh/P.coef)) / missing.length;
                    const costDay = (estDay * P.kwh * (1+P.tva1)) + ((P.abo*12/365)*(1+P.tva2));
                    missing.forEach(k => { if(!APP.db.computedDays[k]) APP.db.computedDays[k] = { kwh: estDay, m3: Math.max(0,estM3), cost: costDay, type: 'estimated' }; });
                }
            }

            // 3. Agg
            for(const [k,v] of Object.entries(APP.db.computedDays)) {
                const m = k.slice(0,7);
                if(!APP.db.monthly[m]) APP.db.monthly[m] = { kwh:0, cost:0, m3:0 };
                APP.db.monthly[m].kwh += v.kwh; APP.db.monthly[m].cost += v.cost; APP.db.monthly[m].m3 += v.m3;
                const val = APP.ui.view==='kwh'?v.kwh:v.cost;
                if(val>APP.limits.maxD) APP.limits.maxD = val;
            }
            for(const v of Object.values(APP.db.monthly)) {
                const val = APP.ui.view==='kwh'?v.kwh:v.cost;
                if(val>APP.limits.maxM) APP.limits.maxM = val;
            }
            renderAll();
        }

        function renderAll() { renderSynth(); renderChart(); renderCal(); renderHist(); }

        function renderSynth() {
            const mode = APP.ui.synthMode;
            const f = document.getElementById('synth-controls');
            const ys = document.getElementById('synth-year-select');
            const ms = document.getElementById('synth-month-select');
            const cs = document.getElementById('synth-custom-range');
            const lLabel = document.getElementById('synth-label');

            ['global','year','month','custom'].forEach(m => {
                const b = document.getElementById('btn-sy-'+m);
                if(m===mode) { b.classList.remove('bg-[#2A3241]','text-gray-400'); b.classList.add('bg-indigo-600','text-white'); } 
                else { b.classList.add('bg-[#2A3241]','text-gray-400'); b.classList.remove('bg-indigo-600','text-white'); }
            });

            f.classList.add('hidden'); ys.classList.add('hidden'); ms.classList.add('hidden'); cs.classList.add('hidden');
            if(mode !== 'global') f.classList.remove('hidden');

            let start=null, end=null, label="Global";
            const allKeys = Object.keys(APP.db.computedDays).sort();

            if(mode==='year') {
                ys.classList.remove('hidden');
                const years = [...new Set(allKeys.map(k=>k.slice(0,4)))].sort().reverse();
                if(years.length===0) years.push(new Date().getFullYear());
                if(ys.options.length !== years.length) { ys.innerHTML=''; years.forEach(y=>ys.add(new Option(y,y))); }
                if(!years.includes(APP.ui.synthFilter.year.toString())) APP.ui.synthFilter.year = years[0];
                ys.value = APP.ui.synthFilter.year;
                start=new Date(ys.value,0,1); end=new Date(ys.value,11,31); label=`Année ${ys.value}`;
            } 
            else if(mode==='month') {
                ms.classList.remove('hidden');
                ms.value = APP.ui.synthFilter.month;
                const [y,m] = ms.value.split('-');
                start=new Date(y,m-1,1); end=new Date(y,m,0); label=new Date(y,m-1,1).toLocaleDateString('fr-FR',{month:'long', year:'numeric'});
            }
            else if(mode==='custom') {
                cs.classList.remove('hidden');
                document.getElementById('synth-start').value = APP.ui.synthFilter.start;
                document.getElementById('synth-end').value = APP.ui.synthFilter.end;
                start=new Date(APP.ui.synthFilter.start); end=new Date(APP.ui.synthFilter.end);
                label=`Personnalisé`;
            }

            let tk=0, tc=0, tm=0;
            allKeys.forEach(k => {
                const d = new Date(k);
                if(start && d<start) return;
                if(end && d>end) return;
                const v = APP.db.computedDays[k];
                tk+=v.kwh; tc+=v.cost; tm+=v.m3;
            });

            document.getElementById('disp-m3').innerText = tm.toLocaleString('fr-FR',{maximumFractionDigits:1});
            document.getElementById('disp-kwh').innerText = Math.round(tk).toLocaleString()+' kWh';
            document.getElementById('disp-cost').innerText = tc.toLocaleString('fr-FR',{style:'currency',currency:'EUR'});
            document.getElementById('disp-cost-ht').innerText = 'HT: ' + (tc/1.2).toLocaleString('fr-FR',{style:'currency',currency:'EUR'});
            lLabel.innerText = label;
        }

        function updateSynth() {
            APP.ui.synthFilter.year = document.getElementById('synth-year-select').value;
            APP.ui.synthFilter.month = document.getElementById('synth-month-select').value;
            APP.ui.synthFilter.start = document.getElementById('synth-start').value;
            APP.ui.synthFilter.end = document.getElementById('synth-end').value;
            renderSynth();
        }
        function setSynth(m) { APP.ui.synthMode = m; renderSynth(); }

        function renderChart() {
            const c = document.getElementById('chart-container'); c.innerHTML='';
            const isDay = APP.ui.chartMode === 'day';
            const btnDay = document.getElementById('btn-chart-day'); const btnMonth = document.getElementById('btn-chart-month');
            if(isDay) { btnDay.classList.add('bg-indigo-600','text-white'); btnMonth.classList.remove('bg-indigo-600','text-white'); btnMonth.classList.add('text-gray-400'); btnDay.classList.remove('text-gray-400'); } 
            else { btnMonth.classList.add('bg-indigo-600','text-white'); btnDay.classList.remove('bg-indigo-600','text-white'); btnDay.classList.add('text-gray-400'); btnMonth.classList.remove('text-gray-400'); }
            const btnCost = document.getElementById('btn-view-cost'); const btnKwh = document.getElementById('btn-view-kwh');
            if(APP.ui.view==='cost') { btnCost.classList.add('bg-emerald-600','text-white'); btnKwh.classList.remove('bg-emerald-600','text-white'); btnKwh.classList.add('text-gray-400'); btnCost.classList.remove('text-gray-400'); }
            else { btnKwh.classList.add('bg-emerald-600','text-white'); btnCost.classList.remove('bg-emerald-600','text-white'); btnCost.classList.add('text-gray-400'); btnKwh.classList.remove('text-gray-400'); }

            let data={}, max=0, keys=[];
            
            if(isDay) {
                const y = APP.ui.calDate.getFullYear(), m = APP.ui.calDate.getMonth();
                const dim = new Date(y,m+1,0).getDate();
                document.getElementById('chart-title').innerText = "Évolution " + new Date(y,m,1).toLocaleDateString('fr-FR',{month:'long', year:'numeric'});
                max = APP.limits.maxD;
                for(let d=1; d<=dim; d++) {
                    const k = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    const v = APP.db.computedDays[k];
                    data[k] = { label:d, val: v ? (APP.ui.view==='kwh'?v.kwh:v.cost) : 0, type: v?.type };
                    keys.push(k);
                }
                keys.sort(); 
            } else {
                document.getElementById('chart-title').innerText = "Évolution Annuelle";
                max = APP.limits.maxM;
                keys = Object.keys(APP.db.monthly).sort();
                keys.forEach(k => {
                    const v = APP.db.monthly[k];
                    const [yy,mm] = k.split('-');
                    data[k] = { label: `${mm}/${yy.slice(2)}`, val: APP.ui.view==='kwh'?v.kwh:v.cost, type: 'mixed' };
                });
            }

            if(keys.length===0 || max===0) { document.getElementById('chart-empty').classList.remove('hidden'); return; }
            document.getElementById('chart-empty').classList.add('hidden');

            keys.forEach(k => {
                const item = data[k];
                const pct = (item.val/max)*100;
                const el = document.createElement('div');
                el.className = `bar-wrapper ${item.type||'estimated'} ${keys.length>30?'dense':''}`;
                el.setAttribute('data-tooltip', `${item.label}: ${item.val.toLocaleString('fr-FR',{maximumFractionDigits:1})} ${APP.ui.view==='cost'?'€':'kWh'}`);
                el.innerHTML = `<div class="bar" style="height:${Math.max(4, pct)}%"></div><div class="bar-label">${item.label}</div>`;
                c.appendChild(el);
            });
        }

        function renderCal() {
            const g = document.getElementById('cal-grid'); g.innerHTML='';
            const y = APP.ui.calDate.getFullYear(), m = APP.ui.calDate.getMonth();
            document.getElementById('cal-title').innerText = new Date(y,m,1).toLocaleDateString('fr-FR',{month:'long', year:'numeric'});
            const fd = new Date(y,m,1).getDay()||7, dim = new Date(y,m+1,0).getDate();
            for(let i=1; i<fd; i++) g.appendChild(document.createElement('div'));
            for(let d=1; d<=dim; d++) {
                const k = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const v = APP.db.computedDays[k];
                const c = document.createElement('div'); c.className = "day-cell";
                if(v) {
                    c.classList.add('has-data');
                    const val = APP.ui.view==='kwh'?v.kwh:v.cost;
                    const r = APP.limits.maxD>0 ? val/APP.limits.maxD : 0;
                    let bg = 'rgba(255,255,255,0.05)';
                    if(val>0) { if(r<0.25) bg='rgba(6, 78, 59, 0.6)'; else if(r<0.5) bg='rgba(113, 63, 18, 0.6)'; else if(r<0.75) bg='rgba(124, 45, 18, 0.6)'; else bg='rgba(127, 29, 29, 0.6)'; }
                    c.style.backgroundColor = bg;
                    if(v.type==='real') c.innerHTML += `<div class="marker-dot bg-real"></div>`;
                    c.innerHTML += `<span class="font-bold text-white z-10">${d}</span><div class="z-10 day-val text-gray-200 font-mono">${Math.round(val)}</div>`;
                    const b = document.createElement('div'); b.className="intensity-bar";
                    const f = document.createElement('div'); f.className="intensity-fill"; 
                    f.style.width=`${r*100}%`; f.style.background = r>0.5?'#fcd34d':'#34d399';
                    b.appendChild(f); c.appendChild(b);
                    c.title = `${k}\n${v.type==='real'?'Réel':'Estimé'}\n${val.toFixed(2)}`;
                } else { c.innerHTML = `<span class="text-gray-600">${d}</span>`; }
                g.appendChild(c);
            }
        }

        function renderHist() {
            const b = document.getElementById('hist-body'); b.innerHTML='';
            [...APP.db.indexes].reverse().forEach(r => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-white/5 transition";
                const d = new Date(r.date).toLocaleDateString('fr-FR', {day: '2-digit', month: '2-digit', year: '2-digit'});
                const cost = r.costPeriod ? `<span class="text-emerald-400 font-bold">${r.costPeriod.toFixed(2)} €</span>` : '<span class="text-gray-600">-</span>';
                tr.innerHTML = `<td class="px-4 py-3 text-gray-300 font-medium">${d}</td><td class="px-4 py-3 text-right font-mono text-white">${r.index}</td><td class="px-4 py-3 text-right">${cost}</td><td class="px-2 py-3 text-center"><button onclick="delIndex(${r.id})" class="p-1 text-red-400 hover:text-red-300 hover:bg-red-400/10 rounded">×</button></td>`;
                b.appendChild(tr);
            });
        }

        function addManualIndex(e, m) {
            e.preventDefault(); const s = m==='mobile'?'-mobile':'-desktop';
            const d = document.getElementById('date'+s).value;
            const v = parseFloat(document.getElementById('index'+s).value);
            if(!d || isNaN(v)) return;
            if(APP.db.indexes.some(x=>x.date===d)) return alert("Date existe");
            APP.db.indexes.push({ id: Date.now(), date: d, index: v });
            saveDB(); recalc();
            document.getElementById('index'+s).value='';
            if(m==='mobile') document.getElementById('mob-modal').classList.add('hidden');
        }
        function delIndex(id) { if(confirm("Supprimer ?")) { APP.db.indexes = APP.db.indexes.filter(x=>x.id!==id); saveDB(); recalc(); } }
        function resetAll() { if(confirm("ATTENTION : TOUT SUPPRIMER ? Cette action est irréversible.")) { localStorage.removeItem('gaz_db_final_v6'); APP.db.indexes=[]; APP.db.realDays={}; recalc(); } }
        function moveCal(d) { APP.ui.calDate.setMonth(APP.ui.calDate.getMonth()+d); renderCal(); if(APP.ui.chartMode==='day') renderChart(); }
        function setView(v) { APP.ui.view=v; renderChart(); renderCal(); }
        function setChart(m) { APP.ui.chartMode=m; renderChart(); }
        function openMob() { initInputs(); document.getElementById('mob-modal').classList.remove('hidden'); }
        function getParams() { return { kwh: parseFloat(document.getElementById('p-kwh').value)||0.0777, abo: parseFloat(document.getElementById('p-abo').value)||16.72, coef: parseFloat(document.getElementById('p-coef').value)||11.36, tva1: (parseFloat(document.getElementById('p-tva1').value)||20)/100, tva2: (parseFloat(document.getElementById('p-tva2').value)||5.5)/100 }; }
    </script>
</body>
</html>
